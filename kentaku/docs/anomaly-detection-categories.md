# 業者見積データベース 異常値検出カテゴリ定義書

**更新日**: 2026-01-04
**バージョン**: 1.0.0

---

## 概要

### 目的

建設業者見積データの品質管理と統計分析の精度向上を目的とした異常値検出システムの定義。
全 15 カテゴリを処理方針別に 3 つの大カテゴリに分類し、データの信頼性確保とビジネス価値創出を両立する。

### 分類方針

| 大カテゴリ      | 処理方針             | 影響範囲 | 主な目的           |
| --------------- | -------------------- | -------- | ------------------ |
| **A. 即座除外** | 統計分析から自動除外 | 3-8%     | データ品質保証     |
| **B. 要確認**   | 人間の判断を要求     | 15-25%   | 業務プロセス最適化 |
| **C. 分析活用** | 可視化・分析対象     | 全データ | インサイト創出     |

### データセット概要

- **総レコード数**: 64,661 件
- **分析期間**: 2023 年〜2024 年
- **プロジェクト数**: 566 件
- **地域数**: 52 地域
- **業者数**: 約 600 社

---

## 統計的基礎理論

### 1. 中央値（標準単価）

**定義**: 本システムでは標準単価として中央値を採用

**数式**:

$$
\text{Median} = \begin{cases}
x_{\frac{n+1}{2}} & \text{(n が奇数)} \\
\frac{x_{\frac{n}{2}} + x_{\frac{n}{2}+1}}{2} & \text{(n が偶数)}
\end{cases}
$$

**採用理由**: 外れ値の影響を受けにくく、建設見積の歪んだ分布に適している

---

### 2. IQR 法による外れ値検出

**四分位範囲（IQR）**:

$$
\text{IQR} = Q_3 - Q_1
$$

**外れ値検出の閾値**:

$$
\begin{aligned}
\text{極端な外れ値（A: 即座除外）} &: Q_3 + 3.0 \times \text{IQR} \text{ 超} \\
\text{通常の外れ値（B: 要確認）} &: Q_3 + 1.5 \times \text{IQR} \text{ 超}
\end{aligned}
$$

**適用カテゴリ**: A-1（極端な単価異常）、A-2（数量異常）、B-1（総額外れ値）

---

### 3. 変動係数（CV）

**数式**:

$$
\text{CV} = \frac{\sigma}{\bar{x}} \times 100\%
$$

**判定基準**:

| CV 値  | 評価           | カテゴリ            |
| ------ | -------------- | ------------------- |
| > 300% | 極端な散らばり | C-4（CV 異常）      |
| > 100% | 散らばり大     | B-4（単価バラツキ） |
| < 100% | 正常範囲       | データ品質良好      |

**適用カテゴリ**: B-4（同一項目の単価バラツキ）、C-4（CV 異常）

---

### 4. 標準単価からの乖離率

**数式**:

$$
\text{乖離率} = \frac{|x - \text{median}(x)|}{\text{median}(x)} \times 100\%
$$

**判定基準**:

| 乖離率          | 分類           | カテゴリ      |
| --------------- | -------------- | ------------- |
| > 1000% (10 倍) | 極端な外れ値   | A-6: 即座除外 |
| 50-1000%        | 中程度の外れ値 | B-6: 要確認   |
| < 50%           | 正常範囲       | 正常          |

**適用カテゴリ**: A-6（標準単価から極端な乖離）、B-6（標準単価から中程度乖離）

---

### 5. 採用手法のまとめ

本システムでは以下の統計手法を採用：

1. **IQR 法（主要）**: 外れ値検出の基本手法
2. **中央値**: 標準単価の算出
3. **変動係数（CV）**: 項目別の価格バラツキ評価
4. **乖離率**: 個別単価の妥当性判定

**採用理由**: 外れ値への耐性が高く、建設見積の歪んだ分布に適している

---

## 大カテゴリ A: 即座除外 (AUTO_EXCLUDE)

### 方針

明らかなデータ破損・入力ミスを自動検出し、統計分析から除外する。
エラーログに記録し、月次で修正依頼を行う。

### 影響範囲

全体の **3-8%** を自動除外（推定 1,900-5,200 件）

---

### A-1. 極端な単価異常

#### 条件

```javascript
price < -5, 066 || price >= 1, 000, 000;
```

#### 根拠

- **統計データ**:

  - Q1: 368 円、Q3: 3,991 円、IQR: 3,623 円
  - IQR 下限外れ値: -5,066 円
  - IQR 上限外れ値: 9,425 円
  - 最大値: 6,184,240 円（明らかな異常）

- **異常パターン**:
  - 単価 618 万円（総額を単価欄に入力）
  - 単価-10,000 円（負の単価は極めて稀）

- **実例**: 工事注文書削除金額（式）6,184,240 円 - 中央値 100,000 円の 61.8 倍

#### 解説

**リスク**:

- 桁数の誤入力（円 ↔ 千円）
- 単価と総額の列の取り違え
- 統計指標（平均、中央値）の大幅な歪み

**除外理由**:

- 100 万円超の単価は建設資材として非現実的
- 負の単価は業務上ありえない（値引きは別項目）

---

### A-2. 数量の異常値（極端）

#### 条件

```javascript
qty < -100 || (qty > 10, 000 && unit !== "式");
```

#### 根拠

- **統計データ**:

  - Q1: 3、Q3: 115.2、IQR: 112.2
  - IQR 上限外れ値: 283.5
  - 最大値: 13,935.5
  - 負の数量: 3,407 件（うち環境協力金などは正常）

- **異常パターン**:
  - qty = 13,935.5（ｍ ²）→ 集計値の誤入力
  - qty = -50（環境協力金以外）→ 符号ミス

- **実例**: パネル加工費（ｍ²）数量 13,935.5 - 中央値 110.2 の 126 倍、集計値の誤入力と推定

#### 解説

**リスク**:

- 単位の取り違え（ｍ ² ↔ 式）
- 複数物件の集計値を誤入力
- 総数量と単価の混同

**除外理由**:

- 戸建て・集合住宅で 1 万超の数量は物理的にありえない
- 負の数量（環境協力金以外）は業務ロジックに反する

---

### A-3. 階数と面積の不整合

#### 条件

```javascript
(floors === 2 && constArea < 100) || (floors === 2 && constArea > 951);
```

#### 根拠

- **統計データ**:

  - 建築面積 Q1: 345.1㎡、Q3: 587.76㎡、IQR: 242.66㎡
  - IQR 上限外れ値: 951㎡
  - 2 階建てが主流（中央値=2、Q1=2、Q3=2）

- **異常パターン**:
  - 2 階建て、建築面積 50㎡ → データ欠損
  - 2 階建て、建築面積 1,200㎡ → 階数の誤入力

- **実例**: 2 階建て集合住宅で建築面積 41.38㎡（最小値）- 通常の集合住宅としては極端に小さい

#### 解説

**リスク**:

- 階数フィールドの入力ミス（2 ↔ 3）
- 面積の単位ミス（㎡ ↔ 坪）
- プロジェクトマスタの参照エラー

**除外理由**:

- 2 階建て 100㎡ 未満は集合住宅として非現実的
- 951㎡ 超は統計的外れ値（特殊案件の可能性大）

---

### A-4. 同一プロジェクト内の基本情報不整合

#### 条件

```javascript
// 同一projectNameで以下が複数値を持つ
uniqueValues(constArea).length > 1 ||
  uniqueValues(floors).length > 1 ||
  uniqueValues(region).length > 1;
```

#### 根拠

- **統計データ**:

  - 全 566 プロジェクト中 120 件（21.2%）に不整合

- **異常パターン例**:
  - 「４３８様集合住宅新築工事」: constArea = 535.6㎡ と 600.03㎡
  - 「４１８様集合住宅新築工事」: constArea = 595.74㎡ と 480.02㎡

- **実例**: 「４３８様集合住宅新築工事」福岡、同一プロジェクト内で建築面積が 535.6㎡と 600.03㎡の 2 値存在

#### 解説

**リスク**:

- プロジェクトの誤紐付け（別物件の混入）
- 変更履歴の未反映（設計変更後も旧データが残存）
- データ入力時のマスタ参照不統一

**除外理由**:

- 同一プロジェクトで基本情報が変動するのは論理矛盾
- 統計分析で物件単位の集計が不可能

---

### A-5. 単位と数量の論理的矛盾

#### 条件

```javascript
(unit === "式" && qty > 100 && qty > 0) ||
  (unit === "枚" && qty % 1 !== 0 && decimalPlaces(qty) >= 2) ||
  (unit === "ｍ２" && qty > constArea * 20);
```

#### 根拠

- **統計データ**:

  - 「式」の最大値: 7,000 式（異常）
  - 「式」の中央値: -1（環境協力金の影響）
  - 「枚」で小数点: 392.9 枚
  - 「ｍ２」の最大値: 11,881.4㎡

- **異常パターン**:
  - 「式」7,000 式 → 単位選択ミス
  - 「枚」392.9 枚 → 枚数は整数が自然
  - 「ｍ２」11,881.4㎡ → 建築面積の 20 倍超

- **実例**: ラワン合板（枚）392.9 枚 - 枚数は整数であるべきだが小数点、単位または数量の入力ミス

#### 解説

**リスク**:

- 単位プルダウンの選択ミス
- 数量の桁数誤り（小数点の位置）
- 集計値を個別レコードとして入力

**除外理由**:

- 「式」は通常 1 式（複数式は論理矛盾）
- 「枚」は整数単位（小数は単位ミスの可能性）
- 建築面積の 20 倍超の ㎡ 数は物理的に不可能

---

### A-6. 標準単価からの極端な乖離

#### 条件

```javascript
abs(price - medianPrice) / medianPrice > 10.0; // 1000%超
```

#### 根拠

- **統計データ（パネル加工費の例）**:

  - 標準単価（中央値）: 1,562 円
  - 最大乖離: +12,933%（203,570 円）
  - 78%が 30%以上乖離（データ品質の課題）

- **異常パターン**:
  - パネル加工費 203,570 円（中央値の 130 倍）
  - 造作大工手間 2,070,209 円（中央値 3,500 円の 591 倍）

- **実例**: パネル加工費（ｍ²）203,570 円、株式会社ユニックス、いわき - 標準単価 1,562 円の 130 倍、総額との混同と推定

#### 解説

**リスク**:

- 単価と総額の欄の取り違え
- 桁数の誤入力（カンマの位置ミス）
- 単位の取り違え（㎡ 単価 ↔ 式単価）

**除外理由**:

- 10 倍以上の乖離は入力ミスの可能性が極めて高い
- 統計的外れ値として平均値を大きく歪める

---

## 大カテゴリ B: 要確認 (NEEDS_REVIEW)

### 方針

異常だが正当な可能性がある項目。警告フラグ付きで一覧化し、担当者が個別判断する。
承認ワークフローを経て、正常/異常を確定する。

### 影響範囲

全体の **15-25%** に警告表示（推定 9,700-16,200 件）

---

### B-1. 総額の外れ値

#### 条件

```javascript
amount > 5, 000, 000; // 500万円超
```

#### 根拠

- **統計データ**:

  - Q3: 92,803 円
  - IQR 上限外れ値: 219,274 円
  - 最大値: 9,584,640 円

- **実例**:
  - 高額案件は実在（特注階段、大規模フレーミング等）
  - 500 万円超は全体の約 5-8%

- **具体例**: パネル加工費（ｍ²）総額 9,584,640 円 - 大規模物件のため妥当な可能性、要確認

#### 解説

**確認ポイント**:

- 仕様が特殊か（カスタム品、高品質材）
- 数量が多いか（大規模物件）
- 単価 × 数量の計算は正しいか

**承認フロー**:

1. 担当者が発注書・見積書を確認
2. 正当性のコメント入力（例: 「3 階建て大規模物件のため妥当」）
3. 承認 → 正常データ / 却下 → 修正依頼

---

### B-2. 面積の整合性異常

#### 条件

```javascript
totalArea / constArea < 0.924 ||
  totalArea / constArea > 0.977 ||
  totalArea > constArea * 1.1 ||
  constArea > totalArea * 1.3;
```

#### 根拠

- **統計データ**:
  - 延床/建築比率 Q1: 0.944、Q3: 0.957
  - 最小値: 0.754、最大値: 1.177
  - 2 階建てが大半のため、比率は 0.9-1.0 が妥当

- **実例**: ある 2 階建て物件で延床面積/建築面積比率 0.754 - 吹き抜けまたはピロティの可能性、要確認

#### 解説

**確認ポイント**:

- 特殊構造か（吹き抜け、ピロティ形式）
- データ入力ミスか（建築面積と延床面積の逆転）
- 設計変更の反映漏れか

**承認基準**:

- 比率 1.1 倍超 → 3 階建て等の特殊構造を確認
- 比率 0.8 未満 → データ入力ミスの可能性大

---

### B-3. 負の値レコード異常

#### 条件

```javascript
qty < 0 && item !== "環境協力金";
```

#### 根拠

- **統計データ**:
  - 負の数量: 3,407 件
  - うち「環境協力金」が大半（正常）
  - その他の負の値: 約 500 件（要確認）

- **実例**: 環境協力金（式）-20 個、総額 -30,000 円、山下建設 - リベートのため正常

#### 解説

**確認ポイント**:

- 返品・キャンセルか
- 値引き・リベートか
- 単純な符号ミスか

**正当性の判断**:

- ✅ 「環境協力金」「割引」「返品」 → 正常
- ❌ 通常の資材・工事で負の値 → 異常

---

### B-4. 同一項目の単価バラツキ異常

#### 条件

```javascript
// 同一(item + spec + unit)で
CV > 100; // 変動係数100倍超
```

#### 根拠

- **統計データ（上位 5 項目）**:
  - 工事注文書削除金額: CV = 618,424 倍
  - 造作用下地材: CV = 35,349 倍
  - 造作大工手間 ２ × ４ ３Ｆ建: CV = 26,885 倍

- **実例**: 工事注文書削除金額（式）10 円～6,184,240 円 - 仕様不明確でバラツキ極大、項目定義の見直し必要

#### 解説

**確認ポイント**:

- 仕様（spec）が異なるのに同一項目として登録されているか
- 単位の取り違えか（円 ↔ 千円）
- 地域差・業者差が極端か

**対策**:

- 仕様の詳細化（spec フィールドの活用）
- 項目マスタの見直し

---

### B-5. 地域間価格の外れ値

#### 条件

```javascript
// 同一項目で
price > regionalMedian * 1.5 || price < regionalMedian * 0.5;
```

#### 根拠

- **統計データ（地域別平均単価）**:
  - 最高: 佐賀 28,928 円
  - 最低: 秋田 3,865 円
  - 差: 7.5 倍

- **実例**: 佐賀地域の平均単価 28,928 円が秋田 3,865 円の 7.5 倍 - 輸送費・地域特性または地域コード誤入力の可能性

#### 解説

**確認ポイント**:

- 輸送費が含まれているか
- 地域コードの入力ミスか
- 地域特性（離島、豪雪地域等）か

**活用方法**:

- 地域別ベンチマークの作成
- 適正価格範囲の提示

---

### B-6. 標準単価からの中程度乖離

#### 条件

```javascript
abs(price - medianPrice) / medianPrice > 0.5 &&
  abs(price - medianPrice) / medianPrice <= 10.0;
// 50%-1000%の乖離
```

#### 根拠

- **統計データ（パネル加工費の例）**:
  - 30%以上乖離: 78%
  - 50%以上乖離: 推定 50-60%

- **実例**: パネル加工費（ｍ²）55,000 円、ヒノキブン株式会社、四日市 - 標準単価 1,562 円から 3,421%乖離、特注仕様の可能性

#### 解説

**確認ポイント**:

- 特注仕様か
- 業者独自の価格設定か
- 発注時期の市況変動か

**承認基準**:

- 50-100%乖離 → コメント入力で承認可
- 100-1000%乖離 → 詳細確認必須

---

### B-7. 業者間価格差の異常

#### 条件

```javascript
// 同一項目で
vendorMedian > globalMedian * 2.0;
```

#### 根拠

- **統計データ**:
  - 環境協力金: 590 業者、範囲 2 円～ 20,000 円
  - 造作大工手間: 503 業者、CV = 276%

- **実例**: 環境協力金（式）2 円～20,000 円で 10,000 倍差 - 業者による価格設定の差異が極端

#### 解説

**確認ポイント**:

- 専門業者による高付加価値サービスか
- 独占供給による価格設定か
- 業者評価が適切か

**活用方法**:

- 業者別の価格競争力スコアリング
- コスト削減ポテンシャルの算出

---

### B-8. 地域別標準単価からの乖離

#### 条件

```javascript
// 同一項目・同一地域で
price > regionalMedian * 1.8 || price < regionalMedian * 0.5;
```

#### 根拠

- **分析方法**:
  1. 項目 × 地域ごとに中央値を算出
  2. 個別レコードと地域中央値を比較
  3. 乖離率が閾値超えを検出

- **実例**: いわき地域でパネル加工費 203,570 円 - 同地域の標準単価から大幅乖離、地域コード確認必要

#### 解説

**確認ポイント**:

- 地域コードの入力ミスか
- 輸送費の過大計上か
- 地域特性（都市部 vs 地方）か

**対策**:

- 地域別の適正価格範囲を提示
- 入力時のリアルタイム警告

---

### B-9. 時系列での単価変動異常

#### 条件

```javascript
// 同一項目・業者で
abs(currentPrice - previousPrice) / previousPrice > 1.0 && daysDiff <= 90; // 3ヶ月以内に2倍以上変動
```

#### 根拠

- **業務知識**:
  - 建設資材価格は緩やかに変動
  - 急激な変動（3 ヶ月で 2 倍）は異常

- **実例**: 2023 年 5 月から 2024 年データで急激な価格変動は未検出、データ期間が 1 年のため今後監視が必要

#### 解説

**確認ポイント**:

- 資材高騰（ウッドショック等）か
- 仕様変更の未反映か
- 前回単価の参照ミスか

**活用方法**:

- 価格トレンド分析
- インフレ影響の可視化

---

## 大カテゴリ C: 分析活用 (FOR_ANALYSIS)

### 方針

データとして有効。統計分析・BI ツールで可視化し、ビジネスインサイトを創出する。
フィルタ・ソート機能で柔軟に探索可能。

### 影響範囲

**全データを保持**（除外なし）

---

### C-1. 数量の異常値（軽微）

#### 条件

```javascript
qty > 283.5 && qty <= 10, 000; // IQR範囲外だが現実的
```

#### 根拠

- **統計データ**:
  - IQR 上限外れ値: 283.5
  - 最大値: 13,935.5

#### 活用方法

**分析観点**:

- 大量発注案件の特定
- 規模の経済性の分析
- 発注パターンの可視化

**ダッシュボード**:

- 数量分布ヒストグラム
- 大量発注ランキング

---

### C-2. 総額の外れ値（中程度）

#### 条件

```javascript
amount > 219274 && amount <= 5000000;
// IQR上限超〜500万円
```

#### 根拠

- **統計データ**:
  - IQR 上限外れ値: 219,274 円
  - 高額ラインを 500 万円として設定

#### 活用方法

**分析観点**:

- 高額案件の傾向分析
- プロジェクト規模との相関
- コスト構造の可視化

**レポート**:

- 月次高額案件レポート
- 地域別・業者別の高額案件シェア

---

### C-3. 同一項目の単価バラツキ（分析用）

#### 条件

```javascript
CV > 100; // 変動係数100倍超
```

#### 活用方法

**分析観点**:

- 標準化が必要な項目の特定
- 仕様の詳細化が必要な項目のリストアップ
- 価格交渉の余地がある項目の可視化

**アクション**:

- 仕様標準化プロジェクトの優先順位付け
- 項目マスタの改善

---

### C-4. 変動係数（CV）異常

#### 条件

```javascript
// 項目レベルで
CV > 3.0; // 300%
```

#### 根拠

- **統計データ**:
  - CV 上位 10 項目すべて 477%超
  - 最高: 造作大工手間 ２ × ４ ３Ｆ建（CV = 804%）

#### 活用方法

**分析観点**:

- 目標単価設定が困難な項目の可視化
- データ品質改善のターゲット設定
- 仕様標準化の ROI 算出

**ダッシュボード**:

- CV 上位項目ランキング
- 仕様標準化による価格安定化シミュレーション

---

### C-5. 業者間価格差（分析用）

#### 条件

```javascript
// 同一項目で業者別価格を比較
vendorCount >= 10; // 競争が激しい項目
```

#### 根拠

- **統計データ**:
  - 環境協力金: 590 業者
  - 造作大工手間 ２ × ４: 503 業者

#### 活用方法

**分析観点**:

- 業者評価スコアリング
- コスト削減ポテンシャルの算出
- 価格競争力マップの作成

**ダッシュボード**:

- 業者別価格ランキング
- コスト削減シミュレーター（標準単価適用時の差額）

---

### C-6. 地域別標準単価分析

#### 条件

```javascript
// 地域別に標準単価を算出
regionalMedian; // 地域中央値
```

#### 活用方法

**分析観点**:

- 地域別ベンチマーク作成
- 地域戦略の最適化（出店計画等）
- 地域別コスト効率性の評価

**ダッシュボード**:

- 地域別単価ヒートマップ
- 地域間価格差ランキング

---

### C-7. 時系列での単価変動（分析用）

#### 条件

```javascript
// 月次での単価推移を分析
monthlyPriceTrend;
```

#### 活用方法

**分析観点**:

- 資材価格トレンド分析
- インフレ影響の可視化
- 発注タイミングの最適化

**ダッシュボード**:

- 主要項目の価格推移グラフ
- 前年同月比較レポート

---

## 実装ガイドライン

### データベーススキーマ拡張

```sql
ALTER TABLE records ADD COLUMN anomaly_category VARCHAR(50);
ALTER TABLE records ADD COLUMN anomaly_flag BOOLEAN DEFAULT FALSE;
ALTER TABLE records ADD COLUMN excluded BOOLEAN DEFAULT FALSE;
ALTER TABLE records ADD COLUMN review_status VARCHAR(20); -- 'pending', 'approved', 'rejected'
ALTER TABLE records ADD COLUMN review_comment TEXT;
ALTER TABLE records ADD COLUMN reviewed_at TIMESTAMP;
ALTER TABLE records ADD COLUMN reviewed_by VARCHAR(100);
```

### カテゴリ値の定義

```javascript
const ANOMALY_CATEGORIES = {
  // A: AUTO_EXCLUDE
  A1_EXTREME_PRICE: "極端な単価異常",
  A2_EXTREME_QTY: "数量の異常値（極端）",
  A3_FLOOR_AREA_MISMATCH: "階数と面積の不整合",
  A4_PROJECT_INCONSISTENCY: "プロジェクト不整合",
  A5_UNIT_QTY_CONTRADICTION: "単位と数量の矛盾",
  A6_EXTREME_PRICE_DEVIATION: "標準単価から極端な乖離",

  // B: NEEDS_REVIEW
  B1_AMOUNT_OUTLIER: "総額の外れ値",
  B2_AREA_RATIO_ANOMALY: "面積整合性異常",
  B3_NEGATIVE_VALUE: "負の値レコード",
  B4_PRICE_VARIANCE: "同一項目の単価バラツキ",
  B5_REGIONAL_PRICE_OUTLIER: "地域間価格外れ値",
  B6_MODERATE_PRICE_DEVIATION: "標準単価から中程度乖離",
  B7_VENDOR_PRICE_GAP: "業者間価格差",
  B8_REGIONAL_DEVIATION: "地域別標準単価乖離",
  B9_TEMPORAL_PRICE_CHANGE: "時系列単価変動",

  // C: FOR_ANALYSIS
  C1_QTY_OUTLIER_MINOR: "数量外れ値（軽微）",
  C2_AMOUNT_OUTLIER_MODERATE: "総額外れ値（中程度）",
  C3_PRICE_VARIANCE_ANALYSIS: "単価バラツキ（分析用）",
  C4_CV_ANOMALY: "CV異常",
  C5_VENDOR_PRICE_ANALYSIS: "業者間価格差（分析用）",
  C6_REGIONAL_ANALYSIS: "地域別標準単価",
  C7_TEMPORAL_ANALYSIS: "時系列変動（分析用）",
};
```

### 検出関数の実装例

```javascript
/**
 * A-1: 極端な単価異常を検出
 */
function detectExtremePriceAnomaly(record) {
  if (record.price < -5066 || record.price >= 1000000) {
    return {
      category: "A1_EXTREME_PRICE",
      excluded: true,
      reason: `単価${record.price}円は範囲外（-5,066円未満 or 1,000,000円以上）`,
    };
  }
  return null;
}

/**
 * B-6: 標準単価からの中程度乖離を検出
 */
function detectModeratePriceDeviation(record, standardPrices) {
  const key = `${record.item}|${record.spec}|${record.unit}`;
  const std = standardPrices[key];

  if (!std || record.price <= 0) return null;

  const deviation = Math.abs(record.price - std.median) / std.median;

  if (deviation > 0.5 && deviation <= 10.0) {
    return {
      category: "B6_MODERATE_PRICE_DEVIATION",
      anomaly_flag: true,
      review_status: "pending",
      reason: `標準単価${std.median}円から${Math.round(deviation * 100)}%乖離`,
    };
  }
  return null;
}
```

### 集計クエリの実装例

```sql
-- A: AUTO_EXCLUDE を除外した統計
SELECT
  item,
  unit,
  COUNT(*) as count,
  ROUND(AVG(price), 2) as avg_price,
  ROUND(MEDIAN(price), 2) as median_price
FROM records
WHERE excluded = FALSE
  AND price > 0
GROUP BY item, unit
ORDER BY count DESC;

-- B: NEEDS_REVIEW の一覧
SELECT
  region,
  projectName,
  item,
  price,
  anomaly_category,
  review_status,
  review_comment
FROM records
WHERE anomaly_flag = TRUE
  AND review_status = 'pending'
ORDER BY price DESC
LIMIT 100;

-- C: FOR_ANALYSIS での集計
SELECT
  region,
  COUNT(*) as total_records,
  ROUND(AVG(price), 2) as avg_price,
  COUNT(CASE WHEN anomaly_flag = TRUE THEN 1 END) as anomaly_count,
  ROUND(COUNT(CASE WHEN anomaly_flag = TRUE THEN 1 END) * 100.0 / COUNT(*), 2) as anomaly_rate
FROM records
WHERE excluded = FALSE
GROUP BY region
ORDER BY anomaly_rate DESC;
```

### UI での表示例

```javascript
// レコード一覧での表示
const getAnomalyBadge = (record) => {
  if (record.excluded) {
    return '<span class="badge bg-danger">除外</span>';
  }
  if (record.review_status === "pending") {
    return '<span class="badge bg-warning">要確認</span>';
  }
  if (record.anomaly_flag) {
    return '<span class="badge bg-info">分析対象</span>';
  }
  return '<span class="badge bg-success">正常</span>';
};

// フィルタ機能
const filterOptions = {
  all: "全て表示",
  normal: "正常データのみ",
  exclude_removed: "除外データを除く",
  anomaly_only: "異常データのみ",
  review_pending: "要確認のみ",
};
```

---

## 付録

### 統計的検出アルゴリズム

#### IQR 法（四分位範囲法）

```javascript
function calculateIQROutliers(values) {
  const sorted = values.sort((a, b) => a - b);
  const q1 = sorted[Math.floor(sorted.length * 0.25)];
  const q3 = sorted[Math.floor(sorted.length * 0.75)];
  const iqr = q3 - q1;

  return {
    lowerFence: q1 - 1.5 * iqr,
    upperFence: q3 + 1.5 * iqr,
    extremeLowerFence: q1 - 3 * iqr,
    extremeUpperFence: q3 + 3 * iqr,
  };
}
```

#### 変動係数（CV）の計算

```javascript
function calculateCV(values) {
  const mean = values.reduce((a, b) => a + b, 0) / values.length;
  const variance =
    values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) /
    values.length;
  const std = Math.sqrt(variance);

  return std / mean;
}
```

---

**文書管理**

| 項目         | 内容       |
| ------------ | ---------- |
| 作成日       | 2026-01-04 |
| 最終更新     | 2026-01-04 |
| バージョン   | 1.0.0      |
| 承認者       | -          |
| 次回レビュー | 2026-04-01 |

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>業者見積データベース</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <nav
      class="navbar navbar-dark bg-dark px-3"
      style="height: var(--header-height)"
    >
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <svg
          class="icon-lg"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
          />
          <polyline points="7.5 4.21 12 6.81 16.5 4.21" />
          <polyline points="7.5 19.79 7.5 14.6 3 12" />
          <polyline points="21 12 16.5 14.6 16.5 19.79" />
          <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
          <line x1="12" y1="22.08" x2="12" y2="12" />
        </svg>
        <span class="fw-bold">業者見積データベース</span>
      </a>
    </nav>

    <div class="d-flex flex-column flex-lg-row" x-data="appData()" x-cloak>
      <aside class="sidebar d-flex flex-column bg-white">
        <div class="p-3 border-bottom">
          <h6
            class="mb-0 fw-bold text-secondary d-flex align-items-center gap-1"
          >
            <svg
              class="icon"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            検索条件
          </h6>
        </div>
        <div class="p-3 flex-grow-1" @keydown.enter="applyFilters()">
          <div class="section-title">工事情報</div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >工事名称</label
            >
            <div class="position-relative">
              <input
                type="text"
                class="form-control form-control-sm"
                placeholder="選択または入力"
                x-model="filters.project"
                @focus="autocomplete.show = true; filterProjectNames()"
                @input="filterProjectNames()"
                @blur="setTimeout(() => autocomplete.show = false, 150)"
                @keydown.arrow-down.prevent="moveAutocompleteDown()"
                @keydown.arrow-up.prevent="moveAutocompleteUp()"
                @keydown.enter.prevent="selectAutocomplete()"
                @keydown.escape="autocomplete.show = false"
                autocomplete="off"
              />
              <div
                class="autocomplete-dropdown"
                x-show="autocomplete.show && autocomplete.items.length > 0"
                @click="selectProject($event)"
              >
                <template x-for="(item, idx) in autocomplete.items" :key="item">
                  <div
                    class="autocomplete-item"
                    :class="{ 'active': idx === autocomplete.activeIndex }"
                    :data-value="item"
                    x-text="item"
                  ></div>
                </template>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >支店名</label
            >
            <select class="form-select form-select-sm" x-model="filters.region">
              <option value="">すべて</option>
              <option>厚木</option>
              <option>横浜</option>
              <option>高崎</option>
              <option>春日部</option>
              <option>つくば</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >大工事項目コード</label
            >
            <div class="d-flex flex-wrap gap-2">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  value="026"
                  id="code026"
                  x-model="filters.majorCodes"
                /><label class="form-check-label small" for="code026"
                  >026</label
                >
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >発注日</label
            >
            <div class="input-group input-group-sm">
              <input type="date" class="form-control" x-model="filters.dateFrom" />
              <span class="input-group-text">~</span>
              <input type="date" class="form-control" x-model="filters.dateTo" />
            </div>
          </div>

          <div class="section-title mt-3">建物情報</div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >地上階数</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="3"
                x-model.number="filters.floorMin"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="3"
                min="1"
                max="3"
                x-model.number="filters.floorMax"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >戸並び</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="55"
                x-model.number="filters.unitRowMin"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="55"
                min="1"
                max="55"
                x-model.number="filters.unitRowMax"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >居住用戸数</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="12"
                x-model.number="filters.resUnitMin"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="12"
                min="1"
                max="12"
                x-model.number="filters.resUnitMax"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >施工面積 (㎡)</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="50"
                x-model.number="filters.constAreaMin"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="1000"
                x-model.number="filters.constAreaMax"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >延床面積 (㎡)</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="50"
                x-model.number="filters.totalAreaMin"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="1000"
                x-model.number="filters.totalAreaMax"
              />
            </div>
          </div>

          <div class="section-title mt-3">見積情報</div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary">品目</label>
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="キーワード検索"
              x-model="filters.item"
            />
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >業者名</label
            >
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="業者名"
              x-model="filters.vendor"
            />
          </div>
        </div>
        <div class="p-3 border-top bg-light">
          <div class="d-grid gap-2">
            <button class="btn btn-primary" @click="applyFilters()">
              検索実行
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              @click="clearFilters()"
            >
              条件クリア
            </button>
          </div>
        </div>
      </aside>

      <main class="main-content p-4">
        <div class="mb-4">
          <h4 class="fw-bold mb-3">検索結果一覧</h4>
          <div class="d-flex gap-2 align-items-center flex-wrap mb-3">
            <template x-if="activeFiltersDisplay.length > 0">
              <small class="text-muted me-2">適用中:</small>
            </template>
            <template x-for="filter in activeFiltersDisplay" :key="filter">
              <span class="badge filter-badge bg-secondary" x-text="filter"></span>
            </template>
            <template x-if="activeFiltersDisplay.length === 0">
              <small class="text-muted">絞り込み条件なし（全品目表示）</small>
            </template>
          </div>
        </div>

        <div>
          <template x-if="filteredGroups.length === 0">
            <div class="text-center py-5">
              <svg
                width="64"
                height="64"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                viewBox="0 0 24 24"
                class="text-muted mb-3"
              >
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
              </svg>
              <p class="text-muted">検索条件に該当する品目がありません</p>
              <button class="btn btn-sm btn-outline-primary" @click="clearFilters()">
                条件をクリア
              </button>
            </div>
          </template>

          <div class="results-grid">
            <template x-for="(group, idx) in filteredGroups" :key="idx">
              <div
                class="card item-group-card shadow-sm"
                :class="{ 'expanded': expandedGroups[idx] }"
              >
                <div class="card-body" @click="toggleGroup(idx)">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <h5 class="fw-bold mb-2" x-text="group.item"></h5>
                      <div class="tag-cloud">
                        <span class="badge bg-secondary" x-text="group.unit"></span>
                        <span class="badge bg-info" x-text="group.filteredRecords.length + '件'"></span>
                      </div>
                    </div>
                    <div class="text-end">
                      <small class="text-muted d-block mb-1">実行単価レンジ</small>
                      <div class="fw-bold text-primary fs-5 tabular-nums" x-text="`¥${fmt(group.minPrice)} ~ ¥${fmt(group.maxPrice)}`"></div>
                    </div>
                  </div>

                  <div class="summary-stats mb-3">
                    <div class="summary-section">
                      <div class="summary-section-title">
                        <svg
                          width="14"
                          height="14"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          viewBox="0 0 24 24"
                        >
                          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                          <circle cx="9" cy="7" r="4" />
                        </svg>
                        業者別 実行単価レンジ（/<span x-text="group.unit"></span>）
                      </div>
                      <div class="company-summary-list">
                        <template x-for="vendor in getVendorSummary(group.filteredRecords)" :key="vendor.name">
                          <div class="company-summary-item">
                            <div class="company-header">
                              <span class="company-name" x-text="vendor.name"></span>
                              <span class="company-count" x-text="vendor.count + '件'"></span>
                            </div>
                            <div class="company-prices">
                              <div class="company-price-item">
                                <span class="company-price-label">最小</span>
                                <span class="company-price-value min" x-text="`¥${fmt(vendor.min)}`"></span>
                              </div>
                              <div class="company-price-item">
                                <span class="company-price-label">平均</span>
                                <span class="company-price-value avg" x-text="`¥${fmt(vendor.avg)}`"></span>
                              </div>
                              <div class="company-price-item">
                                <span class="company-price-label">最大</span>
                                <span class="company-price-value max" x-text="`¥${fmt(vendor.max)}`"></span>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>

                  <div class="d-flex justify-content-center gap-3 align-items-center flex-wrap">
                    <small class="text-muted">
                      <svg
                        width="16"
                        height="16"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                        style="vertical-align: -3px"
                      >
                        <polyline points="6 9 12 15 18 9" />
                      </svg>
                      クリックして実績詳細を表示
                    </small>
                    <button
                      class="btn btn-sm btn-outline-primary"
                      @click.stop="showChart(idx)"
                    >
                      <svg
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                        style="vertical-align: -2px"
                      >
                        <line x1="18" y1="20" x2="18" y2="10" />
                        <line x1="12" y1="20" x2="12" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="14" />
                      </svg>
                      実行単価チャート
                    </button>
                  </div>
                </div>

                <div
                  class="border-top"
                  x-show="expandedGroups[idx]"
                  x-transition:enter="transition-collapse"
                  x-transition:enter-start="collapse-hidden"
                  x-transition:enter-end="collapse-shown"
                  x-transition:leave="transition-collapse"
                  x-transition:leave-start="collapse-shown"
                  x-transition:leave-end="collapse-hidden"
                >
                  <div class="card-body bg-light">
                    <h6 class="fw-bold text-secondary mb-3">
                      <svg
                        width="16"
                        height="16"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                        style="vertical-align: -2px"
                      >
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                      </svg>
                      見積詳細（発注日の時系列）
                    </h6>
                    <div class="timeline-container">
                      <template x-for="record in group.filteredRecords" :key="record.orderDate + record.item + record.vendor">
                        <div class="timeline-item">
                          <div class="timeline-date">
                            <span class="year" x-text="record.orderMonth.split('-')[0]"></span>
                            <span class="month" x-text="parseInt(record.orderMonth.split('-')[1]) + '月'"></span>
                          </div>
                          <div class="timeline-dot"></div>
                          <div class="timeline-content">
                            <div class="project-header">
                              <div class="flex-grow-1">
                                <div class="project-badges">
                                  <span class="badge bg-info" x-text="record.region"></span>
                                  <span class="badge bg-secondary" x-text="record.majorCode"></span>
                                  <span class="badge bg-light text-dark" x-text="record.floors + '階'"></span>
                                  <span class="badge bg-light text-dark" x-text="record.unitRow + '戸並'"></span>
                                  <span class="badge bg-light text-dark" x-text="record.resUnits + '戸'"></span>
                                </div>
                                <div class="project-name" x-text="record.projectName"></div>
                              </div>
                              <div class="price-display">
                                <div class="price-main tabular-nums" x-text="`¥${fmt(record.price)}`"></div>
                                <div class="price-sub" x-text="`/${record.unit}`"></div>
                              </div>
                            </div>
                            <div class="detail-grid">
                              <div class="detail-item">
                                <div class="detail-label">業者</div>
                                <div class="detail-value" x-text="record.vendor"></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">数量</div>
                                <div class="detail-value tabular-nums" x-text="`${fmt(record.qty)} ${record.unit}`"></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">施工面積</div>
                                <div class="detail-value tabular-nums" x-text="`${fmt(record.constArea)} ㎡`"></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">延床面積</div>
                                <div class="detail-value tabular-nums" x-text="`${fmt(record.totalArea)} ㎡`"></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">金額</div>
                                <div class="detail-value tabular-nums highlight" x-text="`¥${fmt(record.amount)}`"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                    <div
                      class="text-center mt-3 pt-3 border-top"
                      @click.stop="toggleGroup(idx)"
                      style="cursor: pointer"
                    >
                      <small class="text-muted">
                        <svg
                          width="16"
                          height="16"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          viewBox="0 0 24 24"
                          style="vertical-align: -3px"
                        >
                          <polyline points="18 15 12 9 6 15" />
                        </svg>
                        クリックして閉じる
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Chart Modal (inside x-data scope) -->
        <div class="modal fade" id="chartModal" tabindex="-1" x-ref="chartModal">
          <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title fw-bold" x-text="chartData.title">
                  実行単価実績チャート
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                ></button>
              </div>
              <div class="modal-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <div class="card bg-light border-0">
                      <div class="card-body py-2">
                        <small class="text-muted">品目</small>
                        <div class="fw-bold" x-text="chartData.item">-</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card bg-light border-0">
                      <div class="card-body py-2">
                        <small class="text-muted">単位</small>
                        <div class="fw-bold" x-text="chartData.unit">-</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div
                  class="chart-scroll-container"
                  style="overflow-x: auto; overflow-y: hidden; padding-bottom: 10px"
                >
                  <div style="height: 400px; position: relative" x-ref="chartWrapper">
                    <canvas x-ref="netPriceChart"></canvas>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>発注日</th>
                          <th>工事名称</th>
                          <th>業者</th>
                          <th class="text-end">実行単価</th>
                        </tr>
                      </thead>
                      <tbody>
                        <template x-for="record in chartData.records" :key="record.orderDate + record.vendor">
                          <tr>
                            <td x-text="record.orderDateFormatted"></td>
                            <td x-text="record.projectName"></td>
                            <td x-text="record.vendor"></td>
                            <td class="text-end tabular-nums" x-text="`¥${fmt(record.price)}`"></td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  閉じる
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

    <!-- Application Scripts (load order matters) -->
    <script src="js/utils.js"></script>
    <script src="js/data.js"></script>
    <script src="js/app.js"></script>

    <!-- Alpine.js (must be loaded after app scripts) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.3/dist/cdn.min.js"></script>
  </body>
</html>

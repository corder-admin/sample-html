<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>単価ダッシュボード</title>

    <!-- DNS prefetch and preconnect for faster CDN loading -->
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />

    <!-- Critical CSS: x-cloak to prevent FOUC -->
    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>

    <!-- Bootstrap CSS with preload for non-blocking -->
    <link
      rel="preload"
      as="style"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/css/bootstrap.min.css"
      integrity="sha256-2FMn2Zx6PuH5tdBQDRNwrOo60ts5wWPC9R8jK67b3t4="
      crossorigin="anonymous"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/css/bootstrap.min.css"
        integrity="sha256-2FMn2Zx6PuH5tdBQDRNwrOo60ts5wWPC9R8jK67b3t4="
        crossorigin="anonymous"
      />
    </noscript>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bg-body-secondary">
    <nav
      class="navbar navbar-dark bg-dark px-2 px-md-3"
      style="height: var(--header-height)"
    >
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center gap-2" href="#">
          <svg
            class="icon-lg d-none d-sm-block"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
            />
            <polyline points="7.5 4.21 12 6.81 16.5 4.21" />
            <polyline points="7.5 19.79 7.5 14.6 3 12" />
            <polyline points="21 12 16.5 14.6 16.5 19.79" />
            <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
            <line x1="12" y1="22.08" x2="12" y2="12" />
          </svg>
          <span class="fw-bold fs-6 fs-md-5">単価ダッシュボード</span>
        </a>
        <!-- モバイル用検索トグルボタン -->
        <button
          class="btn btn-outline-light btn-sm d-lg-none"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#searchSidebar"
          aria-controls="searchSidebar"
          x-show="!isLoading && !loadError"
        >
          <svg
            class="icon"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          <span class="ms-1 d-none d-sm-inline">検索</span>
        </button>
      </div>
    </nav>

    <div class="d-flex flex-column flex-lg-row" x-data="appData()" x-cloak>
      <!-- ローディングオーバーレイ -->
      <template x-if="isLoading">
        <div
          class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white"
          style="z-index: 9999"
        >
          <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mb-0">データを読み込み中...</p>
          </div>
        </div>
      </template>

      <!-- エラー表示 -->
      <template x-if="!isLoading && loadError">
        <div class="container py-5">
          <div class="alert alert-danger" role="alert">
            <h5 class="alert-heading">読み込みエラー</h5>
            <p class="mb-0" x-text="loadError"></p>
          </div>
        </div>
      </template>

      <!-- デスクトップ用サイドバー (lg以上) -->
      <aside
        class="sidebar d-none d-lg-flex flex-column bg-white"
        x-show="!isLoading && !loadError"
      >
        <div class="p-3 border-bottom">
          <h6
            class="mb-0 fw-bold text-secondary d-flex align-items-center gap-1"
          >
            <svg
              class="icon"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            検索条件
          </h6>
        </div>
        <div class="p-3 flex-grow-1" @keydown.enter="applyFilters()">
          <div class="section-title">工事情報</div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >工事名称</label
            >
            <div class="position-relative">
              <input
                type="text"
                class="form-control form-control-sm"
                placeholder="選択または入力"
                x-model="filters.project"
                @focus="autocomplete.show = true; filterProjectNames()"
                @input="filterProjectNames()"
                @blur="setTimeout(() => { autocomplete.show = false; applyFilters(); }, 150)"
                @keydown.arrow-down.prevent="moveAutocompleteDown()"
                @keydown.arrow-up.prevent="moveAutocompleteUp()"
                @keydown.enter.prevent="selectAutocomplete(); applyFilters()"
                @keydown.escape="autocomplete.show = false"
                autocomplete="off"
              />
              <div
                class="autocomplete-dropdown"
                x-show="autocomplete.show && autocomplete.items.length > 0"
                @click="selectProject($event); applyFilters()"
              >
                <template x-for="(item, idx) in autocomplete.items" :key="item">
                  <div
                    class="autocomplete-item"
                    :class="{ 'active': idx === autocomplete.activeIndex }"
                    :data-value="item"
                    x-text="item"
                  ></div>
                </template>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >支店名</label
            >
            <div class="position-relative">
              <button
                type="button"
                class="form-select form-select-sm text-start"
                @click="toggleRegionDropdown()"
                @click.away="regionDropdownOpen = false"
              >
                <span x-text="selectedRegionsText"></span>
              </button>
              <div
                class="dropdown-menu w-100 p-2"
                :class="{ 'show': regionDropdownOpen }"
                @click.stop
              >
                <div class="dropdown-scroll">
                  <template x-for="region in regionNames" :key="region">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        :id="'region-' + region"
                        :checked="isRegionSelected(region)"
                        @change="toggleRegion(region)"
                      />
                      <label
                        class="form-check-label small"
                        :for="'region-' + region"
                        x-text="region"
                      ></label>
                    </div>
                  </template>
                </div>
                <div class="border-top pt-2 mt-2">
                  <button
                    type="button"
                    class="btn btn-primary btn-sm w-100"
                    @click="confirmRegionSelection()"
                  >
                    決定
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >大工事項目コード</label
            >
            <div class="d-flex flex-wrap gap-2">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  value="026"
                  id="code026"
                  x-model="filters.majorCodes"
                  @change="applyFilters()"
                /><label class="form-check-label small" for="code026"
                  >026</label
                >
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >発注日</label
            >
            <div class="input-group input-group-sm">
              <input
                type="date"
                class="form-control"
                x-model="filters.dateFrom"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="date"
                class="form-control"
                x-model="filters.dateTo"
                @change="applyFilters()"
              />
            </div>
          </div>

          <div class="section-title mt-3">項目情報</div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >小工事項目名称</label
            >
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="キーワード検索"
              x-model="filters.item"
              @input="applyFilters()"
            />
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >業者名</label
            >
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="業者名"
              x-model="filters.vendor"
              @input="applyFilters()"
            />
          </div>

          <div class="section-title mt-3">建物情報</div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >地上階数</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="3"
                x-model.number="filters.floorMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="3"
                min="1"
                max="3"
                x-model.number="filters.floorMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >戸並び</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="55"
                x-model.number="filters.unitRowMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="55"
                min="1"
                max="55"
                x-model.number="filters.unitRowMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >居住用戸数</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="12"
                x-model.number="filters.resUnitMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="12"
                min="1"
                max="12"
                x-model.number="filters.resUnitMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >施工面積 (㎡)</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="50"
                x-model.number="filters.constAreaMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="1000"
                x-model.number="filters.constAreaMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >延床面積 (㎡)</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="50"
                x-model.number="filters.totalAreaMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="1000"
                x-model.number="filters.totalAreaMax"
                @change="applyFilters()"
              />
            </div>
          </div>
        </div>
        <div class="p-3 border-top bg-light">
          <div class="d-grid gap-2">
            <button class="btn btn-primary" @click="applyFilters()">
              検索実行
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              @click="clearFilters()"
            >
              条件クリア
            </button>
          </div>
        </div>
      </aside>

      <!-- モバイル用オフキャンバスサイドバー (lg未満) -->
      <div
        class="offcanvas offcanvas-start d-lg-none"
        tabindex="-1"
        id="searchSidebar"
        aria-labelledby="searchSidebarLabel"
        x-show="!isLoading && !loadError"
      >
        <div class="offcanvas-header border-bottom">
          <h5 class="offcanvas-title fw-bold text-secondary d-flex align-items-center gap-2" id="searchSidebarLabel">
            <svg
              class="icon"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            検索条件
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="閉じる"
          ></button>
        </div>
        <div class="offcanvas-body p-3" @keydown.enter="applyFilters()">
          <div class="section-title">工事情報</div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >工事名称</label
            >
            <div class="position-relative">
              <input
                type="text"
                class="form-control form-control-sm"
                placeholder="選択または入力"
                x-model="filters.project"
                @focus="autocomplete.show = true; filterProjectNames()"
                @input="filterProjectNames()"
                @blur="setTimeout(() => { autocomplete.show = false; applyFilters(); }, 150)"
                @keydown.arrow-down.prevent="moveAutocompleteDown()"
                @keydown.arrow-up.prevent="moveAutocompleteUp()"
                @keydown.enter.prevent="selectAutocomplete(); applyFilters()"
                @keydown.escape="autocomplete.show = false"
                autocomplete="off"
              />
              <div
                class="autocomplete-dropdown"
                x-show="autocomplete.show && autocomplete.items.length > 0"
                @click="selectProject($event); applyFilters()"
              >
                <template x-for="(item, idx) in autocomplete.items" :key="item">
                  <div
                    class="autocomplete-item"
                    :class="{ 'active': idx === autocomplete.activeIndex }"
                    :data-value="item"
                    x-text="item"
                  ></div>
                </template>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >支店名</label
            >
            <div class="position-relative">
              <button
                type="button"
                class="form-select form-select-sm text-start"
                @click="toggleRegionDropdown()"
                @click.away="regionDropdownOpen = false"
              >
                <span x-text="selectedRegionsText"></span>
              </button>
              <div
                class="dropdown-menu w-100 p-2"
                :class="{ 'show': regionDropdownOpen }"
                @click.stop
              >
                <div class="dropdown-scroll">
                  <template x-for="region in regionNames" :key="region">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        :id="'region-mobile-' + region"
                        :checked="isRegionSelected(region)"
                        @change="toggleRegion(region)"
                      />
                      <label
                        class="form-check-label small"
                        :for="'region-mobile-' + region"
                        x-text="region"
                      ></label>
                    </div>
                  </template>
                </div>
                <div class="border-top pt-2 mt-2">
                  <button
                    type="button"
                    class="btn btn-primary btn-sm w-100"
                    @click="confirmRegionSelection()"
                  >
                    決定
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >大工事項目コード</label
            >
            <div class="d-flex flex-wrap gap-2">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  value="026"
                  id="code026-mobile"
                  x-model="filters.majorCodes"
                  @change="applyFilters()"
                /><label class="form-check-label small" for="code026-mobile"
                  >026</label
                >
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >発注日</label
            >
            <div class="input-group input-group-sm">
              <input
                type="date"
                class="form-control"
                x-model="filters.dateFrom"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="date"
                class="form-control"
                x-model="filters.dateTo"
                @change="applyFilters()"
              />
            </div>
          </div>

          <div class="section-title mt-3">項目情報</div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >小工事項目名称</label
            >
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="キーワード検索"
              x-model="filters.item"
              @input="applyFilters()"
            />
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >業者名</label
            >
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="業者名"
              x-model="filters.vendor"
              @input="applyFilters()"
            />
          </div>

          <div class="section-title mt-3">建物情報</div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >地上階数</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="3"
                x-model.number="filters.floorMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="3"
                min="1"
                max="3"
                x-model.number="filters.floorMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >戸並び</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="55"
                x-model.number="filters.unitRowMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="55"
                min="1"
                max="55"
                x-model.number="filters.unitRowMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >居住用戸数</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="12"
                x-model.number="filters.resUnitMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="12"
                min="1"
                max="12"
                x-model.number="filters.resUnitMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >施工面積 (㎡)</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="50"
                x-model.number="filters.constAreaMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="1000"
                x-model.number="filters.constAreaMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >延床面積 (㎡)</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="50"
                x-model.number="filters.totalAreaMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="1000"
                x-model.number="filters.totalAreaMax"
                @change="applyFilters()"
              />
            </div>
          </div>
        </div>
        <div class="p-3 border-top bg-light">
          <div class="d-grid gap-2">
            <button class="btn btn-primary" @click="applyFilters()" data-bs-dismiss="offcanvas">
              検索実行
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              @click="clearFilters()"
            >
              条件クリア
            </button>
          </div>
        </div>
      </div>

      <main class="main-content p-2 p-md-3 p-lg-4" x-show="!isLoading && !loadError">
        <div class="mb-4">
          <h4 class="fw-bold mb-3">検索結果一覧</h4>
          <div class="d-flex gap-2 align-items-center flex-wrap mb-3">
            <template x-if="activeFiltersDisplay.length > 0">
              <small class="text-muted me-2">適用中:</small>
            </template>
            <template x-for="filter in activeFiltersDisplay" :key="filter">
              <span
                class="badge filter-badge bg-secondary"
                x-text="filter"
              ></span>
            </template>
            <template x-if="activeFiltersDisplay.length === 0">
              <small class="text-muted">絞り込み条件なし（全品目表示）</small>
            </template>
          </div>
        </div>

        <div>
          <template x-if="displayedGroups.length === 0">
            <div class="text-center py-5">
              <svg
                width="64"
                height="64"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                viewBox="0 0 24 24"
                class="text-muted mb-3"
              >
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
              </svg>
              <p class="text-muted">検索条件に該当する品目がありません</p>
              <button
                class="btn btn-sm btn-outline-primary"
                @click="clearFilters()"
              >
                条件をクリア
              </button>
            </div>
          </template>

          <div class="results-grid">
            <template x-for="(group, idx) in displayedGroups" :key="idx">
              <div
                class="card item-group-card shadow-sm"
                :class="{ 'expanded': expandedGroups[idx] }"
              >
                <div class="card-body" @click="toggleGroup(idx)">
                  <div
                    class="d-flex justify-content-between align-items-start mb-3"
                  >
                    <div>
                      <h5 class="fw-bold mb-2" x-text="group.item"></h5>
                      <div class="d-flex flex-wrap gap-1">
                        <span
                          class="badge bg-secondary"
                          x-text="group.unit"
                        ></span>
                        <span
                          class="badge bg-info"
                          x-text="group.filteredRecords.length + '件'"
                        ></span>
                      </div>
                    </div>
                    <div class="text-end">
                      <small class="text-muted d-block mb-1"
                        >実行単価レンジ</small
                      >
                      <div
                        class="d-flex align-items-center justify-content-end gap-2"
                      >
                        <span
                          class="fw-bold tabular-nums text-success"
                          x-text="`¥${formatNumber(group.minPrice)}`"
                        ></span>
                        <span class="text-muted">～</span>
                        <span
                          class="fw-bold tabular-nums text-danger"
                          x-text="`¥${formatNumber(group.maxPrice)}`"
                        ></span>
                      </div>
                    </div>
                  </div>

                  <div class="bg-white rounded-3 border overflow-hidden mb-3">
                    <div
                      class="p-2 d-flex align-items-center gap-2 cursor-pointer border-bottom"
                      @click.stop="vendorSectionExpanded[idx] = !vendorSectionExpanded[idx]"
                      style="cursor: pointer"
                    >
                      <svg
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                        class="transition-transform"
                        :class="vendorSectionExpanded[idx] ? 'rotate-90' : ''"
                      >
                        <polyline points="9 18 15 12 9 6"></polyline>
                      </svg>
                      <svg
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                      </svg>
                      <span class="small fw-semibold text-secondary"
                        >業者別 実行単価レンジ（/<span
                          x-text="group.unit"
                        ></span
                        >）</span
                      >
                      <span
                        class="badge bg-secondary rounded-pill small ms-auto"
                        x-text="getVendorCount(group) + '社'"
                      ></span>
                    </div>
                    <div
                      class="p-2 p-md-3 transition-collapse"
                      :class="vendorSectionExpanded[idx] ? 'collapse-shown' : 'collapse-hidden'"
                    >
                      <div class="d-flex flex-column gap-2">
                        <template
                          x-for="(vendor, vendorIdx) in getVendorSummary(group)"
                          :key="idx + '-vendor-' + vendorIdx"
                        >
                          <div
                            class="company-summary-item d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2 p-2 bg-light rounded border"
                          >
                            <div
                              class="company-header d-flex align-items-center gap-2 w-100 w-sm-auto"
                            >
                              <span
                                class="fw-semibold small text-dark"
                                x-text="vendor.name"
                              ></span>
                              <span
                                class="badge bg-secondary rounded-pill small"
                                x-text="vendor.count + '件'"
                              ></span>
                            </div>
                            <div
                              class="company-prices d-flex align-items-center gap-2 gap-sm-3 ms-0 ms-sm-auto w-100 w-sm-auto flex-wrap"
                            >
                              <div class="d-flex align-items-baseline gap-1">
                                <span class="small text-secondary">最小</span>
                                <span
                                  class="small fw-semibold tabular-nums company-price-value min"
                                  x-text="`¥${formatNumber(vendor.min)}`"
                                ></span>
                              </div>
                              <div class="d-flex align-items-baseline gap-1">
                                <span class="small text-secondary">平均</span>
                                <span
                                  class="small fw-semibold tabular-nums text-dark"
                                  x-text="`¥${formatNumber(vendor.avg)}`"
                                ></span>
                              </div>
                              <div class="d-flex align-items-baseline gap-1">
                                <span class="small text-secondary">最大</span>
                                <span
                                  class="small fw-semibold tabular-nums company-price-value max"
                                  x-text="`¥${formatNumber(vendor.max)}`"
                                ></span>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>

                  <div
                    class="d-flex justify-content-center gap-2 align-items-center flex-wrap"
                  >
                    <button
                      class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
                      @click.stop="expandedGroups[idx] = !expandedGroups[idx]"
                    >
                      <svg
                        class="icon-inline"
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M3 9h18" />
                        <path d="M9 21V9" />
                      </svg>
                      <span class="d-none d-sm-inline">時系列一覧</span>
                      <span class="d-inline d-sm-none">時系列</span>
                    </button>
                    <button
                      class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
                      @click.stop="showChart(idx)"
                    >
                      <svg
                        class="icon-inline"
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <line x1="18" y1="20" x2="18" y2="10" />
                        <line x1="12" y1="20" x2="12" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="14" />
                      </svg>
                      <span class="d-none d-sm-inline">単価推移</span>
                      <span class="d-inline d-sm-none">推移</span>
                    </button>
                    <button
                      class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
                      @click.stop="openDetailModal(idx)"
                    >
                      <svg
                        class="icon-inline"
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                      <span class="d-none d-sm-inline">多角分析</span>
                      <span class="d-inline d-sm-none">分析</span>
                    </button>
                  </div>
                </div>

                <div
                  class="border-top"
                  x-show="expandedGroups[idx]"
                  x-transition:enter="transition-collapse"
                  x-transition:enter-start="collapse-hidden"
                  x-transition:enter-end="collapse-shown"
                  x-transition:leave="transition-collapse"
                  x-transition:leave-start="collapse-shown"
                  x-transition:leave-end="collapse-hidden"
                >
                  <div class="card-body bg-light">
                    <h6 class="fw-bold text-secondary mb-3">
                      <svg
                        class="icon-inline"
                        width="16"
                        height="16"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                      </svg>
                      見積詳細（発注日の時系列）
                    </h6>
                    <div class="timeline-container">
                      <template
                        x-for="(record, recordIdx) in group.filteredRecords"
                        :key="idx + '-' + recordIdx"
                      >
                        <div class="timeline-item">
                          <div class="timeline-date">
                            <span
                              class="year"
                              x-text="record.orderMonth.split('-')[0]"
                            ></span>
                            <span
                              class="month"
                              x-text="parseInt(record.orderMonth.split('-')[1]) + '月'"
                            ></span>
                          </div>
                          <div class="timeline-dot"></div>
                          <div class="timeline-content">
                            <div
                              class="d-flex flex-column flex-sm-row justify-content-between align-items-start gap-2 gap-sm-3"
                            >
                              <div class="flex-grow-1 w-100 w-sm-auto">
                                <div
                                  class="d-flex align-items-center gap-1 flex-wrap mb-2"
                                >
                                  <span
                                    class="badge bg-info"
                                    x-text="record.region"
                                  ></span>
                                  <span
                                    class="badge bg-secondary"
                                    x-text="record.majorCode"
                                  ></span>
                                  <span
                                    class="badge bg-light text-dark"
                                    x-text="record.floors + '階'"
                                  ></span>
                                  <span
                                    class="badge bg-light text-dark"
                                    x-text="record.unitRow + '戸並'"
                                  ></span>
                                  <span
                                    class="badge bg-light text-dark"
                                    x-text="record.resUnits + '戸'"
                                  ></span>
                                </div>
                                <div
                                  class="fw-semibold small text-dark"
                                  x-text="record.projectName"
                                ></div>
                              </div>
                              <div class="text-start text-sm-end">
                                <div
                                  class="fs-6 fw-bold text-primary tabular-nums"
                                  x-text="`¥${formatNumber(record.price)}`"
                                ></div>
                                <div
                                  class="small text-secondary"
                                  x-text="`/${record.unit}`"
                                ></div>
                              </div>
                            </div>
                            <div class="detail-grid">
                              <div class="detail-item">
                                <div class="detail-label">業者</div>
                                <div
                                  class="detail-value"
                                  x-text="record.vendor"
                                ></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">実行数量</div>
                                <div
                                  class="detail-value tabular-nums"
                                  x-text="`${formatNumber(record.qty)} ${record.unit}`"
                                ></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">施工面積</div>
                                <div
                                  class="detail-value tabular-nums"
                                  x-text="`${formatNumber(record.constArea)} ㎡`"
                                ></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">延床面積</div>
                                <div
                                  class="detail-value tabular-nums"
                                  x-text="`${formatNumber(record.totalArea)} ㎡`"
                                ></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">実行金額</div>
                                <div
                                  class="detail-value tabular-nums highlight"
                                  x-text="`¥${formatNumber(record.amount)}`"
                                ></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                    <div
                      class="text-center mt-3 pt-3 border-top cursor-pointer"
                      @click.stop="toggleGroup(idx)"
                    >
                      <small class="text-muted">
                        <svg
                          class="icon-inline-sm"
                          width="16"
                          height="16"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          viewBox="0 0 24 24"
                        >
                          <polyline points="18 15 12 9 6 15" />
                        </svg>
                        クリックして閉じる
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- Load More Button -->
          <template x-if="hasMoreGroups">
            <div class="text-center py-4">
              <button
                class="btn btn-outline-primary btn-lg"
                @click="loadMoreGroups()"
              >
                <svg
                  class="icon-inline me-2"
                  width="16"
                  height="16"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <polyline points="6 9 12 15 18 9" />
                </svg>
                さらに表示
                <span
                  class="badge bg-primary ms-2"
                  x-text="Math.min(displayLimit, remainingGroupsCount) + '件'"
                ></span>
              </button>
              <p class="text-muted small mt-2">
                <span x-text="displayedCount"></span> /
                <span x-text="filteredGroups.length"></span> 件表示中
              </p>
            </div>
          </template>
        </div>

        <!-- Chart Modal (inside x-data scope) -->
        <div
          class="modal fade"
          id="chartModal"
          tabindex="-1"
          x-ref="chartModal"
        >
          <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
              <!-- Header -->
              <div class="modal-header">
                <h5 class="modal-title fw-bold">
                  <svg
                    class="icon-inline me-2"
                    width="20"
                    height="20"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <line x1="18" y1="20" x2="18" y2="10" />
                    <line x1="12" y1="20" x2="12" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="14" />
                  </svg>
                  単価推移 - <span x-text="chartData.item"></span>
                  <small
                    class="text-muted ms-2"
                    x-text="`(${chartData.unit})`"
                  ></small>
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                ></button>
              </div>

              <!-- Control Bar -->
              <div class="bg-light border-bottom py-2 px-3">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                  <!-- View Toggle -->
                  <div class="btn-group btn-group-sm" role="group">
                    <button
                      type="button"
                      class="btn"
                      :class="chartData.displayMode === 'chart' ? 'btn-primary' : 'btn-outline-secondary'"
                      @click="setChartDisplayMode('chart')"
                    >
                      <svg class="icon-inline me-1" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <line x1="18" y1="20" x2="18" y2="10" />
                        <line x1="12" y1="20" x2="12" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="14" />
                      </svg>
                      チャート
                    </button>
                    <button
                      type="button"
                      class="btn"
                      :class="chartData.displayMode === 'table' ? 'btn-primary' : 'btn-outline-secondary'"
                      @click="setChartDisplayMode('table')"
                    >
                      <svg class="icon-inline me-1" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <line x1="8" y1="6" x2="21" y2="6" />
                        <line x1="8" y1="12" x2="21" y2="12" />
                        <line x1="8" y1="18" x2="21" y2="18" />
                        <line x1="3" y1="6" x2="3.01" y2="6" />
                        <line x1="3" y1="12" x2="3.01" y2="12" />
                        <line x1="3" y1="18" x2="3.01" y2="18" />
                      </svg>
                      テーブル
                    </button>
                  </div>

                  <!-- Summary Stats -->
                  <div class="d-flex gap-2 gap-md-3 align-items-center flex-wrap">
                    <span class="badge bg-info" x-text="chartData.records.length + '件'"></span>
                    <small class="text-muted">最小:</small>
                    <span class="fw-semibold text-success small" x-text="`¥${formatNumber(chartData.minPrice)}`"></span>
                    <small class="text-muted">平均:</small>
                    <span class="fw-semibold text-primary small" x-text="`¥${formatNumber(chartData.avgPrice)}`"></span>
                    <small class="text-muted">最大:</small>
                    <span class="fw-semibold text-danger small" x-text="`¥${formatNumber(chartData.maxPrice)}`"></span>
                  </div>
                </div>
              </div>

              <!-- Modal Body -->
              <div class="modal-body p-0">
                <!-- Chart View -->
                <div x-show="chartData.displayMode === 'chart'" class="p-3">
                  <div class="chart-scroll-container">
                    <div class="chart-wrapper" x-ref="chartWrapper">
                      <canvas x-ref="netPriceChart"></canvas>
                    </div>
                  </div>
                </div>

                <!-- Table View (Weekly Grouped) -->
                <div
                  x-show="chartData.displayMode === 'table'"
                  class="bg-body-secondary p-3 overflow-auto"
                  style="max-height: calc(100vh - 160px)"
                >
                  <template
                    x-for="(weekGroup, weekIdx) in chartData.weeklyData"
                    :key="weekIdx"
                  >
                    <div class="mb-4">
                      <!-- Week Group Header -->
                      <div
                        class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2 mb-2 pb-2 border-bottom"
                      >
                        <div class="d-flex align-items-center gap-2">
                          <h6
                            class="fw-bold mb-0"
                            x-text="weekGroup.weekStart"
                          ></h6>
                          <span
                            class="badge bg-secondary"
                            x-text="weekGroup.count + '件'"
                          ></span>
                        </div>
                        <div class="ms-0 ms-md-auto small d-flex flex-wrap gap-2 gap-md-3">
                          <span class="text-success">
                            <span class="d-none d-sm-inline">最小:</span>
                            <span class="d-inline d-sm-none">小:</span>
                            <span
                              class="fw-semibold"
                              x-text="`¥${formatNumber(weekGroup.minPrice)}`"
                            ></span>
                          </span>
                          <span class="text-muted d-none d-md-inline">|</span>
                          <span class="text-primary">
                            <span class="d-none d-sm-inline">平均:</span>
                            <span class="d-inline d-sm-none">均:</span>
                            <span
                              class="fw-semibold"
                              x-text="`¥${formatNumber(weekGroup.avgPrice)}`"
                            ></span>
                          </span>
                          <span class="text-muted d-none d-md-inline">|</span>
                          <span class="text-danger">
                            <span class="d-none d-sm-inline">最大:</span>
                            <span class="d-inline d-sm-none">大:</span>
                            <span
                              class="fw-semibold"
                              x-text="`¥${formatNumber(weekGroup.maxPrice)}`"
                            ></span>
                          </span>
                        </div>
                      </div>
                      <!-- Week Group Table -->
                      <div class="card shadow-sm">
                        <div class="table-responsive">
                          <table
                            class="table table-sm table-bordered table-hover mb-0"
                            style="min-width: 1400px; table-layout: fixed"
                          >
                            <thead class="table-light">
                              <tr>
                                <th style="width: 100px">発注日</th>
                                <th style="width: 70px">支店</th>
                                <th style="width: 60px">大工事</th>
                                <th style="width: 180px">工事名称</th>
                                <th style="width: 180px">業者</th>
                                <th class="text-end" style="width: 70px">
                                  実行数量
                                </th>
                                <th class="text-center" style="width: 50px">
                                  単位
                                </th>
                                <th class="text-end" style="width: 100px">
                                  実行単価
                                </th>
                                <th class="text-end" style="width: 110px">
                                  実行金額
                                </th>
                                <th class="text-center" style="width: 55px">
                                  階数
                                </th>
                                <th class="text-center" style="width: 55px">
                                  戸並
                                </th>
                                <th class="text-center" style="width: 55px">
                                  戸数
                                </th>
                                <th class="text-end" style="width: 100px">
                                  施工面積
                                </th>
                                <th class="text-end" style="width: 100px">
                                  延床面積
                                </th>
                              </tr>
                            </thead>
                            <tbody>
                              <template
                                x-for="(r, rIdx) in weekGroup.records"
                                :key="weekIdx + '-' + rIdx"
                              >
                                <tr>
                                  <td
                                    class="text-nowrap"
                                    x-text="r.orderDateFormatted"
                                  ></td>
                                  <td>
                                    <span
                                      class="badge bg-info"
                                      x-text="r.region"
                                    ></span>
                                  </td>
                                  <td>
                                    <span
                                      class="badge bg-secondary"
                                      x-text="r.majorCode"
                                    ></span>
                                  </td>
                                  <td
                                    class="text-truncate"
                                    style="max-width: 180px"
                                    x-text="r.projectName"
                                    :title="r.projectName"
                                  ></td>
                                  <td
                                    class="text-truncate"
                                    style="max-width: 180px"
                                    x-text="r.vendor"
                                    :title="r.vendor"
                                  ></td>
                                  <td
                                    class="text-end tabular-nums text-nowrap"
                                    x-text="formatNumber(r.qty)"
                                  ></td>
                                  <td class="text-center" x-text="r.unit"></td>
                                  <td
                                    class="text-end tabular-nums text-nowrap"
                                    x-text="`¥${formatNumber(r.price)}`"
                                  ></td>
                                  <td
                                    class="text-end tabular-nums text-nowrap fw-semibold"
                                    x-text="`¥${formatNumber(r.amount)}`"
                                  ></td>
                                  <td
                                    class="text-center tabular-nums"
                                    x-text="r.floors + '階'"
                                  ></td>
                                  <td
                                    class="text-center tabular-nums"
                                    x-text="r.unitRow + '戸'"
                                  ></td>
                                  <td
                                    class="text-center tabular-nums"
                                    x-text="r.resUnits + '戸'"
                                  ></td>
                                  <td
                                    class="text-end tabular-nums text-nowrap"
                                    x-text="`${formatNumber(r.constArea)} ㎡`"
                                  ></td>
                                  <td
                                    class="text-end tabular-nums text-nowrap"
                                    x-text="`${formatNumber(r.totalArea)} ㎡`"
                                  ></td>
                                </tr>
                              </template>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>

              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  閉じる
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Detail Analysis Modal (BI Dashboard) -->
        <div
          class="modal fade"
          id="detailModal"
          tabindex="-1"
          x-ref="detailModal"
          @hidden.bs.modal="closeDetailModal()"
        >
          <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
              <!-- Header -->
              <div class="modal-header py-2">
                <div class="d-flex flex-column">
                  <h5 class="modal-title fw-bold mb-0">
                    <svg
                      class="icon-inline me-2"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                    >
                      <circle cx="11" cy="11" r="8" />
                      <path d="m21 21-4.35-4.35" />
                    </svg>
                    <span x-text="detailModal.currentGroup?.item"></span>
                    <small class="text-muted ms-2" x-text="`(${detailModal.currentGroup?.spec || ''})`"></small>
                  </h5>
                </div>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                ></button>
              </div>

              <!-- Tab Navigation -->
              <div class="bg-white border-bottom">
                <ul class="nav nav-tabs border-bottom-0 px-3" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      :class="{ 'active': detailModal.activeTab === 'timeseries' }"
                      @click="setDetailTab('timeseries')"
                      type="button"
                      role="tab"
                    >
                      <svg class="icon-inline me-1" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                      </svg>
                      時系列分析
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      :class="{ 'active': detailModal.activeTab === 'comparison' }"
                      @click="setDetailTab('comparison')"
                      type="button"
                      role="tab"
                    >
                      <svg class="icon-inline me-1" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <line x1="18" y1="20" x2="18" y2="10" />
                        <line x1="12" y1="20" x2="12" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="14" />
                      </svg>
                      比較分析
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      :class="{ 'active': detailModal.activeTab === 'trend' }"
                      @click="setDetailTab('trend')"
                      type="button"
                      role="tab"
                    >
                      <svg class="icon-inline me-1" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="2" />
                        <circle cx="6" cy="6" r="2" />
                        <circle cx="18" cy="18" r="2" />
                        <circle cx="6" cy="18" r="2" />
                        <circle cx="18" cy="6" r="2" />
                      </svg>
                      傾向分析
                    </button>
                  </li>
                </ul>
              </div>

              <!-- Common Filters Bar -->
              <div class="bg-light border-bottom py-2 px-3">
                <div class="d-flex align-items-center gap-3 flex-wrap">
                  <!-- Date Range Filter -->
                  <div class="d-flex align-items-center gap-1">
                    <label class="form-label small mb-0 text-muted fw-semibold">期間:</label>
                    <div class="input-group input-group-sm" style="width: auto">
                      <input
                        type="date"
                        class="form-control form-control-sm"
                        x-model="detailModal.commonFilters.dateFrom"
                        @change="applyDetailCommonFilters()"
                      />
                      <span class="input-group-text">~</span>
                      <input
                        type="date"
                        class="form-control form-control-sm"
                        x-model="detailModal.commonFilters.dateTo"
                        @change="applyDetailCommonFilters()"
                      />
                    </div>
                  </div>
                  <!-- Region Filter -->
                  <div class="d-flex align-items-center gap-1">
                    <label class="form-label small mb-0 text-muted fw-semibold">支店:</label>
                    <select
                      class="form-select form-select-sm"
                      style="width: auto"
                      x-model="detailModal.commonFilters.regions"
                      @change="applyDetailCommonFilters()"
                      multiple
                    >
                      <template x-for="region in detailModalRegionOptions" :key="region">
                        <option :value="region" x-text="region"></option>
                      </template>
                    </select>
                  </div>
                  <!-- Vendor Filter -->
                  <div class="d-flex align-items-center gap-1">
                    <label class="form-label small mb-0 text-muted fw-semibold">業者:</label>
                    <select
                      class="form-select form-select-sm"
                      style="width: auto; max-width: 200px"
                      x-model="detailModal.commonFilters.vendors"
                      @change="applyDetailCommonFilters()"
                      multiple
                    >
                      <template x-for="vendor in detailModalVendorOptions" :key="vendor">
                        <option :value="vendor" x-text="vendor"></option>
                      </template>
                    </select>
                  </div>
                  <!-- Clear Filters -->
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm"
                    @click="clearDetailCommonFilters()"
                  >
                    クリア
                  </button>
                </div>
              </div>

              <!-- Tab-specific Controls -->
              <div class="bg-white border-bottom py-2 px-3">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                  <!-- Timeseries Controls -->
                  <div :class="detailModal.activeTab === 'timeseries' ? 'd-flex align-items-center gap-3 flex-wrap' : 'd-none'">
                    <div class="d-flex align-items-center gap-1">
                      <label class="form-label small mb-0 text-muted fw-semibold">時間軸:</label>
                      <select class="form-select form-select-sm" style="width: auto" x-model="detailModal.timeseries.timeUnit" @change="renderDetailChart()">
                        <option value="yearly">年次</option>
                        <option value="monthly">月次</option>
                        <option value="weekly">週次</option>
                        <option value="daily">日次</option>
                      </select>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                      <label class="form-label small mb-0 text-muted fw-semibold">表示:</label>
                      <select class="form-select form-select-sm" style="width: auto" x-model="detailModal.timeseries.chartType" @change="renderDetailChart()">
                        <option value="line">折れ線</option>
                        <option value="area">面グラフ</option>
                        <option value="bar">棒グラフ</option>
                        <option value="table">テーブル</option>
                      </select>
                    </div>
                  </div>

                  <!-- Comparison Controls (right-aligned) -->
                  <div :class="detailModal.activeTab === 'comparison' ? 'd-flex align-items-center gap-3 flex-wrap ms-auto' : 'd-none'">
                    <div class="d-flex align-items-center gap-1">
                      <label class="form-label small mb-0 text-muted fw-semibold">比較軸:</label>
                      <select class="form-select form-select-sm" style="width: auto" x-model="detailModal.comparison.groupBy" @change="renderDetailChart()">
                        <option value="region">支店別</option>
                        <option value="vendor">業者別</option>
                        <option value="majorCode">大工事項目別</option>
                        <option value="building">建物タイプ別</option>
                      </select>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                      <label class="form-label small mb-0 text-muted fw-semibold">指標:</label>
                      <select class="form-select form-select-sm" style="width: auto" x-model="detailModal.comparison.metric" @change="renderDetailChart()">
                        <option value="avg">平均</option>
                        <option value="median">中央値</option>
                        <option value="total">合計</option>
                      </select>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                      <label class="form-label small mb-0 text-muted fw-semibold">表示:</label>
                      <select class="form-select form-select-sm" style="width: auto" x-model="detailModal.comparison.chartType" @change="renderDetailChart()">
                        <option value="bar">棒グラフ</option>
                        <option value="boxplot">箱ひげ図</option>
                        <option value="radar">レーダー</option>
                        <option value="table">テーブル</option>
                      </select>
                    </div>
                  </div>

                  <!-- Trend Controls (right-aligned) -->
                  <div :class="detailModal.activeTab === 'trend' ? 'd-flex align-items-center gap-3 flex-wrap ms-auto' : 'd-none'">
                    <div class="d-flex align-items-center gap-1">
                      <label class="form-label small mb-0 text-muted fw-semibold">要因(X軸):</label>
                      <select class="form-select form-select-sm" style="width: auto" x-model="detailModal.trend.xAxis" @change="renderDetailChart()">
                        <option value="resUnits">総戸数</option>
                        <option value="floors">階数</option>
                        <option value="totalArea">延床面積</option>
                        <option value="constArea">施工面積</option>
                      </select>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                      <label class="form-label small mb-0 text-muted fw-semibold">表示:</label>
                      <select class="form-select form-select-sm" style="width: auto" x-model="detailModal.trend.chartType" @change="renderDetailChart()">
                        <option value="scatter">散布図</option>
                        <option value="bubble">バブル</option>
                        <option value="heatmap">ヒートマップ</option>
                        <option value="table">テーブル</option>
                      </select>
                    </div>
                    <template x-if="detailModal.trend.chartType === 'bubble'">
                      <div class="d-flex align-items-center gap-1">
                        <label class="form-label small mb-0 text-muted fw-semibold">サイズ:</label>
                        <select class="form-select form-select-sm" style="width: auto" x-model="detailModal.trend.bubbleSize" @change="renderDetailChart()">
                          <option value="qty">数量</option>
                          <option value="amount">金額</option>
                        </select>
                      </div>
                    </template>
                  </div>

                  <!-- KPI Summary (right side) -->
                  <div class="d-flex gap-2 gap-md-3 align-items-center flex-wrap ms-auto">
                    <span class="badge bg-info" x-text="detailModal.kpiSummary.count + '件'"></span>
                    <small class="text-muted">最小:</small>
                    <span class="fw-semibold text-success small" x-text="`¥${formatNumber(detailModal.kpiSummary.minPrice)}`"></span>
                    <small class="text-muted">平均:</small>
                    <span class="fw-semibold text-primary small" x-text="`¥${formatNumber(detailModal.kpiSummary.avgPrice)}`"></span>
                    <small class="text-muted">中央値:</small>
                    <span class="fw-semibold text-warning small" x-text="`¥${formatNumber(detailModal.kpiSummary.medianPrice)}`"></span>
                    <small class="text-muted">最大:</small>
                    <span class="fw-semibold text-danger small" x-text="`¥${formatNumber(detailModal.kpiSummary.maxPrice)}`"></span>
                  </div>
                </div>
              </div>

              <!-- Modal Body -->
              <div class="modal-body p-3 bg-body-secondary overflow-auto">
                <!-- Shared Chart Container (visible when not in table mode) -->
                <div x-show="!isDetailTableMode()" class="card shadow-sm mb-3">
                  <div class="card-body">
                    <div class="detail-chart-container">
                      <canvas x-ref="detailChart"></canvas>
                    </div>
                  </div>
                </div>

                <!-- Timeseries Tab Content -->
                <div x-show="detailModal.activeTab === 'timeseries'">
                  <!-- Table View -->
                  <div x-show="isDetailTableMode()">
                    <template x-for="(weekGroup, weekIdx) in getDetailTableData()" :key="weekIdx">
                      <div class="mb-4">
                        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2 mb-2 pb-2 border-bottom">
                          <div class="d-flex align-items-center gap-2">
                            <h6 class="fw-bold mb-0" x-text="weekGroup.label"></h6>
                            <span class="badge bg-secondary" x-text="weekGroup.count + '件'"></span>
                          </div>
                          <div class="ms-0 ms-md-auto small d-flex flex-wrap gap-2 gap-md-3">
                            <span class="text-success">最小: <span class="fw-semibold" x-text="`¥${formatNumber(weekGroup.minPrice)}`"></span></span>
                            <span class="text-primary">平均: <span class="fw-semibold" x-text="`¥${formatNumber(weekGroup.avgPrice)}`"></span></span>
                            <span class="text-danger">最大: <span class="fw-semibold" x-text="`¥${formatNumber(weekGroup.maxPrice)}`"></span></span>
                          </div>
                        </div>
                        <div class="card shadow-sm">
                          <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover mb-0" style="min-width: 1400px; table-layout: fixed">
                              <thead class="table-light">
                                <tr>
                                  <th style="width: 100px">発注日</th>
                                  <th style="width: 70px">支店</th>
                                  <th style="width: 60px">大工事</th>
                                  <th style="width: 180px">工事名称</th>
                                  <th style="width: 180px">業者</th>
                                  <th class="text-end" style="width: 70px">実行数量</th>
                                  <th class="text-center" style="width: 50px">単位</th>
                                  <th class="text-end" style="width: 100px">実行単価</th>
                                  <th class="text-end" style="width: 110px">実行金額</th>
                                  <th class="text-center" style="width: 55px">階数</th>
                                  <th class="text-center" style="width: 55px">戸並</th>
                                  <th class="text-center" style="width: 55px">戸数</th>
                                  <th class="text-end" style="width: 100px">施工面積</th>
                                  <th class="text-end" style="width: 100px">延床面積</th>
                                </tr>
                              </thead>
                              <tbody>
                                <template x-for="(r, rIdx) in weekGroup.records" :key="weekIdx + '-' + rIdx">
                                  <tr>
                                    <td class="text-nowrap" x-text="r.orderDateFormatted"></td>
                                    <td><span class="badge bg-info" x-text="r.region"></span></td>
                                    <td><span class="badge bg-secondary" x-text="r.majorCode"></span></td>
                                    <td class="text-truncate" style="max-width: 180px" x-text="r.projectName" :title="r.projectName"></td>
                                    <td class="text-truncate" style="max-width: 180px" x-text="r.vendor" :title="r.vendor"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="formatNumber(r.qty)"></td>
                                    <td class="text-center" x-text="r.unit"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="`¥${formatNumber(r.price)}`"></td>
                                    <td class="text-end tabular-nums text-nowrap fw-semibold" x-text="`¥${formatNumber(r.amount)}`"></td>
                                    <td class="text-center tabular-nums" x-text="r.floors + '階'"></td>
                                    <td class="text-center tabular-nums" x-text="r.unitRow + '戸'"></td>
                                    <td class="text-center tabular-nums" x-text="r.resUnits + '戸'"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="`${formatNumber(r.constArea)} ㎡`"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="`${formatNumber(r.totalArea)} ㎡`"></td>
                                  </tr>
                                </template>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>

                <!-- Comparison Tab Content -->
                <div x-show="detailModal.activeTab === 'comparison'">
                  <!-- Table View -->
                  <div x-show="isDetailTableMode()">
                    <template x-for="(group, groupIdx) in getDetailTableData()" :key="groupIdx">
                      <div class="mb-4">
                        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2 mb-2 pb-2 border-bottom">
                          <div class="d-flex align-items-center gap-2">
                            <h6 class="fw-bold mb-0" x-text="group.label"></h6>
                            <span class="badge bg-secondary" x-text="group.count + '件'"></span>
                          </div>
                          <div class="ms-0 ms-md-auto small d-flex flex-wrap gap-2 gap-md-3">
                            <span class="text-success">最小: <span class="fw-semibold" x-text="`¥${formatNumber(group.minPrice)}`"></span></span>
                            <span class="text-primary">平均: <span class="fw-semibold" x-text="`¥${formatNumber(group.avgPrice)}`"></span></span>
                            <span class="text-warning">中央値: <span class="fw-semibold" x-text="`¥${formatNumber(group.medianPrice)}`"></span></span>
                            <span class="text-danger">最大: <span class="fw-semibold" x-text="`¥${formatNumber(group.maxPrice)}`"></span></span>
                          </div>
                        </div>
                        <div class="card shadow-sm">
                          <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover mb-0" style="min-width: 1400px; table-layout: fixed">
                              <thead class="table-light">
                                <tr>
                                  <th style="width: 100px">発注日</th>
                                  <th style="width: 70px">支店</th>
                                  <th style="width: 60px">大工事</th>
                                  <th style="width: 180px">工事名称</th>
                                  <th style="width: 180px">業者</th>
                                  <th class="text-end" style="width: 70px">実行数量</th>
                                  <th class="text-center" style="width: 50px">単位</th>
                                  <th class="text-end" style="width: 100px">実行単価</th>
                                  <th class="text-end" style="width: 110px">実行金額</th>
                                  <th class="text-center" style="width: 55px">階数</th>
                                  <th class="text-center" style="width: 55px">戸並</th>
                                  <th class="text-center" style="width: 55px">戸数</th>
                                  <th class="text-end" style="width: 100px">施工面積</th>
                                  <th class="text-end" style="width: 100px">延床面積</th>
                                </tr>
                              </thead>
                              <tbody>
                                <template x-for="(r, rIdx) in group.records" :key="groupIdx + '-' + rIdx">
                                  <tr>
                                    <td class="text-nowrap" x-text="r.orderDateFormatted"></td>
                                    <td><span class="badge bg-info" x-text="r.region"></span></td>
                                    <td><span class="badge bg-secondary" x-text="r.majorCode"></span></td>
                                    <td class="text-truncate" style="max-width: 180px" x-text="r.projectName" :title="r.projectName"></td>
                                    <td class="text-truncate" style="max-width: 180px" x-text="r.vendor" :title="r.vendor"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="formatNumber(r.qty)"></td>
                                    <td class="text-center" x-text="r.unit"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="`¥${formatNumber(r.price)}`"></td>
                                    <td class="text-end tabular-nums text-nowrap fw-semibold" x-text="`¥${formatNumber(r.amount)}`"></td>
                                    <td class="text-center tabular-nums" x-text="r.floors + '階'"></td>
                                    <td class="text-center tabular-nums" x-text="r.unitRow + '戸'"></td>
                                    <td class="text-center tabular-nums" x-text="r.resUnits + '戸'"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="`${formatNumber(r.constArea)} ㎡`"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="`${formatNumber(r.totalArea)} ㎡`"></td>
                                  </tr>
                                </template>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>

                <!-- Trend Tab Content -->
                <div x-show="detailModal.activeTab === 'trend'">
                  <!-- Table View -->
                  <div x-show="isDetailTableMode()">
                    <template x-for="(group, groupIdx) in getDetailTableData()" :key="groupIdx">
                      <div class="mb-4">
                        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2 mb-2 pb-2 border-bottom">
                          <div class="d-flex align-items-center gap-2">
                            <h6 class="fw-bold mb-0" x-text="group.label"></h6>
                            <span class="badge bg-secondary" x-text="group.count + '件'"></span>
                          </div>
                          <div class="ms-0 ms-md-auto small d-flex flex-wrap gap-2 gap-md-3">
                            <span class="text-success">最小: <span class="fw-semibold" x-text="`¥${formatNumber(group.minPrice)}`"></span></span>
                            <span class="text-primary">平均: <span class="fw-semibold" x-text="`¥${formatNumber(group.avgPrice)}`"></span></span>
                            <span class="text-danger">最大: <span class="fw-semibold" x-text="`¥${formatNumber(group.maxPrice)}`"></span></span>
                          </div>
                        </div>
                        <div class="card shadow-sm">
                          <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover mb-0" style="min-width: 1400px; table-layout: fixed">
                              <thead class="table-light">
                                <tr>
                                  <th style="width: 100px">発注日</th>
                                  <th style="width: 70px">支店</th>
                                  <th style="width: 60px">大工事</th>
                                  <th style="width: 180px">工事名称</th>
                                  <th style="width: 180px">業者</th>
                                  <th class="text-end" style="width: 70px">実行数量</th>
                                  <th class="text-center" style="width: 50px">単位</th>
                                  <th class="text-end" style="width: 100px">実行単価</th>
                                  <th class="text-end" style="width: 110px">実行金額</th>
                                  <th class="text-center" style="width: 55px">階数</th>
                                  <th class="text-center" style="width: 55px">戸並</th>
                                  <th class="text-center" style="width: 55px">戸数</th>
                                  <th class="text-end" style="width: 100px">施工面積</th>
                                  <th class="text-end" style="width: 100px">延床面積</th>
                                </tr>
                              </thead>
                              <tbody>
                                <template x-for="(r, rIdx) in group.records" :key="groupIdx + '-' + rIdx">
                                  <tr>
                                    <td class="text-nowrap" x-text="r.orderDateFormatted"></td>
                                    <td><span class="badge bg-info" x-text="r.region"></span></td>
                                    <td><span class="badge bg-secondary" x-text="r.majorCode"></span></td>
                                    <td class="text-truncate" style="max-width: 180px" x-text="r.projectName" :title="r.projectName"></td>
                                    <td class="text-truncate" style="max-width: 180px" x-text="r.vendor" :title="r.vendor"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="formatNumber(r.qty)"></td>
                                    <td class="text-center" x-text="r.unit"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="`¥${formatNumber(r.price)}`"></td>
                                    <td class="text-end tabular-nums text-nowrap fw-semibold" x-text="`¥${formatNumber(r.amount)}`"></td>
                                    <td class="text-center tabular-nums" x-text="r.floors + '階'"></td>
                                    <td class="text-center tabular-nums" x-text="r.unitRow + '戸'"></td>
                                    <td class="text-center tabular-nums" x-text="r.resUnits + '戸'"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="`${formatNumber(r.constArea)} ㎡`"></td>
                                    <td class="text-end tabular-nums text-nowrap" x-text="`${formatNumber(r.totalArea)} ㎡`"></td>
                                  </tr>
                                </template>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </div>

              <!-- Footer -->
              <div class="modal-footer py-2">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  閉じる
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- External Libraries with defer for non-blocking -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/js/bootstrap.min.js"
      integrity="sha256-ew8UiV1pJH/YjpOEBInP1HxVvT/SfrCmwSoUzF9JIgc="
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"
    ></script>
    <!-- pako for gzip decompression -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"
    ></script>
    <!-- Chart.js Boxplot plugin -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@4"
    ></script>
    <!-- Chart.js Matrix (Heatmap) plugin -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2"
    ></script>
    <!-- Comlink for Web Worker communication -->
    <script
      defer
      src="https://unpkg.com/comlink@4.4.1/dist/umd/comlink.min.js"
    ></script>
    <!-- Application Scripts (load order matters) -->
    <script defer src="js/utils.js"></script>
    <script defer src="js/data-loader.js"></script>
    <script defer src="js/app.js"></script>

    <!-- Alpine.js (must be loaded after app scripts) -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.3/dist/cdn.min.js"
    ></script>
  </body>
</html>

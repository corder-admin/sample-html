<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>単価ダッシュボード</title>

    <!-- DNS prefetch and preconnect for faster CDN loading -->
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />

    <!-- Critical CSS: x-cloak to prevent FOUC -->
    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>

    <!-- Bootstrap CSS with preload for non-blocking -->
    <link
      rel="preload"
      as="style"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/css/bootstrap.min.css"
      integrity="sha256-2FMn2Zx6PuH5tdBQDRNwrOo60ts5wWPC9R8jK67b3t4="
      crossorigin="anonymous"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/css/bootstrap.min.css"
        integrity="sha256-2FMn2Zx6PuH5tdBQDRNwrOo60ts5wWPC9R8jK67b3t4="
        crossorigin="anonymous"
      />
    </noscript>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bg-body-secondary">
    <nav
      class="navbar navbar-dark bg-dark px-3"
      style="height: var(--header-height)"
    >
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <svg
          class="icon-lg"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
          />
          <polyline points="7.5 4.21 12 6.81 16.5 4.21" />
          <polyline points="7.5 19.79 7.5 14.6 3 12" />
          <polyline points="21 12 16.5 14.6 16.5 19.79" />
          <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
          <line x1="12" y1="22.08" x2="12" y2="12" />
        </svg>
        <span class="fw-bold">単価ダッシュボード</span>
      </a>
    </nav>

    <div class="d-flex flex-column flex-lg-row" x-data="appData()" x-cloak>
      <!-- ローディングオーバーレイ -->
      <template x-if="isLoading">
        <div
          class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white"
          style="z-index: 9999"
        >
          <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mb-0">データを読み込み中...</p>
          </div>
        </div>
      </template>

      <!-- エラー表示 -->
      <template x-if="!isLoading && loadError">
        <div class="container py-5">
          <div class="alert alert-danger" role="alert">
            <h5 class="alert-heading">読み込みエラー</h5>
            <p class="mb-0" x-text="loadError"></p>
          </div>
        </div>
      </template>

      <aside
        class="sidebar d-flex flex-column bg-white"
        x-show="!isLoading && !loadError"
      >
        <div class="p-3 border-bottom">
          <h6
            class="mb-0 fw-bold text-secondary d-flex align-items-center gap-1"
          >
            <svg
              class="icon"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            検索条件
          </h6>
        </div>
        <div class="p-3 flex-grow-1" @keydown.enter="applyFilters()">
          <div class="section-title">工事情報</div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >工事名称</label
            >
            <div class="position-relative">
              <input
                type="text"
                class="form-control form-control-sm"
                placeholder="選択または入力"
                x-model="filters.project"
                @focus="autocomplete.show = true; filterProjectNames()"
                @input="filterProjectNames()"
                @blur="setTimeout(() => { autocomplete.show = false; applyFilters(); }, 150)"
                @keydown.arrow-down.prevent="moveAutocompleteDown()"
                @keydown.arrow-up.prevent="moveAutocompleteUp()"
                @keydown.enter.prevent="selectAutocomplete(); applyFilters()"
                @keydown.escape="autocomplete.show = false"
                autocomplete="off"
              />
              <div
                class="autocomplete-dropdown"
                x-show="autocomplete.show && autocomplete.items.length > 0"
                @click="selectProject($event); applyFilters()"
              >
                <template x-for="(item, idx) in autocomplete.items" :key="item">
                  <div
                    class="autocomplete-item"
                    :class="{ 'active': idx === autocomplete.activeIndex }"
                    :data-value="item"
                    x-text="item"
                  ></div>
                </template>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >支店名</label
            >
            <div class="position-relative">
              <button
                type="button"
                class="form-select form-select-sm text-start"
                @click="toggleRegionDropdown()"
                @click.away="regionDropdownOpen = false"
              >
                <span x-text="selectedRegionsText"></span>
              </button>
              <div
                class="dropdown-menu w-100 p-2"
                :class="{ 'show': regionDropdownOpen }"
                @click.stop
              >
                <div class="dropdown-scroll">
                  <template x-for="region in regionNames" :key="region">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        :id="'region-' + region"
                        :checked="isRegionSelected(region)"
                        @change="toggleRegion(region)"
                      />
                      <label
                        class="form-check-label small"
                        :for="'region-' + region"
                        x-text="region"
                      ></label>
                    </div>
                  </template>
                </div>
                <div class="border-top pt-2 mt-2">
                  <button
                    type="button"
                    class="btn btn-primary btn-sm w-100"
                    @click="confirmRegionSelection()"
                  >
                    決定
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >大工事項目コード</label
            >
            <div class="d-flex flex-wrap gap-2">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  value="026"
                  id="code026"
                  x-model="filters.majorCodes"
                  @change="applyFilters()"
                /><label class="form-check-label small" for="code026"
                  >026</label
                >
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >発注日</label
            >
            <div class="input-group input-group-sm">
              <input
                type="date"
                class="form-control"
                x-model="filters.dateFrom"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="date"
                class="form-control"
                x-model="filters.dateTo"
                @change="applyFilters()"
              />
            </div>
          </div>

          <div class="section-title mt-3">項目情報</div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >小工事項目名称</label
            >
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="キーワード検索"
              x-model="filters.item"
              @input="applyFilters()"
            />
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >業者名</label
            >
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="業者名"
              x-model="filters.vendor"
              @input="applyFilters()"
            />
          </div>

          <div class="section-title mt-3">建物情報</div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >地上階数</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="3"
                x-model.number="filters.floorMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="3"
                min="1"
                max="3"
                x-model.number="filters.floorMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >戸並び</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="55"
                x-model.number="filters.unitRowMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="55"
                min="1"
                max="55"
                x-model.number="filters.unitRowMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >居住用戸数</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="1"
                min="1"
                max="12"
                x-model.number="filters.resUnitMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="12"
                min="1"
                max="12"
                x-model.number="filters.resUnitMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >施工面積 (㎡)</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="50"
                x-model.number="filters.constAreaMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="1000"
                x-model.number="filters.constAreaMax"
                @change="applyFilters()"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold text-secondary"
              >延床面積 (㎡)</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                placeholder="50"
                x-model.number="filters.totalAreaMin"
                @change="applyFilters()"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control"
                placeholder="1000"
                x-model.number="filters.totalAreaMax"
                @change="applyFilters()"
              />
            </div>
          </div>
        </div>
        <div class="p-3 border-top bg-light">
          <div class="d-grid gap-2">
            <button class="btn btn-primary" @click="applyFilters()">
              検索実行
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              @click="clearFilters()"
            >
              条件クリア
            </button>
          </div>
        </div>
      </aside>

      <main class="main-content p-4" x-show="!isLoading && !loadError">
        <div class="mb-4">
          <h4 class="fw-bold mb-3">検索結果一覧</h4>
          <div class="d-flex gap-2 align-items-center flex-wrap mb-3">
            <template x-if="activeFiltersDisplay.length > 0">
              <small class="text-muted me-2">適用中:</small>
            </template>
            <template x-for="filter in activeFiltersDisplay" :key="filter">
              <span
                class="badge filter-badge bg-secondary"
                x-text="filter"
              ></span>
            </template>
            <template x-if="activeFiltersDisplay.length === 0">
              <small class="text-muted">絞り込み条件なし（全品目表示）</small>
            </template>
          </div>
        </div>

        <div>
          <template x-if="displayedGroups.length === 0">
            <div class="text-center py-5">
              <svg
                width="64"
                height="64"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                viewBox="0 0 24 24"
                class="text-muted mb-3"
              >
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
              </svg>
              <p class="text-muted">検索条件に該当する品目がありません</p>
              <button
                class="btn btn-sm btn-outline-primary"
                @click="clearFilters()"
              >
                条件をクリア
              </button>
            </div>
          </template>

          <div class="results-grid">
            <template x-for="(group, idx) in displayedGroups" :key="idx">
              <div
                class="card item-group-card shadow-sm"
                :class="{ 'expanded': expandedGroups[idx] }"
              >
                <div class="card-body" @click="toggleGroup(idx)">
                  <div
                    class="d-flex justify-content-between align-items-start mb-3"
                  >
                    <div>
                      <h5 class="fw-bold mb-2" x-text="group.item"></h5>
                      <div class="d-flex flex-wrap gap-1">
                        <span
                          class="badge bg-secondary"
                          x-text="group.unit"
                        ></span>
                        <span
                          class="badge bg-info"
                          x-text="group.filteredRecords.length + '件'"
                        ></span>
                      </div>
                    </div>
                    <div class="text-end">
                      <small class="text-muted d-block mb-1"
                        >実行単価レンジ</small
                      >
                      <div
                        class="d-flex align-items-center justify-content-end gap-2"
                      >
                        <span
                          class="fw-bold tabular-nums text-success"
                          x-text="`¥${formatNumber(group.minPrice)}`"
                        ></span>
                        <span class="text-muted">～</span>
                        <span
                          class="fw-bold tabular-nums text-danger"
                          x-text="`¥${formatNumber(group.maxPrice)}`"
                        ></span>
                      </div>
                    </div>
                  </div>

                  <div class="bg-white rounded-3 border overflow-hidden mb-3">
                    <div
                      class="p-2 d-flex align-items-center gap-2 cursor-pointer border-bottom"
                      @click.stop="vendorSectionExpanded[idx] = !vendorSectionExpanded[idx]"
                      style="cursor: pointer"
                    >
                      <svg
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                        class="transition-transform"
                        :class="vendorSectionExpanded[idx] ? 'rotate-90' : ''"
                        style="transition: transform 0.2s"
                      >
                        <polyline points="9 18 15 12 9 6"></polyline>
                      </svg>
                      <svg
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                      </svg>
                      <span class="small fw-semibold text-secondary">
                        業者別 実行単価レンジ（/<span x-text="group.unit"></span
                        >）
                      </span>
                      <span
                        class="badge bg-secondary rounded-pill small ms-auto"
                        x-text="getVendorCount(group) + '社'"
                      ></span>
                    </div>
                    <div
                      class="p-3 transition-collapse"
                      :class="vendorSectionExpanded[idx] ? 'collapse-shown' : 'collapse-hidden'"
                    >
                      <div class="d-flex flex-column gap-2">
                        <template
                          x-for="(vendor, vendorIdx) in getVendorSummary(group)"
                          :key="idx + '-vendor-' + vendorIdx"
                        >
                          <div
                            class="company-summary-item d-flex align-items-center flex-wrap gap-2 p-2 bg-light rounded border"
                          >
                            <div
                              class="company-header d-flex align-items-center gap-2"
                            >
                              <span
                                class="fw-semibold small text-dark"
                                x-text="vendor.name"
                              ></span>
                              <span
                                class="badge bg-secondary rounded-pill small"
                                x-text="vendor.count + '件'"
                              ></span>
                            </div>
                            <div
                              class="company-prices d-flex align-items-center gap-3 ms-auto"
                            >
                              <div class="d-flex align-items-baseline gap-1">
                                <span class="small text-secondary">最小</span>
                                <span
                                  class="small fw-semibold tabular-nums company-price-value min"
                                  x-text="`¥${formatNumber(vendor.min)}`"
                                ></span>
                              </div>
                              <div class="d-flex align-items-baseline gap-1">
                                <span class="small text-secondary">平均</span>
                                <span
                                  class="small fw-semibold tabular-nums text-dark"
                                  x-text="`¥${formatNumber(vendor.avg)}`"
                                ></span>
                              </div>
                              <div class="d-flex align-items-baseline gap-1">
                                <span class="small text-secondary">最大</span>
                                <span
                                  class="small fw-semibold tabular-nums company-price-value max"
                                  x-text="`¥${formatNumber(vendor.max)}`"
                                ></span>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>

                  <div
                    class="d-flex justify-content-center gap-2 align-items-center flex-wrap"
                  >
                    <button
                      class="btn btn-sm btn-outline-secondary"
                      @click.stop="expandedGroups[idx] = !expandedGroups[idx]"
                    >
                      <svg
                        class="icon-inline"
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M3 9h18" />
                        <path d="M9 21V9" />
                      </svg>
                      時系列一覧
                    </button>
                    <button
                      class="btn btn-sm btn-outline-secondary"
                      @click.stop="showChart(idx)"
                    >
                      <svg
                        class="icon-inline"
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <line x1="18" y1="20" x2="18" y2="10" />
                        <line x1="12" y1="20" x2="12" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="14" />
                      </svg>
                      単価推移
                    </button>
                    <button
                      class="btn btn-sm btn-outline-secondary"
                      @click.stop="openDetailModal(idx)"
                    >
                      <svg
                        class="icon-inline"
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                      多角分析
                    </button>
                  </div>
                </div>

                <div
                  class="border-top"
                  x-show="expandedGroups[idx]"
                  x-transition:enter="transition-collapse"
                  x-transition:enter-start="collapse-hidden"
                  x-transition:enter-end="collapse-shown"
                  x-transition:leave="transition-collapse"
                  x-transition:leave-start="collapse-shown"
                  x-transition:leave-end="collapse-hidden"
                >
                  <div class="card-body bg-light">
                    <h6 class="fw-bold text-secondary mb-3">
                      <svg
                        class="icon-inline"
                        width="16"
                        height="16"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                      </svg>
                      見積詳細（発注日の時系列）
                    </h6>
                    <div class="timeline-container">
                      <template
                        x-for="(record, recordIdx) in group.filteredRecords"
                        :key="idx + '-' + recordIdx"
                      >
                        <div class="timeline-item">
                          <div class="timeline-date">
                            <span
                              class="year"
                              x-text="record.orderMonth.split('-')[0]"
                            ></span>
                            <span
                              class="month"
                              x-text="parseInt(record.orderMonth.split('-')[1]) + '月'"
                            ></span>
                          </div>
                          <div class="timeline-dot"></div>
                          <div class="timeline-content">
                            <div
                              class="d-flex justify-content-between align-items-start gap-3"
                            >
                              <div class="flex-grow-1">
                                <div
                                  class="d-flex align-items-center gap-1 flex-wrap mb-2"
                                >
                                  <span
                                    class="badge bg-info"
                                    x-text="record.region"
                                  ></span>
                                  <span
                                    class="badge bg-secondary"
                                    x-text="record.majorCode"
                                  ></span>
                                  <span
                                    class="badge bg-light text-dark"
                                    x-text="record.floors + '階'"
                                  ></span>
                                  <span
                                    class="badge bg-light text-dark"
                                    x-text="record.unitRow + '戸並'"
                                  ></span>
                                  <span
                                    class="badge bg-light text-dark"
                                    x-text="record.resUnits + '戸'"
                                  ></span>
                                </div>
                                <div
                                  class="fw-semibold small text-dark"
                                  x-text="record.projectName"
                                ></div>
                              </div>
                              <div class="text-end">
                                <div
                                  class="fs-6 fw-bold text-primary tabular-nums"
                                  x-text="`¥${formatNumber(record.price)}`"
                                ></div>
                                <div
                                  class="small text-secondary"
                                  x-text="`/${record.unit}`"
                                ></div>
                              </div>
                            </div>
                            <div class="detail-grid">
                              <div class="detail-item">
                                <div class="detail-label">業者</div>
                                <div
                                  class="detail-value"
                                  x-text="record.vendor"
                                ></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">実行数量</div>
                                <div
                                  class="detail-value tabular-nums"
                                  x-text="`${formatNumber(record.qty)} ${record.unit}`"
                                ></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">施工面積</div>
                                <div
                                  class="detail-value tabular-nums"
                                  x-text="`${formatNumber(record.constArea)} ㎡`"
                                ></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">延床面積</div>
                                <div
                                  class="detail-value tabular-nums"
                                  x-text="`${formatNumber(record.totalArea)} ㎡`"
                                ></div>
                              </div>
                              <div class="detail-item">
                                <div class="detail-label">実行金額</div>
                                <div
                                  class="detail-value tabular-nums highlight"
                                  x-text="`¥${formatNumber(record.amount)}`"
                                ></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                    <div
                      class="text-center mt-3 pt-3 border-top cursor-pointer"
                      @click.stop="toggleGroup(idx)"
                    >
                      <small class="text-muted">
                        <svg
                          class="icon-inline-sm"
                          width="16"
                          height="16"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          viewBox="0 0 24 24"
                        >
                          <polyline points="18 15 12 9 6 15" />
                        </svg>
                        クリックして閉じる
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- Load More Button -->
          <template x-if="hasMoreGroups">
            <div class="text-center py-4">
              <button
                class="btn btn-outline-primary btn-lg"
                @click="loadMoreGroups()"
              >
                <svg
                  class="icon-inline me-2"
                  width="16"
                  height="16"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <polyline points="6 9 12 15 18 9" />
                </svg>
                さらに表示
                <span
                  class="badge bg-primary ms-2"
                  x-text="Math.min(displayLimit, remainingGroupsCount) + '件'"
                ></span>
              </button>
              <p class="text-muted small mt-2">
                <span x-text="displayedCount"></span> /
                <span x-text="filteredGroups.length"></span> 件表示中
              </p>
            </div>
          </template>
        </div>

        <!-- Chart Modal (inside x-data scope) -->
        <div
          class="modal fade"
          id="chartModal"
          tabindex="-1"
          x-ref="chartModal"
        >
          <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
              <!-- Header -->
              <div class="modal-header">
                <h5 class="modal-title fw-bold">
                  <svg
                    class="icon-inline me-2"
                    width="20"
                    height="20"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <line x1="18" y1="20" x2="18" y2="10" />
                    <line x1="12" y1="20" x2="12" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="14" />
                  </svg>
                  単価推移 -
                  <span x-text="chartData.item"></span>
                  <small
                    class="text-muted ms-2"
                    x-text="`(${chartData.unit})`"
                  ></small>
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                ></button>
              </div>

              <!-- Control Bar -->
              <div class="bg-light border-bottom p-3">
                <div class="row g-3">
                  <!-- Chart View Card -->
                  <div class="col-12 col-md-6 col-lg-4">
                    <div
                      class="card h-100 cursor-pointer"
                      :class="chartData.displayMode === 'chart' ? 'border-primary shadow-sm' : 'border-secondary'"
                      @click="setChartDisplayMode('chart')"
                    >
                      <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center gap-2">
                          <div
                            class="rounded-circle d-flex align-items-center justify-content-center"
                            :class="chartData.displayMode === 'chart' ? 'bg-primary text-white' : 'bg-secondary text-white'"
                            style="width: 28px; height: 28px"
                          >
                            <svg
                              width="14"
                              height="14"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              viewBox="0 0 24 24"
                            >
                              <line x1="18" y1="20" x2="18" y2="10" />
                              <line x1="12" y1="20" x2="12" y2="4" />
                              <line x1="6" y1="20" x2="6" y2="14" />
                            </svg>
                          </div>
                          <span
                            class="fw-semibold"
                            :class="chartData.displayMode === 'chart' ? 'text-primary' : 'text-secondary'"
                            >チャート表示</span
                          >
                          <span
                            x-show="chartData.displayMode === 'chart'"
                            class="badge bg-primary ms-auto"
                            >選択中</span
                          >
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Table View Card -->
                  <div class="col-12 col-md-6 col-lg-4">
                    <div
                      class="card h-100 cursor-pointer"
                      :class="chartData.displayMode === 'table' ? 'border-primary shadow-sm' : 'border-secondary'"
                      @click="setChartDisplayMode('table')"
                    >
                      <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center gap-2">
                          <div
                            class="rounded-circle d-flex align-items-center justify-content-center"
                            :class="chartData.displayMode === 'table' ? 'bg-primary text-white' : 'bg-secondary text-white'"
                            style="width: 28px; height: 28px"
                          >
                            <svg
                              width="14"
                              height="14"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              viewBox="0 0 24 24"
                            >
                              <line x1="8" y1="6" x2="21" y2="6" />
                              <line x1="8" y1="12" x2="21" y2="12" />
                              <line x1="8" y1="18" x2="21" y2="18" />
                              <line x1="3" y1="6" x2="3.01" y2="6" />
                              <line x1="3" y1="12" x2="3.01" y2="12" />
                              <line x1="3" y1="18" x2="3.01" y2="18" />
                            </svg>
                          </div>
                          <span
                            class="fw-semibold"
                            :class="chartData.displayMode === 'table' ? 'text-primary' : 'text-secondary'"
                            >テーブル表示</span
                          >
                          <span
                            x-show="chartData.displayMode === 'table'"
                            class="badge bg-primary ms-auto"
                            >選択中</span
                          >
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Summary Stats -->
                  <div
                    class="col-12 col-lg-4 d-flex align-items-center justify-content-lg-end"
                  >
                    <div class="d-flex gap-3 align-items-center flex-wrap">
                      <span
                        class="badge bg-info fs-6"
                        x-text="chartData.records.length + '件'"
                      ></span>
                      <div class="d-flex gap-2 align-items-center">
                        <small class="text-muted">最小:</small>
                        <span
                          class="fw-semibold text-success"
                          x-text="`¥${formatNumber(chartData.minPrice)}`"
                        ></span>
                      </div>
                      <div class="d-flex gap-2 align-items-center">
                        <small class="text-muted">平均:</small>
                        <span
                          class="fw-semibold text-primary"
                          x-text="`¥${formatNumber(chartData.avgPrice)}`"
                        ></span>
                      </div>
                      <div class="d-flex gap-2 align-items-center">
                        <small class="text-muted">最大:</small>
                        <span
                          class="fw-semibold text-danger"
                          x-text="`¥${formatNumber(chartData.maxPrice)}`"
                        ></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Modal Body -->
              <div class="modal-body">
                <!-- Chart View -->
                <div x-show="chartData.displayMode === 'chart'">
                  <div class="chart-scroll-container">
                    <div class="chart-wrapper" x-ref="chartWrapper">
                      <canvas x-ref="netPriceChart"></canvas>
                    </div>
                  </div>
                </div>

                <!-- Table View -->
                <div x-show="chartData.displayMode === 'table'">
                  <div
                    class="table-responsive"
                    style="max-height: calc(100vh - 280px); overflow: auto"
                  >
                    <table
                      class="table table-sm table-bordered table-hover mb-0"
                      style="min-width: 1400px; table-layout: fixed"
                    >
                      <thead class="table-light sticky-top">
                        <tr>
                          <th style="width: 100px">発注日</th>
                          <th style="width: 70px">支店</th>
                          <th style="width: 60px">大工事</th>
                          <th style="width: 220px">工事名称</th>
                          <th style="width: 150px">仕様</th>
                          <th style="width: 180px">業者</th>
                          <th style="width: 55px" class="text-center">階数</th>
                          <th style="width: 55px" class="text-center">戸並</th>
                          <th style="width: 55px" class="text-center">戸数</th>
                          <th style="width: 100px" class="text-end">
                            施工面積
                          </th>
                          <th style="width: 100px" class="text-end">
                            延床面積
                          </th>
                          <th style="width: 85px" class="text-end">実行数量</th>
                          <th style="width: 100px" class="text-end">
                            実行単価
                          </th>
                          <th style="width: 110px" class="text-end">
                            実行金額
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        <template
                          x-for="record in chartData.records"
                          :key="record.id"
                        >
                          <tr>
                            <td
                              class="text-nowrap"
                              x-text="record.orderDateFormatted"
                            ></td>
                            <td>
                              <span
                                class="badge bg-info"
                                x-text="record.region"
                              ></span>
                            </td>
                            <td>
                              <span
                                class="badge bg-secondary"
                                x-text="record.majorCode"
                              ></span>
                            </td>
                            <td
                              class="text-truncate"
                              style="max-width: 220px"
                              x-text="record.projectName"
                              :title="record.projectName"
                            ></td>
                            <td
                              class="text-muted small text-truncate"
                              style="max-width: 150px"
                              x-text="record.spec || '-'"
                              :title="record.spec"
                            ></td>
                            <td
                              class="text-truncate"
                              style="max-width: 180px"
                              x-text="record.vendor"
                              :title="record.vendor"
                            ></td>
                            <td
                              class="text-center tabular-nums"
                              x-text="record.floors + '階'"
                            ></td>
                            <td
                              class="text-center tabular-nums"
                              x-text="record.unitRow + '戸'"
                            ></td>
                            <td
                              class="text-center tabular-nums"
                              x-text="record.resUnits + '戸'"
                            ></td>
                            <td
                              class="text-end tabular-nums text-nowrap"
                              x-text="`${formatNumber(record.constArea)} ㎡`"
                            ></td>
                            <td
                              class="text-end tabular-nums text-nowrap"
                              x-text="`${formatNumber(record.totalArea)} ㎡`"
                            ></td>
                            <td
                              class="text-end tabular-nums"
                              x-text="formatNumber(record.qty)"
                            ></td>
                            <td
                              class="text-end tabular-nums text-nowrap"
                              x-text="`¥${formatNumber(record.price)}`"
                            ></td>
                            <td
                              class="text-end tabular-nums text-nowrap fw-semibold"
                              x-text="`¥${formatNumber(record.amount)}`"
                            ></td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  閉じる
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Detail Analysis Modal -->
        <div
          class="modal fade"
          id="detailModal"
          tabindex="-1"
          x-ref="detailModal"
          @hidden.bs.modal="closeDetailModal()"
        >
          <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
              <!-- Header -->
              <div class="modal-header">
                <h5 class="modal-title fw-bold">
                  <svg
                    class="icon-inline me-2"
                    width="20"
                    height="20"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                  </svg>
                  多角分析 -
                  <span x-text="detailModal.currentGroup?.item"></span>
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                ></button>
              </div>

              <!-- Control Bar - Card-based Grouping -->
              <div class="bg-light border-bottom p-3">
                <div class="row g-3">
                  <!-- List View Card -->
                  <div class="col-12 col-md-6 col-lg-5">
                    <div
                      class="card h-100 cursor-pointer"
                      :class="detailModal.displayMode === 'list' ? 'border-primary shadow-sm' : 'border-secondary'"
                      @click="setDetailDisplayMode('list')"
                    >
                      <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center gap-2 mb-2">
                          <div
                            class="rounded-circle d-flex align-items-center justify-content-center"
                            :class="detailModal.displayMode === 'list' ? 'bg-primary text-white' : 'bg-secondary text-white'"
                            style="width: 28px; height: 28px"
                          >
                            <svg
                              width="14"
                              height="14"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              viewBox="0 0 24 24"
                            >
                              <line x1="8" y1="6" x2="21" y2="6" />
                              <line x1="8" y1="12" x2="21" y2="12" />
                              <line x1="8" y1="18" x2="21" y2="18" />
                              <line x1="3" y1="6" x2="3.01" y2="6" />
                              <line x1="3" y1="12" x2="3.01" y2="12" />
                              <line x1="3" y1="18" x2="3.01" y2="18" />
                            </svg>
                          </div>
                          <span
                            class="fw-semibold"
                            :class="detailModal.displayMode === 'list' ? 'text-primary' : 'text-secondary'"
                            >リスト表示</span
                          >
                          <span
                            x-show="detailModal.displayMode === 'list'"
                            class="badge bg-primary ms-auto"
                            >選択中</span
                          >
                        </div>
                        <div
                          class="d-flex align-items-center gap-2"
                          @click.stop
                        >
                          <label class="form-label small mb-0 text-muted"
                            >グループ:</label
                          >
                          <select
                            class="form-select form-select-sm"
                            style="width: auto"
                            x-model="detailModal.groupBy"
                            :disabled="detailModal.displayMode !== 'list'"
                          >
                            <option value="timeline">時系列</option>
                            <option value="majorCode">大工事項目別</option>
                            <option value="region">支店別</option>
                            <option value="building">建物情報別</option>
                            <option value="vendor">業者別</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Chart View Card -->
                  <div class="col-12 col-md-6 col-lg-5">
                    <div
                      class="card h-100 cursor-pointer"
                      :class="detailModal.displayMode === 'chart' ? 'border-primary shadow-sm' : 'border-secondary'"
                      @click="setDetailDisplayMode('chart')"
                    >
                      <div class="card-body py-2 px-3">
                        <div
                          class="d-flex align-items-center gap-2 mb-2"
                          @click="setDetailDisplayMode('chart')"
                          style="cursor: pointer"
                        >
                          <div
                            class="rounded-circle d-flex align-items-center justify-content-center"
                            :class="detailModal.displayMode === 'chart' ? 'bg-primary text-white' : 'bg-secondary text-white'"
                            style="width: 28px; height: 28px"
                          >
                            <svg
                              width="14"
                              height="14"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              viewBox="0 0 24 24"
                            >
                              <line x1="18" y1="20" x2="18" y2="10" />
                              <line x1="12" y1="20" x2="12" y2="4" />
                              <line x1="6" y1="20" x2="6" y2="14" />
                            </svg>
                          </div>
                          <span
                            class="fw-semibold"
                            :class="detailModal.displayMode === 'chart' ? 'text-primary' : 'text-secondary'"
                            >チャート表示</span
                          >
                          <span
                            x-show="detailModal.displayMode === 'chart'"
                            class="badge bg-primary ms-auto"
                            >選択中</span
                          >
                        </div>
                        <div
                          class="d-flex flex-wrap align-items-center gap-2"
                          @click.stop
                        >
                          <label class="form-label small mb-0 text-muted"
                            >種別:</label
                          >
                          <select
                            class="form-select form-select-sm"
                            style="width: auto"
                            x-model="detailModal.chartType"
                            @change="detailModal.displayMode === 'chart' && renderDetailChart()"
                            :disabled="detailModal.displayMode !== 'chart'"
                          >
                            <option value="trend">単価推移</option>
                            <option value="comparison">グループ比較</option>
                            <option value="distribution">単価分布</option>
                          </select>
                          <template
                            x-if="detailModal.chartType === 'comparison'"
                          >
                            <div class="d-flex align-items-center gap-2">
                              <label class="form-label small mb-0 text-muted"
                                >比較軸:</label
                              >
                              <select
                                class="form-select form-select-sm"
                                style="width: auto"
                                x-model="detailModal.groupBy"
                                @change="detailModal.displayMode === 'chart' && renderDetailChart()"
                                :disabled="detailModal.displayMode !== 'chart'"
                              >
                                <option value="timeline">時系列</option>
                                <option value="majorCode">大工事項目別</option>
                                <option value="region">支店別</option>
                                <option value="building">建物情報別</option>
                                <option value="vendor">業者別</option>
                              </select>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Summary Stats -->
                  <div
                    class="col-12 col-lg-2 d-flex align-items-center justify-content-lg-end"
                  >
                    <div class="d-flex gap-2 align-items-center">
                      <span
                        class="badge bg-info fs-6"
                        x-text="(detailModal.currentGroup?.filteredRecords?.length || 0) + '件'"
                      ></span>
                      <small class="text-muted d-none d-lg-inline">
                        <span
                          class="fw-semibold text-success"
                          x-text="`¥${formatNumber(detailModal.currentGroup?.minPrice)}`"
                        ></span>
                        ~
                        <span
                          class="fw-semibold text-danger"
                          x-text="`¥${formatNumber(detailModal.currentGroup?.maxPrice)}`"
                        ></span>
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Modal Body -->
              <div class="modal-body p-4 bg-body-secondary">
                <!-- List View -->
                <div x-show="detailModal.displayMode === 'list'">
                  <template
                    x-for="(records, key) in getGroupedDetailData()"
                    :key="key"
                  >
                    <div class="mb-4">
                      <!-- Group Header -->
                      <div
                        class="d-flex align-items-center gap-2 mb-2 pb-2 border-bottom"
                      >
                        <h6 class="fw-bold mb-0" x-text="key"></h6>
                        <span
                          class="badge bg-secondary"
                          x-text="records.length + '件'"
                        ></span>
                        <span class="ms-auto small text-muted">
                          平均:
                          <span
                            class="fw-semibold"
                            x-text="`¥${formatNumber(calcPriceStats(records.map(r => r.price)).avg)}`"
                          ></span>
                        </span>
                      </div>
                      <!-- Group Table -->
                      <div class="card shadow-sm">
                        <div class="table-responsive">
                          <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                              <tr>
                                <th>発注日</th>
                                <th>支店</th>
                                <th>工事名称</th>
                                <th>業者</th>
                                <th>建物情報</th>
                                <th class="text-end">実行単価</th>
                              </tr>
                            </thead>
                            <tbody>
                              <template
                                x-for="(r, rIdx) in records"
                                :key="key + '-' + rIdx"
                              >
                                <tr>
                                  <td x-text="r.orderDateFormatted"></td>
                                  <td>
                                    <span
                                      class="badge bg-info"
                                      x-text="r.region"
                                    ></span>
                                  </td>
                                  <td
                                    class="text-truncate"
                                    style="max-width: 200px"
                                    x-text="r.projectName"
                                  ></td>
                                  <td x-text="r.vendor"></td>
                                  <td
                                    x-text="`${r.floors}階/${r.resUnits}戸`"
                                  ></td>
                                  <td
                                    class="text-end fw-bold text-primary tabular-nums"
                                    x-text="'¥' + formatNumber(r.price)"
                                  ></td>
                                </tr>
                              </template>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </template>

                  <!-- Load More Button for Detail List -->
                  <template x-if="hasMoreDetailRecords">
                    <div class="text-center py-4">
                      <button
                        class="btn btn-outline-primary"
                        @click="loadMoreDetailRecords()"
                      >
                        <svg
                          class="icon-inline me-2"
                          width="16"
                          height="16"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          viewBox="0 0 24 24"
                        >
                          <polyline points="6 9 12 15 18 9" />
                        </svg>
                        さらに表示
                        <span
                          class="badge bg-primary ms-2"
                          x-text="Math.min(detailModal.listLimit, remainingDetailRecords) + '件'"
                        ></span>
                      </button>
                      <p class="text-muted small mt-2">
                        <span x-text="detailModal.listDisplayed"></span> /
                        <span x-text="detailTotalRecords"></span> 件表示中
                      </p>
                    </div>
                  </template>
                </div>

                <!-- Chart View -->
                <div x-show="detailModal.displayMode === 'chart'" x-transition>
                  <div class="card shadow-sm">
                    <div class="card-body">
                      <div class="detail-chart-container">
                        <canvas x-ref="detailChart"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Footer -->
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  閉じる
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- External Libraries with defer for non-blocking -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/js/bootstrap.min.js"
      integrity="sha256-ew8UiV1pJH/YjpOEBInP1HxVvT/SfrCmwSoUzF9JIgc="
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"
    ></script>
    <script
      defer
      src="https://unpkg.com/dexie@4/dist/dexie.min.js"
    ></script>

    <!-- Application Scripts (load order matters) -->
    <script defer src="js/utils.js"></script>
    <script defer src="js/db.js"></script>
    <script defer src="js/data-loader.js"></script>
    <script defer src="js/app.js"></script>

    <!-- Alpine.js (must be loaded after app scripts) -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.3/dist/cdn.min.js"
    ></script>
  </body>
</html>

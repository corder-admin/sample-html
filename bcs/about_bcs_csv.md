# BCS.CSV形式 技術仕様書

## 概要

BCS（Building Construction Standard）は、建設工事の内訳書データを異なるソフトウェア間で交換するための日本の標準CSVフォーマットである。最大7階層のツリー構造で工事項目を表現する。

- **文字コード**: Shift-JIS（CP932）
- **区切り文字**: カンマ（,）
- **最大階層数**: 7

---

## カラム定義（19項目）

| No. | 項目名     | バイト数 | 形式          | 説明                             |
| --- | ---------- | -------- | ------------- | -------------------------------- |
| 1   | 階層1      | 4        | 整数          | ツリー構造の第1階層位置          |
| 2   | 階層2      | 4        | 整数          | ツリー構造の第2階層位置          |
| 3   | 階層3      | 4        | 整数          | ツリー構造の第3階層位置          |
| 4   | 階層4      | 4        | 整数          | ツリー構造の第4階層位置          |
| 5   | 階層5      | 4        | 整数          | ツリー構造の第5階層位置          |
| 6   | 階層6      | 4        | 整数          | ツリー構造の第6階層位置          |
| 7   | 階層7      | 4        | 整数          | ツリー構造の第7階層位置          |
| 8   | 層番号     | 1        | 整数          | 現在の階層深さ（1〜7）           |
| 9   | 通番号     | 4        | 整数          | 同一階層内の連番                 |
| 10  | 行種       | 1        | 文字列        | 行の種類（D/A/P/Q/B/E/N/S/T）    |
| 11  | 下段\_名称 | 32       | 文字列        | 項目名称                         |
| 12  | 下段\_仕様 | 30       | 文字列        | 仕様・規格                       |
| 13  | 数量       | 10       | 小数点以下3位 | 数量                             |
| 14  | 単位       | 4        | 文字列        | 単位（m3, ㎡, 式 など）          |
| 15  | 単価       | 12       | 整数          | 単価（マイナス値で値引き表現可） |
| 16  | 下段\_備考 | 16       | 文字列        | 備考欄                           |
| 17  | 上段\_名称 | 32       | 文字列        | 上段の名称（2段表示用）          |
| 18  | 上段\_仕様 | 30       | 文字列        | 上段の仕様                       |
| 19  | 上段\_備考 | 16       | 文字列        | 上段の備考                       |

---

## 行種（10列目）の定義

| コード | 名称           | 説明                                              | 通番号 | 数量・単価 |
| ------ | -------------- | ------------------------------------------------- | ------ | ---------- |
| D      | 通常行         | 実際の作業・材料の明細行                          | あり   | あり       |
| A      | 補助行         | 通常行の補助（仕様が複数行の場合の2行目以降）     | あり   | なし       |
| P      | 親行           | 種目・科目・中科目等の親。子のT行から金額を受取る | なし   | あり       |
| Q      | 代価親行       | 代価の親行。全階層印刷後に子明細を印刷            | なし   | あり       |
| B      | 別紙親行       | 別紙の親行。自階層印刷後に子明細を印刷            | なし   | あり       |
| E      | エレメント親行 | エレメントの親行。親行直後に子明細を印刷          | なし   | あり       |
| N      | QBE計行        | Q/B/E に対する計行                                | なし   | なし       |
| S      | 小計行         | 科目等の先頭〜S行までの金額のくくり               | なし   | なし       |
| T      | 合計行         | 科目等の合計。親行（P）の単価欄に金額を通知       | なし   | なし       |

---

## 階層構造の理解

### 階層1〜7と層番号の関係

- **階層1〜7**: ツリー上の「位置」を示す番号。使用する階層にのみ値が入る
- **層番号**: 現在の「深さ」を示す（1〜7）。階層1〜7のうち、いくつ使っているかを表す
- **通番号**: 同じ親の下での連番。P行・T行では空

### 層番号と使用階層の対応

| 層番号 | 使用する階層          | 典型的な用途                       |
| ------ | --------------------- | ---------------------------------- |
| なし   | 階層1のみ             | 工事全体（ルートP行、最終T行）     |
| 1      | 階層1                 | 大分類（建築工事、電気設備工事等） |
| 2      | 階層1 + 階層2         | 中分類（土工事、杭工事等）         |
| 3      | 階層1 + 階層2 + 階層3 | 明細（根切、残土処分等）           |
| 4〜7   | 階層1〜該当階層       | さらに細かい分類                   |

---

## データ構造例

### ツリー構造とCSV行の対応

```text
工事全体（ルート）
├── 共通仮設工事（P行）
│   ├── 仮設建物（D行）
│   ├── 工事施設（D行）
│   └── 共通仮設工事【計】（T行）
├── 建築工事（P行）
│   ├── 土工事（P行）
│   │   ├── 根切（D行）
│   │   ├── 残土処分（D行）
│   │   ├── 埋戻（D行）
│   │   └── 土工事【計】（T行）
│   └── 建築工事【計】（T行）
└── 工事全体【総計】（T行）
```

### 実際のCSVデータ例

```csv
階層1,階層2,階層3,階層4,階層5,階層6,階層7,層番号,通番号,行種,下段_名称,下段_仕様,数量,単位,単価,下段_備考,上段_名称,上段_仕様,上段_備考
1,,,,,,,,,P,（仮称）協栄ビル新築工事,,1,式,95847000,,,,
2,,,,,,,1,,P,共通仮設工事,,1,式,6430000,,,,
2,,,,,,,2,1,D,仮設建物,,1,式,200000,,,,
2,,,,,,,2,2,D,工事施設,,1,式,650000,,,,
2,,,,,,,2,,T,共通仮設工事,,,,,,,,,
3,,,,,,,1,,P,建築工事,,1,式,52592000,,,,
3,2,,,,,,2,,P,土工事,,1,式,4688000,,,,
3,2,,,,,,3,1,D,根切,機械,206,m3,1100,,,,
3,2,,,,,,3,2,D,残土処分,,350,m3,3300,,,,
3,2,,,,,,3,3,D,埋戻,購入土,50,m3,3850,,,,
3,2,,,,,,3,9,D,値引,,1,式,-200,,,,
3,2,,,,,,3,,T,土工事,,,,,,,,,
1,,,,,,,,,T,（仮称）協栄ビル新築工事,,,,,,,,,
```

### 行別解説

| 行  | 階層1 | 階層2 | 層番号 | 通番号 | 行種 | 名称             | 説明               |
| --- | ----- | ----- | ------ | ------ | ---- | ---------------- | ------------------ |
| 1   | 1     | -     | -      | -      | P    | 協栄ビル新築工事 | ルート親行         |
| 2   | 2     | -     | 1      | -      | P    | 共通仮設工事     | 大分類の親行       |
| 3   | 2     | -     | 2      | 1      | D    | 仮設建物         | 明細1行目          |
| 4   | 2     | -     | 2      | 2      | D    | 工事施設         | 明細2行目          |
| 5   | 2     | -     | 2      | -      | T    | 共通仮設工事     | 共通仮設の合計     |
| 6   | 3     | -     | 1      | -      | P    | 建築工事         | 大分類の親行       |
| 7   | 3     | 2     | 2      | -      | P    | 土工事           | 中分類の親行       |
| 8   | 3     | 2     | 3      | 1      | D    | 根切             | 土工事の明細1      |
| 9   | 3     | 2     | 3      | 2      | D    | 残土処分         | 土工事の明細2      |
| 10  | 3     | 2     | 3      | 3      | D    | 埋戻             | 土工事の明細3      |
| 11  | 3     | 2     | 3      | 9      | D    | 値引             | マイナス単価で値引 |
| 12  | 3     | 2     | 3      | -      | T    | 土工事           | 土工事の合計       |
| 13  | 1     | -     | -      | -      | T    | 協栄ビル新築工事 | 最終総計行         |

---

## パース時の重要ルール

### 1. 階層の特定方法

- 層番号が示す数だけ、階層1から順に値が入っている
- 例: 層番号=3 → 階層1, 階層2, 階層3 に値あり、階層4〜7は空

### 2. 親子関係の判定

- 同じ階層1〜N値を持ち、層番号が1つ大きい行が子
- T行は対応するP行の子として、合計を通知

### 3. 金額計算

- 金額 = 数量 × 単価
- T行の金額 = 同一親配下のD行金額の合計
- P行の単価 = 対応するT行から受け取った金額

### 4. 値引きの表現

- 単価をマイナス値にして表現
- 例: 単価=-200 で200円の値引き

### 5. 空値の扱い

- 未使用の階層は空（カンマのみ）
- P行・T行の通番号は空
- T行の数量・単位・単価は空

---

## 行種別の必須項目

| 行種      | 名称  | 仕様  | 数量  | 単位  | 単価  |
| --------- | ----- | ----- | ----- | ----- | ----- |
| D（通常） | ○必須 | △任意 | ○必須 | ○必須 | ○必須 |
| A（補助） | △任意 | △任意 | ×なし | ×なし | ×なし |
| P（親）   | ○必須 | △任意 | ○必須 | ○必須 | ○必須 |
| T（合計） | ○必須 | ×なし | ×なし | ×なし | ×なし |
| S（小計） | ○必須 | ×なし | ×なし | ×なし | ×なし |

---

## 典型的な構造パターン

```text
P（親行）層番号=N
  ├── D（通常行）層番号=N+1, 通番号=1
  ├── D（通常行）層番号=N+1, 通番号=2
  ├── D（通常行）層番号=N+1, 通番号=3
  └── T（合計行）層番号=N+1, 通番号=なし
```

親行（P）の下に複数の通常行（D）があり、最後に合計行（T）で締める構造が基本パターン。

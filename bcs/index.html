<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BCS.CSV Viewer</title>
    <link
      href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
    <style>
      :root {
        --primary: #2563eb;
        --secondary: #10b981;
        --accent: #f59e0b;
        --purple: #8b5cf6;
        --pink: #ec4899;
        --red: #ef4444;
        --bg: #0f172a;
        --card: #1e293b;
        --text: #e2e8f0;
        --border: #334155;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Noto Sans JP", sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
      }

      .header {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        padding: 20px;
        text-align: center;
      }

      .header h1 {
        font-family: "M PLUS Rounded 1c", sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .input-section {
        background: var(--card);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .input-section label {
        display: block;
        margin-bottom: 10px;
        font-weight: 700;
        color: var(--accent);
      }

      .input-methods {
        margin-bottom: 15px;
      }

      .file-upload-area {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 30px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(37, 99, 235, 0.05);
      }

      .file-upload-area:hover,
      .file-upload-area.dragover {
        border-color: var(--primary);
        background: rgba(37, 99, 235, 0.15);
      }

      .upload-icon {
        font-size: 2.5rem;
        display: block;
        margin-bottom: 10px;
      }

      .upload-main {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 8px;
      }

      .upload-sub {
        color: #94a3b8;
        font-size: 0.9rem;
      }

      .upload-hint {
        color: #64748b;
        font-size: 0.8rem;
        margin-top: 10px;
      }

      .btn-link {
        background: none;
        border: none;
        color: var(--primary);
        text-decoration: underline;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .btn-link:hover {
        color: #60a5fa;
      }

      .divider {
        display: flex;
        align-items: center;
        margin: 20px 0;
        color: #64748b;
        font-size: 0.85rem;
      }

      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--border);
      }

      .divider span {
        padding: 0 15px;
      }

      .file-info {
        margin-top: 10px;
        padding: 10px 15px;
        background: rgba(16, 185, 129, 0.15);
        border-radius: 8px;
        color: #34d399;
        font-size: 0.9rem;
        display: none;
      }

      .file-info.show {
        display: block;
      }

      .input-section textarea {
        width: 100%;
        height: 200px;
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-family: "Courier New", monospace;
        font-size: 0.85rem;
        padding: 15px;
        resize: vertical;
      }

      .input-section textarea:focus {
        outline: none;
        border-color: var(--primary);
      }

      .btn-row {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .btn-secondary {
        background: var(--border);
        color: var(--text);
      }

      .btn-secondary:hover {
        background: #475569;
      }

      .btn-sample {
        background: var(--secondary);
        color: white;
      }

      .btn-sample:hover {
        background: #059669;
      }

      .output-section {
        background: var(--card);
        border-radius: 12px;
        padding: 20px;
      }

      .output-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .output-header h2 {
        font-size: 1.1rem;
        color: var(--accent);
      }

      .stats {
        display: flex;
        gap: 15px;
        font-size: 0.85rem;
        color: #94a3b8;
      }

      .tree-container {
        background: var(--bg);
        border-radius: 8px;
        padding: 20px;
        overflow-x: auto;
        min-height: 300px;
        max-height: 600px;
        overflow-y: auto;
      }

      .tree-node {
        margin: 2px 0;
        white-space: nowrap;
      }

      .tree-row {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .tree-row:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .tree-row.collapsed > .tree-children {
        display: none;
      }

      .tree-toggle {
        width: 18px;
        height: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--border);
        border-radius: 4px;
        font-size: 0.7rem;
        color: #94a3b8;
        flex-shrink: 0;
      }

      .tree-toggle.empty {
        visibility: hidden;
      }

      .type-badge {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        border-radius: 4px;
        font-weight: 700;
        font-size: 0.8rem;
        color: white;
        flex-shrink: 0;
      }

      .type-D {
        background: var(--primary);
      }
      .type-A {
        background: #6b7280;
      }
      .type-P {
        background: var(--accent);
      }
      .type-Q {
        background: var(--purple);
      }
      .type-B {
        background: var(--pink);
      }
      .type-E {
        background: #14b8a6;
      }
      .type-N {
        background: #8b5cf6;
      }
      .type-S {
        background: #f97316;
      }
      .type-T {
        background: var(--red);
      }

      .node-name {
        font-weight: 700;
        color: #f1f5f9;
      }

      .node-spec {
        color: #94a3b8;
        font-size: 0.9rem;
      }

      .node-qty {
        color: #22d3ee;
        font-size: 0.85rem;
      }

      .node-price {
        color: #fb923c;
        font-size: 0.85rem;
        font-weight: 700;
      }

      .node-price.negative {
        color: #f87171;
      }

      .tree-children {
        margin-left: 24px;
        border-left: 2px solid var(--border);
        padding-left: 12px;
      }

      .level-0 .tree-row {
        background: rgba(220, 38, 38, 0.15);
      }
      .level-1 .tree-row {
        background: rgba(37, 99, 235, 0.15);
      }
      .level-2 .tree-row {
        background: rgba(5, 150, 105, 0.15);
      }
      .level-3 .tree-row {
        background: rgba(124, 58, 237, 0.12);
      }
      .level-4 .tree-row {
        background: rgba(236, 72, 153, 0.12);
      }
      .level-5 .tree-row {
        background: rgba(20, 184, 166, 0.12);
      }
      .level-6 .tree-row {
        background: rgba(249, 115, 22, 0.12);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
      }

      .empty-state p {
        margin: 10px 0;
      }

      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border);
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: #94a3b8;
      }

      .error-msg {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid var(--red);
        color: #fca5a5;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }
        .input-section textarea {
          height: 150px;
        }
        .tree-container {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>ğŸ“„ BCS.CSV Viewer</h1>
    </header>

    <div class="container">
      <section class="input-section">
        <div class="input-methods">
          <div class="file-upload-area" id="dropZone">
            <input type="file" id="fileInput" accept=".csv,.txt" hidden />
            <div class="upload-content">
              <span class="upload-icon">ğŸ“</span>
              <p class="upload-main">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
              <p class="upload-sub">
                ã¾ãŸã¯
                <button
                  class="btn-link"
                  onclick="document.getElementById('fileInput').click()"
                >
                  ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </button>
              </p>
              <p class="upload-hint">BCS.CSVï¼ˆShift-JIS / UTF-8 å¯¾å¿œï¼‰</p>
            </div>
          </div>
          <div class="divider"><span>ã¾ãŸã¯</span></div>
          <label for="csvInput">ğŸ“‹ CSVãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥è²¼ã‚Šä»˜ã‘</label>
        </div>
        <textarea
          id="csvInput"
          placeholder="BCS.CSVå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."
        ></textarea>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="parseCSV()">
            ğŸŒ³ ãƒ„ãƒªãƒ¼è¡¨ç¤º
          </button>
          <button class="btn btn-secondary" onclick="clearAll()">
            ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
          </button>
          <button class="btn btn-sample" onclick="loadSample()">
            ğŸ“¥ ã‚µãƒ³ãƒ—ãƒ«èª­è¾¼
          </button>
        </div>
        <div class="file-info" id="fileInfo"></div>
      </section>

      <section class="output-section">
        <div class="output-header">
          <h2>ğŸŒ³ ãƒ„ãƒªãƒ¼ãƒ“ãƒ¥ãƒ¼</h2>
          <div class="stats" id="stats"></div>
        </div>
        <div id="errorMsg"></div>
        <div class="tree-container" id="treeContainer">
          <div class="empty-state">
            <p>ğŸ“„ CSVãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œãƒ„ãƒªãƒ¼è¡¨ç¤ºã€ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
            <p>ã¾ãŸã¯ã€Œã‚µãƒ³ãƒ—ãƒ«èª­è¾¼ã€ã§ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</p>
          </div>
        </div>
        <div class="legend">
          <div class="legend-item">
            <span class="type-badge type-P">P</span> è¦ªè¡Œ
          </div>
          <div class="legend-item">
            <span class="type-badge type-D">D</span> é€šå¸¸è¡Œ
          </div>
          <div class="legend-item">
            <span class="type-badge type-A">A</span> è£œåŠ©è¡Œ
          </div>
          <div class="legend-item">
            <span class="type-badge type-T">T</span> åˆè¨ˆè¡Œ
          </div>
          <div class="legend-item">
            <span class="type-badge type-S">S</span> å°è¨ˆè¡Œ
          </div>
          <div class="legend-item">
            <span class="type-badge type-Q">Q</span> ä»£ä¾¡è¦ª
          </div>
          <div class="legend-item">
            <span class="type-badge type-B">B</span> åˆ¥ç´™è¦ª
          </div>
          <div class="legend-item">
            <span class="type-badge type-E">E</span> ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ
          </div>
          <div class="legend-item">
            <span class="type-badge type-N">N</span> QBEè¨ˆ
          </div>
        </div>
      </section>
    </div>

    <script>
      // ========================================
      // å®šæ•°å®šç¾©
      // ========================================
      const BCS_ROW_TYPES = {
        DETAIL: 'D',      // é€šå¸¸è¡Œ
        ASSIST: 'A',      // è£œåŠ©è¡Œ
        PARENT: 'P',      // è¦ªè¡Œ
        QUOTE: 'Q',       // ä»£ä¾¡è¦ªè¡Œ
        APPENDIX: 'B',    // åˆ¥ç´™è¦ªè¡Œ
        ELEMENT: 'E',     // ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆè¦ªè¡Œ
        QBE_TOTAL: 'N',   // QBEè¨ˆè¡Œ
        SUBTOTAL: 'S',    // å°è¨ˆè¡Œ
        TOTAL: 'T'        // åˆè¨ˆè¡Œ
      };

      const PARENT_TYPES = [
        BCS_ROW_TYPES.PARENT,
        BCS_ROW_TYPES.QUOTE,
        BCS_ROW_TYPES.APPENDIX,
        BCS_ROW_TYPES.ELEMENT
      ];

      const TOTAL_TYPES = [
        BCS_ROW_TYPES.TOTAL,
        BCS_ROW_TYPES.SUBTOTAL
      ];

      const UI_MESSAGES = {
        EMPTY_INPUT: 'ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“',
        INVALID_CSV: 'æœ‰åŠ¹ãªBCS.CSVè¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
        PARSE_FAILED: 'ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ'
      };

      // ========================================
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
      // ========================================
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const fileInfo = document.getElementById("fileInfo");

      // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
      ["dragenter", "dragover", "dragleave", "drop"].forEach((evt) => {
        dropZone.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      ["dragenter", "dragover"].forEach((evt) => {
        dropZone.addEventListener(evt, () =>
          dropZone.classList.add("dragover")
        );
      });

      ["dragleave", "drop"].forEach((evt) => {
        dropZone.addEventListener(evt, () =>
          dropZone.classList.remove("dragover")
        );
      });

      dropZone.addEventListener("drop", (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) handleFile(files[0]);
      });

      dropZone.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
      });

      // ========================================
      // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å‡¦ç† (SRPæº–æ‹ )
      // ========================================

      // ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¤œå‡ºã¨å¤‰æ›
      async function decodeFile(file) {
        const buffer = await file.arrayBuffer();
        const uint8Array = new Uint8Array(buffer);

        const detectedEncoding = Encoding.detect(uint8Array);
        console.log("Detected encoding:", detectedEncoding);

        const unicodeArray = Encoding.convert(uint8Array, {
          to: "UNICODE",
          from: detectedEncoding || "SJIS",
        });

        return {
          text: Encoding.codeToString(unicodeArray),
          encoding: detectedEncoding || "SJIS"
        };
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®UIæ›´æ–°
      function updateFileInfo(fileName, fileSize, encoding) {
        fileInfo.innerHTML = `ğŸ“„ <strong>${fileName}</strong> (${fileSize} KB) ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ <span style="color:#94A3B8">ï¼»${encoding}ï¼½</span>`;
        fileInfo.classList.add("show");
      }

      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      function showError(message) {
        document.getElementById("errorMsg").innerHTML =
          `<div class="error-msg">âš ï¸ ${message}</div>`;
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
      async function handleFile(file) {
        const fileName = file.name;
        const fileSize = (file.size / 1024).toFixed(1);

        try {
          const { text, encoding } = await decodeFile(file);
          document.getElementById("csvInput").value = text;
          updateFileInfo(fileName, fileSize, encoding);
          parseCSV();
        } catch (err) {
          showError(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${err.message}`);
        }
      }

      // CSVãƒ‘ãƒ¼ã‚¹
      function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            result.push(current.trim());
            current = "";
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      }

      // BCSè¡Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
      function createBCSRow(cols) {
        return {
          h1: parseInt(cols[0]) || 0,
          h2: parseInt(cols[1]) || 0,
          h3: parseInt(cols[2]) || 0,
          h4: parseInt(cols[3]) || 0,
          h5: parseInt(cols[4]) || 0,
          h6: parseInt(cols[5]) || 0,
          h7: parseInt(cols[6]) || 0,
          layer: parseInt(cols[7]) || 0,
          seq: parseInt(cols[8]) || 0,
          type: (cols[9] || "").toUpperCase(),
          name: cols[10] || "",
          spec: cols[11] || "",
          qty: parseFloat(cols[12]) || 0,
          unit: cols[13] || "",
          price: parseInt(cols[14]) || 0,
          remark: cols[15] || "",
          upperName: cols[16] || "",
          upperSpec: cols[17] || "",
          upperRemark: cols[18] || "",
          children: [],
        };
      }

      // éšå±¤ã‚­ãƒ¼å–å¾—
      function getHierarchyKey(row, depth) {
        const keys = [row.h1, row.h2, row.h3, row.h4, row.h5, row.h6, row.h7];
        return keys.slice(0, depth).join("-");
      }

      // ========================================
      // é‡‘é¡è¨ˆç®—å‡¦ç† (Strategy Pattern)
      // ========================================

      // åŸºæœ¬é‡‘é¡è¨ˆç®—
      function calculateAmount(row) {
        if (!row.qty || !row.price) return 0;
        return row.qty * row.price;
      }

      // å­è¦ç´ ã®é‡‘é¡åˆè¨ˆã‚’è¨ˆç®—
      function sumChildrenAmount(node) {
        if (!node.children || node.children.length === 0) {
          return calculateAmount(node);
        }

        return node.children.reduce((total, child) => {
          return total + calculateTotalAmount(child);
        }, 0);
      }

      // å‹åˆ¥é‡‘é¡è¨ˆç®—æˆ¦ç•¥
      const AmountCalculators = {
        [BCS_ROW_TYPES.DETAIL]: (row) => calculateAmount(row),

        [BCS_ROW_TYPES.TOTAL]: (row) => {
          const total = sumChildrenAmount(row);
          row.calculatedAmount = total;
          return 0; // è¦ªã®åˆè¨ˆã«å«ã‚ãªã„(äºŒé‡è¨ˆä¸Šé˜²æ­¢)
        },

        [BCS_ROW_TYPES.SUBTOTAL]: (row) => {
          const total = sumChildrenAmount(row);
          row.calculatedAmount = total;
          return 0; // è¦ªã®åˆè¨ˆã«å«ã‚ãªã„(äºŒé‡è¨ˆä¸Šé˜²æ­¢)
        },

        [BCS_ROW_TYPES.PARENT]: (row) => sumChildrenAmount(row),
        [BCS_ROW_TYPES.QUOTE]: (row) => sumChildrenAmount(row),
        [BCS_ROW_TYPES.APPENDIX]: (row) => sumChildrenAmount(row),
        [BCS_ROW_TYPES.ELEMENT]: (row) => sumChildrenAmount(row),

        [BCS_ROW_TYPES.ASSIST]: () => 0,

        default: (row) => calculateAmount(row)
      };

      // åˆè¨ˆé‡‘é¡ã‚’å†å¸°çš„ã«è¨ˆç®—
      function calculateTotalAmount(node) {
        const calculator = AmountCalculators[node.type] || AmountCalculators.default;
        return calculator(node);
      }

      // ãƒ„ãƒªãƒ¼æ§‹ç¯‰
      function buildTree(rows) {
        const root = { children: [], name: "ROOT", type: "" };
        const stack = [{ node: root, depth: 0, key: "" }];

        for (const row of rows) {
          const depth = row.layer || 1;
          const key = getHierarchyKey(row, depth);

          // é©åˆ‡ãªè¦ªã‚’è¦‹ã¤ã‘ã‚‹
          while (stack.length > 1) {
            const parent = stack[stack.length - 1];
            const parentKey = getHierarchyKey(row, parent.depth);

            if (parent.depth < depth && key.startsWith(parent.key)) {
              break;
            }
            stack.pop();
          }

          const parent = stack[stack.length - 1];
          parent.node.children.push(row);

          // P/Q/B/Eè¡Œã¯å­ã‚’æŒã¦ã‚‹
          if (PARENT_TYPES.includes(row.type)) {
            stack.push({ node: row, depth: depth, key: key });
          }
        }

        // å…¨ãƒãƒ¼ãƒ‰ã®é‡‘é¡ã‚’è¨ˆç®—
        for (const rootNode of root.children) {
          calculateTotalAmount(rootNode);
        }

        return root.children;
      }

      // ========================================
      // ãƒãƒ¼ãƒ‰HTMLç”Ÿæˆ (ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§æ§‹é€ åŒ–)
      // ========================================

      // ãƒˆã‚°ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ
      function createToggleIcon(hasChildren) {
        const className = hasChildren ? '' : 'empty';
        const icon = hasChildren ? 'â–¼' : '';
        return `<span class="tree-toggle ${className}">${icon}</span>`;
      }

      // å‹ãƒãƒƒã‚¸ç”Ÿæˆ
      function createTypeBadge(type) {
        return `<span class="type-badge type-${type}">${type || '?'}</span>`;
      }

      // é‡‘é¡æƒ…å ±ç”Ÿæˆ
      function createAmountInfo(row) {
        const parts = [];

        // æ•°é‡ãƒ»å˜ä½
        if (row.qty) {
          parts.push(`<span class="node-qty">${row.qty}${row.unit}</span>`);
        }

        // å˜ä¾¡
        if (row.price) {
          const priceClass = row.price < 0 ? 'negative' : '';
          parts.push(`<span class="node-price ${priceClass}">@${row.price.toLocaleString()}</span>`);
        }

        // Tè¡Œãƒ»Sè¡Œã®åˆè¨ˆé‡‘é¡
        if (TOTAL_TYPES.includes(row.type) && row.calculatedAmount !== undefined && row.calculatedAmount !== 0) {
          const amountClass = row.calculatedAmount < 0 ? 'negative' : '';
          parts.push(`<span class="node-price ${amountClass}">åˆè¨ˆ:Â¥${row.calculatedAmount.toLocaleString()}</span>`);
        }

        return parts.join('');
      }

      // ãƒãƒ¼ãƒ‰HTMLç”Ÿæˆ (ãƒ¡ã‚¤ãƒ³)
      function renderNode(row, level) {
        const hasChildren = row.children && row.children.length > 0;

        const rowContent = `
          <div class="tree-row" onclick="toggleNode(this)">
            ${createToggleIcon(hasChildren)}
            ${createTypeBadge(row.type)}
            <span class="node-name">${escapeHtml(row.name)}</span>
            ${row.spec ? `<span class="node-spec">ï¼ˆ${escapeHtml(row.spec)}ï¼‰</span>` : ''}
            ${createAmountInfo(row)}
          </div>
        `;

        const childrenContent = hasChildren
          ? `<div class="tree-children">${row.children.map(child => renderNode(child, level + 1)).join('')}</div>`
          : '';

        return `<div class="tree-node level-${Math.min(level, 6)}">${rowContent}${childrenContent}</div>`;
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function toggleNode(el) {
        const node = el.closest(".tree-node");
        const toggle = el.querySelector(".tree-toggle");
        const children = node.querySelector(".tree-children");

        if (children) {
          const isHidden = children.style.display === "none";
          children.style.display = isHidden ? "block" : "none";
          toggle.textContent = isHidden ? "â–¼" : "â–¶";
        }
      }

      // ========================================
      // CSVãƒ‘ãƒ¼ã‚¹å‡¦ç† (SRPæº–æ‹ )
      // ========================================

      // å…¥åŠ›æ¤œè¨¼
      function validateCSVInput(input) {
        if (!input || !input.trim()) {
          throw new Error(UI_MESSAGES.EMPTY_INPUT);
        }
        return input.trim();
      }

      // CSVè¡Œã®ãƒ‘ãƒ¼ã‚¹
      function parseCSVRows(csvText) {
        const lines = csvText.split(/\r?\n/).filter(l => l.trim());
        const rows = [];

        for (const line of lines) {
          const cols = parseCSVLine(line);
          if (cols.length >= 10) {
            rows.push(createBCSRow(cols));
          }
        }

        if (rows.length === 0) {
          throw new Error(UI_MESSAGES.INVALID_CSV);
        }

        return rows;
      }

      // çµ±è¨ˆæƒ…å ±è¨ˆç®—
      function calculateStats(rows) {
        const typeCount = {};
        rows.forEach(r => {
          typeCount[r.type] = (typeCount[r.type] || 0) + 1;
        });
        return typeCount;
      }

      // çµ±è¨ˆæƒ…å ±ã®UIæ›´æ–°
      function updateStats(typeCount, totalRows) {
        const statsDiv = document.getElementById('stats');
        statsDiv.innerHTML = `
          <span>ğŸ“Š ${totalRows}è¡Œ</span>
          <span>P:${typeCount[BCS_ROW_TYPES.PARENT] || 0}</span>
          <span>D:${typeCount[BCS_ROW_TYPES.DETAIL] || 0}</span>
          <span>T:${typeCount[BCS_ROW_TYPES.TOTAL] || 0}</span>
        `;
      }

      // ç©ºçŠ¶æ…‹ã®UIè¡¨ç¤º
      function showEmptyState() {
        const container = document.getElementById('treeContainer');
        const statsDiv = document.getElementById('stats');
        container.innerHTML = '<div class="empty-state"><p>ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
        statsDiv.innerHTML = '';
      }

      // ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã®UIè¡¨ç¤º
      function showParseError(message) {
        const container = document.getElementById('treeContainer');
        const statsDiv = document.getElementById('stats');
        showError(`ã‚¨ãƒ©ãƒ¼: ${message}`);
        container.innerHTML = `<div class="empty-state"><p>${UI_MESSAGES.PARSE_FAILED}</p></div>`;
        statsDiv.innerHTML = '';
      }

      // ãƒ¡ã‚¤ãƒ³å‡¦ç† - CSVãƒ‘ãƒ¼ã‚¹ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
      function parseCSV() {
        const input = document.getElementById('csvInput').value;
        const container = document.getElementById('treeContainer');
        const errorDiv = document.getElementById('errorMsg');

        errorDiv.innerHTML = '';

        try {
          const validInput = validateCSVInput(input);
          const rows = parseCSVRows(validInput);
          const tree = buildTree(rows);

          const html = tree.map(node => renderNode(node, 0)).join('');
          container.innerHTML = html;

          const typeCount = calculateStats(rows);
          updateStats(typeCount, rows.length);
        } catch (e) {
          if (e.message === UI_MESSAGES.EMPTY_INPUT) {
            showEmptyState();
          } else {
            showParseError(e.message);
          }
        }
      }

      function clearAll() {
        document.getElementById("csvInput").value = "";
        document.getElementById("treeContainer").innerHTML =
          '<div class="empty-state"><p>ğŸ“„ CSVãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œãƒ„ãƒªãƒ¼è¡¨ç¤ºã€ã‚’ã‚¯ãƒªãƒƒã‚¯</p></div>';
        document.getElementById("errorMsg").innerHTML = "";
        document.getElementById("stats").innerHTML = "";
        document.getElementById("fileInfo").classList.remove("show");
        document.getElementById("fileInput").value = "";
      }

      function loadSample() {
        const sample = `1,,,,,,,,,,Aãƒ“ãƒ«æ–°ç¯‰å·¥äº‹,,,å¼,95847000,,,,
2,,,,,,,1,,P,å…±é€šä»®è¨­å·¥äº‹,,,å¼,6430000,,,,
2,,,,,,,2,1,D,ä»®è¨­å»ºç‰©,ç¾å ´äº‹å‹™æ‰€,1,å¼,200000,,,,
2,,,,,,,2,2,D,å·¥äº‹æ–½è¨­,ä»®å›²ã„,1,å¼,650000,,,,
2,,,,,,,2,3,D,å®‰å…¨æ–½è¨­,å®‰å…¨è¨­å‚™ä¸€å¼,1,å¼,380000,,,,
2,,,,,,,2,,T,å…±é€šä»®è¨­å·¥äº‹,,,,,,,,
3,,,,,,,1,,P,å»ºç¯‰å·¥äº‹,,,å¼,52592000,,,,
3,2,,,,,,2,,P,åœŸå·¥äº‹,,,å¼,4688000,,,,
3,2,,,,,,3,1,D,æ ¹åˆ‡,æ©Ÿæ¢°,206,m3,1100,,,,
3,2,,,,,,3,2,D,æ®‹åœŸå‡¦åˆ†,å ´å¤–æ¬å‡º,618,m3,3300,,,,
3,2,,,,,,3,3,D,åŸ‹æˆ»,è³¼å…¥åœŸ,412,m3,3850,,,,
3,2,,,,,,3,4,D,åºŠä»˜ã‘,è»¢åœ§,320,m2,450,,,,
3,2,,,,,,3,9,D,å€¤å¼•,èª¿æ•´,1,å¼,-200,,,,
3,2,,,,,,3,,T,åœŸå·¥äº‹,,,,,,,,
3,3,,,,,,2,,P,æ­å·¥äº‹,,,å¼,8450000,,,,
3,3,,,,,,3,1,D,PHCæ­,Ï†400 L=12m,24,æœ¬,185000,,,,
3,3,,,,,,3,2,D,æ­æ‰“æ©Ÿé‹æ¬,å¾€å¾©,1,å¼,380000,,,,
3,3,,,,,,3,,T,æ­å·¥äº‹,,,,,,,,
3,4,,,,,,2,,P,ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆå·¥äº‹,,,å¼,12840000,,,,
3,4,,,,,,3,1,D,æ™®é€šã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ,21-18-20,485,m3,18500,,,,
3,4,,,,,,3,2,D,å‹æ ,åˆæ¿,2840,m2,2800,,,,
3,4,,,,,,3,,T,ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆå·¥äº‹,,,,,,,,
3,,,,,,,2,,T,å»ºç¯‰å·¥äº‹,,,,,,,,
4,,,,,,,1,,P,é›»æ°—è¨­å‚™å·¥äº‹,,,å¼,6254000,,,,
4,2,,,,,,2,,P,å¹¹ç·šè¨­å‚™,,,å¼,1850000,,,,
4,2,,,,,,3,1,D,ã‚±ãƒ¼ãƒ–ãƒ«é…ç·š,CV38sq,450,m,2200,,,,
4,2,,,,,,3,,T,å¹¹ç·šè¨­å‚™,,,,,,,,
4,,,,,,,2,,T,é›»æ°—è¨­å‚™å·¥äº‹,,,,,,,,`;
        document.getElementById("csvInput").value = sample;
        parseCSV();
      }
    </script>
  </body>
</html>

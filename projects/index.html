<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>業者見積データベース</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --sidebar-width: 280px;
        --header-height: 56px;
      }
      body {
        background: #f8f9fa;
      }
      .icon {
        width: 16px;
        height: 16px;
        vertical-align: -2px;
      }
      .icon-sm {
        width: 14px;
        height: 14px;
      }
      .icon-lg {
        width: 20px;
        height: 20px;
      }
      .sidebar {
        width: var(--sidebar-width);
        height: calc(100vh - var(--header-height));
        overflow-y: auto;
      }
      .main-content {
        height: calc(100vh - var(--header-height));
        overflow-y: auto;
        flex: 1;
      }
      @media (max-width: 991.98px) {
        .main-content {
          height: auto;
          min-height: calc(100vh - var(--header-height));
        }
      }
      .tabular-nums {
        font-variant-numeric: tabular-nums;
      }
      .subcategory-btn {
        min-width: 130px;
        text-align: left;
      }
      .subcategory-btn.active {
        background-color: #e7f1ff !important;
        border-color: #0d6efd !important;
        color: #0a58ca !important;
      }
      .subcategory-btn .sub-label {
        font-size: 0.7rem;
        opacity: 0.7;
      }
      .subcategory-btn .sub-amount {
        font-size: 0.875rem;
        font-weight: 700;
      }
      .table-estimate thead th {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 5;
      }
      .table-estimate tbody td {
        vertical-align: middle;
        font-size: 0.875rem;
      }
      .col-net {
        background: rgba(25, 135, 84, 0.05);
      }
      .col-price {
        background: rgba(13, 110, 253, 0.05);
      }
      .summary-card {
        border-left: 4px solid #0d6efd;
      }
      .scroll-x {
        overflow-x: auto;
      }
      .form-label-sm {
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      .mobile-search-panel {
        background: #fff;
        border-bottom: 1px solid #dee2e6;
      }
      .no-results {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }
      .highlight {
        background-color: #fff3cd;
        padding: 0 2px;
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-dark bg-dark px-3"
      style="height: var(--header-height)"
    >
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <svg
          class="icon-lg"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <ellipse cx="12" cy="5" rx="9" ry="3" />
          <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
          <path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3" />
        </svg>
        <span class="fw-bold">業者見積データベース</span>
      </a>
    </nav>

    <div class="d-lg-none mobile-search-panel" id="mobileSearchPanel">
      <div class="container-fluid p-3">
        <div class="row g-2">
          <div class="col-12">
            <label class="form-label form-label-sm text-secondary"
              >案件名・キーワード</label
            >
            <input
              type="text"
              class="form-control form-control-sm search-keyword"
              placeholder="例: ○○ビル改修工事"
            />
          </div>
          <div class="col-6">
            <label class="form-label form-label-sm text-secondary"
              >建物用途</label
            >
            <select class="form-select form-select-sm search-type">
              <option value="">すべて</option>
              <option>事務所</option>
              <option>店舗</option>
              <option>共同住宅</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label form-label-sm text-secondary">構造</label>
            <div class="d-flex flex-wrap gap-2 mt-1">
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input search-structure"
                  type="checkbox"
                  value="RC"
                /><label class="form-check-label small">RC</label>
              </div>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input search-structure"
                  type="checkbox"
                  value="S"
                /><label class="form-check-label small">S</label>
              </div>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input search-structure"
                  type="checkbox"
                  value="SRC"
                /><label class="form-check-label small">SRC</label>
              </div>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label form-label-sm text-secondary"
              >延床面積 (㎡)</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control search-area-min"
                placeholder="最小"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control search-area-max"
                placeholder="最大"
              />
            </div>
          </div>
          <div class="col-12">
            <label class="form-label form-label-sm text-secondary"
              >見積期間</label
            >
            <div class="input-group input-group-sm">
              <input type="date" class="form-control search-date-from" />
              <span class="input-group-text">~</span>
              <input type="date" class="form-control search-date-to" />
            </div>
          </div>
          <div class="col-6">
            <label class="form-label form-label-sm text-secondary"
              >協力会社名</label
            >
            <input
              type="text"
              class="form-control form-control-sm search-company"
              placeholder="会社名"
            />
          </div>
          <div class="col-6">
            <label class="form-label form-label-sm text-secondary"
              >品目・仕様</label
            >
            <input
              type="text"
              class="form-control form-control-sm search-item"
              placeholder="品目名など"
            />
          </div>
          <div class="col-12 d-flex gap-2 mt-2">
            <button
              class="btn btn-secondary flex-grow-1"
              onclick="executeSearch()"
            >
              検索実行
            </button>
            <button class="btn btn-outline-secondary" onclick="clearSearch()">
              クリア
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex">
      <aside class="sidebar d-none d-lg-flex flex-column bg-white border-end">
        <div class="p-3 border-bottom">
          <h6
            class="mb-0 fw-bold text-secondary d-flex align-items-center gap-1"
          >
            <svg
              class="icon"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            検索条件
          </h6>
        </div>
        <div class="p-3 flex-grow-1">
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >案件名・キーワード</label
            >
            <input
              type="text"
              class="form-control form-control-sm search-keyword"
              placeholder="例: ○○ビル改修工事"
            />
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >建物用途</label
            >
            <select class="form-select form-select-sm search-type">
              <option value="">すべて</option>
              <option>事務所</option>
              <option>店舗</option>
              <option>共同住宅</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary">構造</label>
            <div class="d-flex flex-wrap gap-2">
              <div class="form-check">
                <input
                  class="form-check-input search-structure"
                  type="checkbox"
                  value="RC"
                /><label class="form-check-label small">RC</label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input search-structure"
                  type="checkbox"
                  value="S"
                /><label class="form-check-label small">S</label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input search-structure"
                  type="checkbox"
                  value="SRC"
                /><label class="form-check-label small">SRC</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >延床面積 (㎡)</label
            >
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control search-area-min"
                placeholder="最小"
              />
              <span class="input-group-text">~</span>
              <input
                type="number"
                class="form-control search-area-max"
                placeholder="最大"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >見積期間</label
            >
            <div class="input-group input-group-sm">
              <input type="date" class="form-control search-date-from" />
              <span class="input-group-text">~</span>
              <input type="date" class="form-control search-date-to" />
            </div>
          </div>
          <hr class="my-3" />
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >協力会社名</label
            >
            <input
              type="text"
              class="form-control form-control-sm search-company"
              placeholder="会社名"
            />
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm text-secondary"
              >品目・仕様</label
            >
            <input
              type="text"
              class="form-control form-control-sm search-item"
              placeholder="品目名など"
            />
          </div>
        </div>
        <div class="p-3 border-top bg-light">
          <div class="d-grid gap-2">
            <button class="btn btn-secondary" onclick="executeSearch()">
              検索実行
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              onclick="clearSearch()"
            >
              条件クリア
            </button>
          </div>
        </div>
      </aside>

      <main class="main-content p-3 p-lg-4">
        <div class="mb-4">
          <h4 class="fw-bold mb-1">案件検索結果</h4>
          <p class="text-muted mb-0 small">
            該当:
            <span class="text-primary fw-bold fs-5" id="resultCount">5</span> 件
          </p>
        </div>
        <div id="projectsContainer"></div>
      </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script>
      var iconChevronDown =
        '<svg class="icon-sm" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>';
      var iconChevronUp =
        '<svg class="icon-sm" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"/></svg>';
      var iconFilter =
        '<svg class="icon-sm" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>';
      var iconExpand =
        '<svg class="icon-sm" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>';
      var iconInbox =
        '<svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>';

      function fmt(n) {
        return n ? n.toLocaleString() : "0";
      }

      var catNames = {
        rebar: "鉄筋工事",
        earthwork: "土工事",
        painting: "塗装工事",
      };

      var projects = [
        {
          id: "p1",
          name: "港区芝浦 Aビル大規模改修工事",
          shortName: "港区芝浦 Aビル...",
          type: "事務所",
          typeColor: "primary",
          structure: "SRC造",
          structureKey: "SRC",
          area: 15200,
          areaDisplay: "15,200",
          periodStart: "2024-09-01",
          periodEnd: "2024-11-30",
          period: "2024/09/01 ~ 2024/11/30",
          totalEstimate: 125000000,
          totalNet: 98500000,
          data: {
            rebar: [
              {
                type: "major",
                category: "材料費",
                amount: 23085734,
                netAmount: 19500000,
              },
              {
                type: "major",
                category: "加工・組立費",
                amount: 19070547,
                netAmount: 15100000,
              },
              {
                type: "direct",
                category: "材料費",
                company: "株式会社 A社",
                item: "異形棒鋼 SD295A",
                spec: "D10",
                remark: "",
                qty: 57.457,
                unit: "t",
                price: 110000,
                amount: 6320270,
                netRate: 0.98,
                netPrice: 107800,
                netAmount: 6193865,
              },
              {
                type: "direct",
                category: "材料費",
                company: "株式会社 A社",
                item: "異形棒鋼 SD295A",
                spec: "D13",
                remark: "",
                qty: 41.183,
                unit: "t",
                price: 108000,
                amount: 4447764,
                netRate: 0.98,
                netPrice: 105840,
                netAmount: 4358809,
              },
              {
                type: "direct",
                category: "材料費",
                company: "株式会社 A社",
                item: "異形棒鋼 SD345",
                spec: "D16",
                remark: "",
                qty: 85.2,
                unit: "t",
                price: 115000,
                amount: 9798000,
                netRate: 0.98,
                netPrice: 112700,
                netAmount: 9602040,
              },
              {
                type: "direct",
                category: "材料費",
                company: "株式会社 B社",
                item: "高強度鉄筋 SD490",
                spec: "D25",
                remark: "",
                qty: 7.11,
                unit: "t",
                price: 270000,
                amount: 1919700,
                netRate: 0.98,
                netPrice: 264600,
                netAmount: 1881306,
              },
              {
                type: "indirect",
                category: "材料費",
                company: "株式会社 A社",
                item: "材料運搬費",
                spec: "",
                remark: "現場搬入",
                qty: 1,
                unit: "式",
                price: 580000,
                amount: 580000,
                netRate: 0.98,
                netPrice: 568400,
                netAmount: 568400,
              },
              {
                type: "direct",
                category: "加工・組立費",
                company: "株式会社 C社",
                item: "鉄筋加工費",
                spec: "",
                remark: "工場加工",
                qty: 226.111,
                unit: "t",
                price: 35000,
                amount: 7913885,
                netRate: 0.95,
                netPrice: 33250,
                netAmount: 7518190,
              },
              {
                type: "direct",
                category: "加工・組立費",
                company: "株式会社 C社",
                item: "鉄筋組立費",
                spec: "",
                remark: "現場組立",
                qty: 226.111,
                unit: "t",
                price: 42000,
                amount: 9496662,
                netRate: 0.95,
                netPrice: 39900,
                netAmount: 9021829,
              },
            ],
            earthwork: [
              {
                type: "major",
                category: "掘削工事",
                amount: 20000000,
                netAmount: 15500000,
              },
              {
                type: "major",
                category: "残土処分",
                amount: 8745000,
                netAmount: 7000000,
              },
              {
                type: "direct",
                category: "掘削工事",
                company: "株式会社 D社",
                item: "根切り工事",
                spec: "機械掘削",
                remark: "バックホウ",
                qty: 2500,
                unit: "㎥",
                price: 3500,
                amount: 8750000,
                netRate: 0.92,
                netPrice: 3220,
                netAmount: 8050000,
              },
              {
                type: "direct",
                category: "掘削工事",
                company: "株式会社 E社",
                item: "山留め工事",
                spec: "H鋼横矢板",
                remark: "",
                qty: 380,
                unit: "m",
                price: 25000,
                amount: 9500000,
                netRate: 0.92,
                netPrice: 23000,
                netAmount: 8740000,
              },
              {
                type: "direct",
                category: "残土処分",
                company: "株式会社 F社",
                item: "残土運搬",
                spec: "10tダンプ",
                remark: "",
                qty: 3200,
                unit: "㎥",
                price: 1800,
                amount: 5760000,
                netRate: 0.95,
                netPrice: 1710,
                netAmount: 5472000,
              },
            ],
            painting: [
              {
                type: "major",
                category: "外部塗装",
                amount: 12540000,
                netAmount: 9500000,
              },
              {
                type: "major",
                category: "内部塗装",
                amount: 8935000,
                netAmount: 7000000,
              },
              {
                type: "direct",
                category: "外部塗装",
                company: "株式会社 G社",
                item: "外壁塗装",
                spec: "シリコン樹脂塗料",
                remark: "2回塗り",
                qty: 3500,
                unit: "㎡",
                price: 2800,
                amount: 9800000,
                netRate: 0.93,
                netPrice: 2604,
                netAmount: 9114000,
              },
              {
                type: "direct",
                category: "内部塗装",
                company: "株式会社 H社",
                item: "壁面塗装",
                spec: "EP塗料",
                remark: "",
                qty: 4200,
                unit: "㎡",
                price: 1500,
                amount: 6300000,
                netRate: 0.94,
                netPrice: 1410,
                netAmount: 5922000,
              },
            ],
          },
        },
        {
          id: "p2",
          name: "新宿駅前 商業施設新築工事",
          shortName: "新宿駅前 商業施設...",
          type: "店舗",
          typeColor: "success",
          structure: "S造",
          structureKey: "S",
          area: 4500,
          areaDisplay: "4,500",
          periodStart: "2024-10-15",
          periodEnd: "2025-03-31",
          period: "2024/10/15 ~ 2025/03/31",
          totalEstimate: 450000000,
          totalNet: 398000000,
          data: {
            rebar: [
              {
                type: "major",
                category: "材料費",
                amount: 16943400,
                netAmount: 13700000,
              },
              {
                type: "major",
                category: "加工・組立費",
                amount: 15225500,
                netAmount: 11800000,
              },
              {
                type: "direct",
                category: "材料費",
                company: "株式会社 I社",
                item: "異形棒鋼 SD295A",
                spec: "D10",
                remark: "",
                qty: 45.2,
                unit: "t",
                price: 112000,
                amount: 5062400,
                netRate: 0.95,
                netPrice: 106400,
                netAmount: 4809280,
              },
              {
                type: "direct",
                category: "加工・組立費",
                company: "株式会社 J社",
                item: "鉄筋加工費",
                spec: "",
                remark: "工場加工",
                qty: 180.5,
                unit: "t",
                price: 36000,
                amount: 6498000,
                netRate: 0.92,
                netPrice: 33120,
                netAmount: 5978160,
              },
            ],
            earthwork: [
              {
                type: "major",
                category: "掘削工事",
                amount: 35410000,
                netAmount: 28000000,
              },
              {
                type: "major",
                category: "残土処分",
                amount: 16610000,
                netAmount: 13000000,
              },
              {
                type: "direct",
                category: "掘削工事",
                company: "株式会社 K社",
                item: "根切り工事",
                spec: "機械掘削",
                remark: "バックホウ0.7㎥",
                qty: 4500,
                unit: "㎥",
                price: 3200,
                amount: 14400000,
                netRate: 0.94,
                netPrice: 3008,
                netAmount: 13536000,
              },
              {
                type: "direct",
                category: "残土処分",
                company: "株式会社 M社",
                item: "残土運搬",
                spec: "10tダンプ",
                remark: "",
                qty: 5800,
                unit: "㎥",
                price: 1900,
                amount: 11020000,
                netRate: 0.93,
                netPrice: 1767,
                netAmount: 10248600,
              },
            ],
            painting: [
              {
                type: "major",
                category: "外部塗装",
                amount: 21734000,
                netAmount: 16800000,
              },
              {
                type: "major",
                category: "内部塗装",
                amount: 18145000,
                netAmount: 14500000,
              },
              {
                type: "direct",
                category: "外部塗装",
                company: "株式会社 O社",
                item: "外壁塗装",
                spec: "フッ素樹脂塗料",
                remark: "2回塗り",
                qty: 5200,
                unit: "㎡",
                price: 3500,
                amount: 18200000,
                netRate: 0.93,
                netPrice: 3255,
                netAmount: 16926000,
              },
              {
                type: "direct",
                category: "内部塗装",
                company: "株式会社 P社",
                item: "壁面塗装",
                spec: "EP-G塗料",
                remark: "",
                qty: 8500,
                unit: "㎡",
                price: 1600,
                amount: 13600000,
                netRate: 0.935,
                netPrice: 1496,
                netAmount: 12716000,
              },
            ],
          },
        },
        {
          id: "p3",
          name: "渋谷区恵比寿 マンション新築工事",
          shortName: "渋谷区恵比寿 マンション...",
          type: "共同住宅",
          typeColor: "warning",
          structure: "RC造",
          structureKey: "RC",
          area: 8200,
          areaDisplay: "8,200",
          periodStart: "2025-01-10",
          periodEnd: "2025-06-30",
          period: "2025/01/10 ~ 2025/06/30",
          totalEstimate: 280000000,
          totalNet: 245000000,
          data: {
            rebar: [
              {
                type: "major",
                category: "材料費",
                amount: 32000000,
                netAmount: 28500000,
              },
              {
                type: "major",
                category: "加工・組立費",
                amount: 24000000,
                netAmount: 21000000,
              },
              {
                type: "direct",
                category: "材料費",
                company: "株式会社 Q社",
                item: "異形棒鋼 SD345",
                spec: "D19",
                remark: "",
                qty: 120.5,
                unit: "t",
                price: 118000,
                amount: 14219000,
                netRate: 0.96,
                netPrice: 113280,
                netAmount: 13650240,
              },
              {
                type: "direct",
                category: "加工・組立費",
                company: "株式会社 R社",
                item: "鉄筋加工費",
                spec: "",
                remark: "工場加工",
                qty: 205.8,
                unit: "t",
                price: 38000,
                amount: 7820400,
                netRate: 0.94,
                netPrice: 35720,
                netAmount: 7351176,
              },
            ],
            earthwork: [
              {
                type: "major",
                category: "掘削工事",
                amount: 18500000,
                netAmount: 16200000,
              },
              {
                type: "major",
                category: "残土処分",
                amount: 9800000,
                netAmount: 8500000,
              },
              {
                type: "direct",
                category: "掘削工事",
                company: "株式会社 S社",
                item: "根切り工事",
                spec: "機械掘削",
                remark: "バックホウ",
                qty: 3200,
                unit: "㎥",
                price: 3300,
                amount: 10560000,
                netRate: 0.93,
                netPrice: 3069,
                netAmount: 9820800,
              },
              {
                type: "direct",
                category: "残土処分",
                company: "株式会社 U社",
                item: "残土運搬処分",
                spec: "一般残土",
                remark: "",
                qty: 4100,
                unit: "㎥",
                price: 2200,
                amount: 9020000,
                netRate: 0.92,
                netPrice: 2024,
                netAmount: 8298400,
              },
            ],
            painting: [
              {
                type: "major",
                category: "外部塗装",
                amount: 15800000,
                netAmount: 13500000,
              },
              {
                type: "major",
                category: "内部塗装",
                amount: 22400000,
                netAmount: 19200000,
              },
              {
                type: "direct",
                category: "外部塗装",
                company: "株式会社 V社",
                item: "外壁塗装",
                spec: "シリコン樹脂塗料",
                remark: "3回塗り",
                qty: 4800,
                unit: "㎡",
                price: 3000,
                amount: 14400000,
                netRate: 0.92,
                netPrice: 2760,
                netAmount: 13248000,
              },
              {
                type: "direct",
                category: "内部塗装",
                company: "株式会社 W社",
                item: "室内壁塗装",
                spec: "EP塗料",
                remark: "各住戸",
                qty: 12000,
                unit: "㎡",
                price: 1400,
                amount: 16800000,
                netRate: 0.925,
                netPrice: 1295,
                netAmount: 15540000,
              },
            ],
          },
        },
        {
          id: "p4",
          name: "品川区大井 オフィスビル改修工事",
          shortName: "品川区大井 オフィス...",
          type: "事務所",
          typeColor: "primary",
          structure: "S造",
          structureKey: "S",
          area: 6800,
          areaDisplay: "6,800",
          periodStart: "2025-04-01",
          periodEnd: "2025-08-31",
          period: "2025/04/01 ~ 2025/08/31",
          totalEstimate: 95000000,
          totalNet: 82000000,
          data: {
            rebar: [
              {
                type: "major",
                category: "材料費",
                amount: 8500000,
                netAmount: 7200000,
              },
              {
                type: "major",
                category: "加工・組立費",
                amount: 6200000,
                netAmount: 5400000,
              },
              {
                type: "direct",
                category: "材料費",
                company: "株式会社 X社",
                item: "異形棒鋼 SD295A",
                spec: "D10",
                remark: "補強用",
                qty: 28.5,
                unit: "t",
                price: 108000,
                amount: 3078000,
                netRate: 0.95,
                netPrice: 102600,
                netAmount: 2924100,
              },
              {
                type: "direct",
                category: "加工・組立費",
                company: "株式会社 Y社",
                item: "鉄筋加工組立",
                spec: "",
                remark: "一式",
                qty: 63.7,
                unit: "t",
                price: 85000,
                amount: 5414500,
                netRate: 0.92,
                netPrice: 78200,
                netAmount: 4981340,
              },
            ],
            earthwork: [
              {
                type: "major",
                category: "掘削工事",
                amount: 5200000,
                netAmount: 4500000,
              },
              {
                type: "direct",
                category: "掘削工事",
                company: "株式会社 Z社",
                item: "部分掘削",
                spec: "基礎補強用",
                remark: "",
                qty: 800,
                unit: "㎥",
                price: 4500,
                amount: 3600000,
                netRate: 0.92,
                netPrice: 4140,
                netAmount: 3312000,
              },
            ],
            painting: [
              {
                type: "major",
                category: "外部塗装",
                amount: 18500000,
                netAmount: 16000000,
              },
              {
                type: "major",
                category: "内部塗装",
                amount: 12800000,
                netAmount: 11000000,
              },
              {
                type: "direct",
                category: "外部塗装",
                company: "株式会社 AA社",
                item: "外壁塗装",
                spec: "ウレタン樹脂塗料",
                remark: "2回塗り",
                qty: 5500,
                unit: "㎡",
                price: 2800,
                amount: 15400000,
                netRate: 0.92,
                netPrice: 2576,
                netAmount: 14168000,
              },
              {
                type: "direct",
                category: "内部塗装",
                company: "株式会社 BB社",
                item: "オフィス壁塗装",
                spec: "EP塗料",
                remark: "",
                qty: 8500,
                unit: "㎡",
                price: 1350,
                amount: 11475000,
                netRate: 0.93,
                netPrice: 1256,
                netAmount: 10671750,
              },
            ],
          },
        },
        {
          id: "p5",
          name: "目黒区中目黒 複合商業施設新築工事",
          shortName: "目黒区中目黒 複合商業...",
          type: "店舗",
          typeColor: "success",
          structure: "SRC造",
          structureKey: "SRC",
          area: 22500,
          areaDisplay: "22,500",
          periodStart: "2025-07-01",
          periodEnd: "2025-12-31",
          period: "2025/07/01 ~ 2025/12/31",
          totalEstimate: 680000000,
          totalNet: 595000000,
          data: {
            rebar: [
              {
                type: "major",
                category: "材料費",
                amount: 58000000,
                netAmount: 51000000,
              },
              {
                type: "major",
                category: "加工・組立費",
                amount: 42000000,
                netAmount: 37000000,
              },
              {
                type: "direct",
                category: "材料費",
                company: "株式会社 CC社",
                item: "異形棒鋼 SD345",
                spec: "D22",
                remark: "",
                qty: 180.5,
                unit: "t",
                price: 122000,
                amount: 22021000,
                netRate: 0.955,
                netPrice: 116510,
                netAmount: 21030055,
              },
              {
                type: "direct",
                category: "材料費",
                company: "株式会社 DD社",
                item: "高強度鉄筋 SD490",
                spec: "D29",
                remark: "柱用",
                qty: 62.3,
                unit: "t",
                price: 285000,
                amount: 17755500,
                netRate: 0.95,
                netPrice: 270750,
                netAmount: 16867725,
              },
              {
                type: "direct",
                category: "加工・組立費",
                company: "株式会社 EE社",
                item: "鉄筋加工費",
                spec: "",
                remark: "工場加工",
                qty: 388.6,
                unit: "t",
                price: 42000,
                amount: 16321200,
                netRate: 0.94,
                netPrice: 39480,
                netAmount: 15341928,
              },
            ],
            earthwork: [
              {
                type: "major",
                category: "掘削工事",
                amount: 65000000,
                netAmount: 57000000,
              },
              {
                type: "major",
                category: "残土処分",
                amount: 28000000,
                netAmount: 24500000,
              },
              {
                type: "direct",
                category: "掘削工事",
                company: "株式会社 FF社",
                item: "根切り工事",
                spec: "大型機械",
                remark: "バックホウ1.0㎥",
                qty: 12000,
                unit: "㎥",
                price: 3800,
                amount: 45600000,
                netRate: 0.935,
                netPrice: 3553,
                netAmount: 42636000,
              },
              {
                type: "direct",
                category: "残土処分",
                company: "株式会社 HH社",
                item: "残土運搬処分",
                spec: "10tダンプ",
                remark: "",
                qty: 15000,
                unit: "㎥",
                price: 1850,
                amount: 27750000,
                netRate: 0.93,
                netPrice: 1721,
                netAmount: 25807500,
              },
            ],
            painting: [
              {
                type: "major",
                category: "外部塗装",
                amount: 42000000,
                netAmount: 36500000,
              },
              {
                type: "major",
                category: "内部塗装",
                amount: 38000000,
                netAmount: 33000000,
              },
              {
                type: "direct",
                category: "外部塗装",
                company: "株式会社 JJ社",
                item: "外壁塗装",
                spec: "フッ素樹脂塗料",
                remark: "高耐候",
                qty: 9500,
                unit: "㎡",
                price: 3800,
                amount: 36100000,
                netRate: 0.925,
                netPrice: 3515,
                netAmount: 33392500,
              },
              {
                type: "direct",
                category: "内部塗装",
                company: "株式会社 KK社",
                item: "店舗内装塗装",
                spec: "EP-G塗料",
                remark: "",
                qty: 18000,
                unit: "㎡",
                price: 1650,
                amount: 29700000,
                netRate: 0.93,
                netPrice: 1535,
                netAmount: 27621000,
              },
            ],
          },
        },
      ];

      var state = {};
      var filteredProjects = projects.slice();
      var currentSearchTerms = { company: "", item: "" };

      function getSearchValues() {
        var keyword = document.querySelector(".sidebar .search-keyword");
        keyword = keyword ? keyword.value : "";
        if (!keyword) {
          var mobileKeyword = document.querySelector(
            ".mobile-search-panel .search-keyword"
          );
          keyword = mobileKeyword ? mobileKeyword.value : "";
        }

        var typeEl = document.querySelector(".sidebar .search-type");
        var type = typeEl ? typeEl.value : "";
        if (!type) {
          var mobileType = document.querySelector(
            ".mobile-search-panel .search-type"
          );
          type = mobileType ? mobileType.value : "";
        }

        var structureEls = document.querySelectorAll(
          ".search-structure:checked"
        );
        var structures = [];
        for (var i = 0; i < structureEls.length; i++) {
          structures.push(structureEls[i].value);
        }

        var areaMinEl = document.querySelector(".sidebar .search-area-min");
        var areaMin =
          areaMinEl && areaMinEl.value ? parseFloat(areaMinEl.value) : null;
        if (areaMin === null) {
          var mobileAreaMin = document.querySelector(
            ".mobile-search-panel .search-area-min"
          );
          areaMin =
            mobileAreaMin && mobileAreaMin.value
              ? parseFloat(mobileAreaMin.value)
              : null;
        }

        var areaMaxEl = document.querySelector(".sidebar .search-area-max");
        var areaMax =
          areaMaxEl && areaMaxEl.value ? parseFloat(areaMaxEl.value) : null;
        if (areaMax === null) {
          var mobileAreaMax = document.querySelector(
            ".mobile-search-panel .search-area-max"
          );
          areaMax =
            mobileAreaMax && mobileAreaMax.value
              ? parseFloat(mobileAreaMax.value)
              : null;
        }

        var dateFromEl = document.querySelector(".sidebar .search-date-from");
        var dateFrom = dateFromEl ? dateFromEl.value : "";
        if (!dateFrom) {
          var mobileDateFrom = document.querySelector(
            ".mobile-search-panel .search-date-from"
          );
          dateFrom = mobileDateFrom ? mobileDateFrom.value : "";
        }

        var dateToEl = document.querySelector(".sidebar .search-date-to");
        var dateTo = dateToEl ? dateToEl.value : "";
        if (!dateTo) {
          var mobileDateTo = document.querySelector(
            ".mobile-search-panel .search-date-to"
          );
          dateTo = mobileDateTo ? mobileDateTo.value : "";
        }

        var companyEl = document.querySelector(".sidebar .search-company");
        var company = companyEl ? companyEl.value : "";
        if (!company) {
          var mobileCompany = document.querySelector(
            ".mobile-search-panel .search-company"
          );
          company = mobileCompany ? mobileCompany.value : "";
        }

        var itemEl = document.querySelector(".sidebar .search-item");
        var item = itemEl ? itemEl.value : "";
        if (!item) {
          var mobileItem = document.querySelector(
            ".mobile-search-panel .search-item"
          );
          item = mobileItem ? mobileItem.value : "";
        }

        return {
          keyword: keyword,
          type: type,
          structures: structures,
          areaMin: areaMin,
          areaMax: areaMax,
          dateFrom: dateFrom,
          dateTo: dateTo,
          company: company,
          item: item,
        };
      }

      function executeSearch() {
        var s = getSearchValues();
        currentSearchTerms = {
          company: s.company.toLowerCase(),
          item: s.item.toLowerCase(),
        };

        filteredProjects = projects.filter(function (p) {
          if (
            s.keyword &&
            p.name.toLowerCase().indexOf(s.keyword.toLowerCase()) === -1
          ) {
            return false;
          }
          if (s.type && p.type !== s.type) {
            return false;
          }
          if (
            s.structures.length > 0 &&
            s.structures.indexOf(p.structureKey) === -1
          ) {
            return false;
          }
          if (s.areaMin !== null && p.area < s.areaMin) {
            return false;
          }
          if (s.areaMax !== null && p.area > s.areaMax) {
            return false;
          }
          if (s.dateFrom && p.periodEnd < s.dateFrom) {
            return false;
          }
          if (s.dateTo && p.periodStart > s.dateTo) {
            return false;
          }
          if (s.company) {
            var companyFound = false;
            var cats = ["rebar", "earthwork", "painting"];
            for (var i = 0; i < cats.length; i++) {
              var catData = p.data[cats[i]];
              for (var j = 0; j < catData.length; j++) {
                if (
                  catData[j].company &&
                  catData[j].company
                    .toLowerCase()
                    .indexOf(s.company.toLowerCase()) !== -1
                ) {
                  companyFound = true;
                  break;
                }
              }
              if (companyFound) break;
            }
            if (!companyFound) return false;
          }
          if (s.item) {
            var itemFound = false;
            var cats2 = ["rebar", "earthwork", "painting"];
            for (var i = 0; i < cats2.length; i++) {
              var catData2 = p.data[cats2[i]];
              for (var j = 0; j < catData2.length; j++) {
                var r = catData2[j];
                if (
                  (r.item &&
                    r.item.toLowerCase().indexOf(s.item.toLowerCase()) !==
                      -1) ||
                  (r.spec &&
                    r.spec.toLowerCase().indexOf(s.item.toLowerCase()) !== -1)
                ) {
                  itemFound = true;
                  break;
                }
              }
              if (itemFound) break;
            }
            if (!itemFound) return false;
          }
          return true;
        });

        document.getElementById("resultCount").textContent =
          filteredProjects.length;
        renderProjects();
      }

      function clearSearch() {
        var inputs = document.querySelectorAll(
          ".search-keyword, .search-company, .search-item, .search-area-min, .search-area-max, .search-date-from, .search-date-to"
        );
        for (var i = 0; i < inputs.length; i++) {
          inputs[i].value = "";
        }
        var selects = document.querySelectorAll(".search-type");
        for (var i = 0; i < selects.length; i++) {
          selects[i].value = "";
        }
        var checkboxes = document.querySelectorAll(".search-structure");
        for (var i = 0; i < checkboxes.length; i++) {
          checkboxes[i].checked = false;
        }
        currentSearchTerms = { company: "", item: "" };
        filteredProjects = projects.slice();
        document.getElementById("resultCount").textContent =
          filteredProjects.length;
        renderProjects();
      }

      function syncSearchInputs() {
        var fields = [
          "search-keyword",
          "search-type",
          "search-company",
          "search-item",
          "search-area-min",
          "search-area-max",
          "search-date-from",
          "search-date-to",
        ];
        fields.forEach(function (cls) {
          var els = document.querySelectorAll("." + cls);
          if (els.length > 1) {
            for (var i = 0; i < els.length; i++) {
              els[i].addEventListener("input", function (e) {
                var val = e.target.value;
                for (var j = 0; j < els.length; j++) {
                  if (els[j] !== e.target) {
                    els[j].value = val;
                  }
                }
              });
            }
          }
        });
        var checkboxes = document.querySelectorAll(".search-structure");
        for (var i = 0; i < checkboxes.length; i++) {
          checkboxes[i].addEventListener("change", function (e) {
            var val = e.target.value;
            var checked = e.target.checked;
            var others = document.querySelectorAll(
              '.search-structure[value="' + val + '"]'
            );
            for (var j = 0; j < others.length; j++) {
              others[j].checked = checked;
            }
          });
        }
      }

      function initProject(p) {
        state[p.id] = { cat: "rebar", sub: "" };
      }

      function renderProjects() {
        var container = document.getElementById("projectsContainer");
        if (filteredProjects.length === 0) {
          container.innerHTML =
            '<div class="no-results"><svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><p class="mt-3 mb-1 fw-bold">検索結果がありません</p><p class="small">検索条件を変更してお試しください</p></div>';
          return;
        }
        var html = "";
        for (var i = 0; i < filteredProjects.length; i++) {
          var p = filteredProjects[i];
          initProject(p);
          html += '<div class="card shadow-sm mb-4" id="card-' + p.id + '">';
          html += '<div class="card-header bg-white py-3">';
          html +=
            '<div class="d-flex justify-content-between align-items-start flex-wrap gap-2">';
          html += "<div>";
          html +=
            '<div class="d-flex align-items-center gap-2 mb-2 flex-wrap">';
          html +=
            '<span class="badge text-bg-' +
            p.typeColor +
            '">' +
            p.type +
            "</span>";
          html +=
            '<span class="badge text-bg-secondary">' + p.structure + "</span>";
          html +=
            '<small class="text-muted d-flex align-items-center gap-1">' +
            iconExpand +
            " " +
            p.areaDisplay +
            "㎡</small>";
          html += "</div>";
          html += '<h5 class="fw-bold mb-1 fs-6">' + p.name + "</h5>";
          html +=
            '<small class="text-muted">見積期間: ' + p.period + "</small>";
          html += "</div>";
          html +=
            '<button class="btn btn-link text-decoration-none p-0" onclick="toggleDetails(\'' +
            p.id +
            "')\">";
          html +=
            '<span id="toggle-text-' +
            p.id +
            '" class="d-none d-sm-inline">見積詳細を開く</span>';
          html += '<span class="d-sm-none">詳細</span>';
          html +=
            '<span id="toggle-icon-' +
            p.id +
            '">' +
            iconChevronDown +
            "</span>";
          html += "</button>";
          html += "</div>";
          html +=
            '<div class="row g-3 mt-2"><div class="col-12"><div class="card summary-card"><div class="card-body py-2">';
          html += '<small class="text-muted fw-bold">案件の全体総計</small>';
          html += '<div class="d-flex gap-3 gap-md-4 mt-1 flex-wrap">';
          html +=
            '<div><small class="text-muted d-block">見積総計金額</small><span class="fw-bold tabular-nums">¥' +
            fmt(p.totalEstimate) +
            "</span></div>";
          html +=
            '<div><small class="text-primary fw-bold d-block">NET総計金額</small><span class="fw-bold text-primary fs-5 tabular-nums">¥' +
            fmt(p.totalNet) +
            "</span></div>";
          html += "</div></div></div></div></div></div>";
          html += '<div class="collapse" id="details-' + p.id + '">';
          html +=
            '<nav class="px-3 py-2 border-bottom bg-light"><ol class="breadcrumb mb-0 small flex-nowrap overflow-auto">';
          html +=
            '<li class="breadcrumb-item text-muted text-nowrap">' +
            p.shortName +
            "</li>";
          html +=
            '<li class="breadcrumb-item text-muted text-nowrap" id="bc-cat-' +
            p.id +
            '">鉄筋工事</li>';
          html +=
            '<li class="breadcrumb-item active text-nowrap" id="bc-sub-' +
            p.id +
            '">-</li>';
          html += "</ol></nav>";
          html +=
            '<div class="bg-white border-bottom"><ul class="nav nav-tabs px-3 flex-nowrap overflow-auto" id="categoryTabs-' +
            p.id +
            '" role="tablist">';
          html +=
            '<li class="nav-item" role="presentation"><button class="nav-link active text-nowrap" type="button" role="tab" data-cat="rebar" onclick="switchCategory(\'' +
            p.id +
            "','rebar',this)\">鉄筋工事</button></li>";
          html +=
            '<li class="nav-item" role="presentation"><button class="nav-link text-nowrap" type="button" role="tab" data-cat="earthwork" onclick="switchCategory(\'' +
            p.id +
            "','earthwork',this)\">土工事</button></li>";
          html +=
            '<li class="nav-item" role="presentation"><button class="nav-link text-nowrap" type="button" role="tab" data-cat="painting" onclick="switchCategory(\'' +
            p.id +
            "','painting',this)\">塗装工事</button></li>";
          html += "</ul></div>";
          html += '<div class="bg-light border-bottom px-3 py-3">';
          html +=
            '<small class="text-muted fw-bold d-flex align-items-center gap-1 mb-2">' +
            iconFilter +
            " 大分類を選択</small>";
          html +=
            '<div class="d-flex gap-2 scroll-x pb-1" id="subcategoryContainer-' +
            p.id +
            '"></div>';
          html += "</div>";
          html +=
            '<div class="px-3 py-3 d-none" id="selectionCard-' +
            p.id +
            '"><div class="card"><div class="card-body py-2">';
          html +=
            '<small class="text-muted fw-bold">選択工種の内訳: <span class="text-dark" id="selectionName-' +
            p.id +
            '"></span></small>';
          html += '<div class="row g-2 mt-1">';
          html +=
            '<div class="col-6 col-md-2"><small class="text-muted d-block">見積金額</small><span class="fw-bold tabular-nums small" id="selectionEstimate-' +
            p.id +
            '">-</span></div>';
          html +=
            '<div class="col-6 col-md-2"><small class="text-primary fw-bold d-block">NET金額</small><span class="fw-bold text-primary tabular-nums small" id="selectionNet-' +
            p.id +
            '">-</span></div>';
          html +=
            '<div class="col-6 col-md-2"><small class="text-success fw-bold d-block">NET率</small><span class="fw-bold text-success tabular-nums small" id="selectionNetRate-' +
            p.id +
            '">-</span></div>';
          html +=
            '<div class="col-6 col-md-2"><small class="text-muted d-block">直接費</small><span class="tabular-nums small" id="selectionDirect-' +
            p.id +
            '">-</span></div>';
          html +=
            '<div class="col-6 col-md-2"><small class="text-muted d-block">間接費</small><span class="tabular-nums small" id="selectionIndirect-' +
            p.id +
            '">-</span></div>';
          html +=
            '<div class="col-6 col-md-2"><small class="text-muted d-block">法定福利費</small><span class="tabular-nums small" id="selectionLegal-' +
            p.id +
            '">-</span></div>';
          html += "</div></div></div></div>";
          html +=
            '<div class="p-3"><div class="table-responsive border rounded" style="max-height:400px;overflow:auto">';
          html +=
            '<table class="table table-estimate table-hover table-striped mb-0"><thead class="table-light"><tr>';
          html += '<th class="text-center" style="width:70px">種別</th>';
          html += '<th style="min-width:140px">協力会社名</th>';
          html += '<th style="min-width:180px">品目</th>';
          html += '<th style="min-width:120px">仕様</th>';
          html += '<th style="min-width:100px">備考</th>';
          html += '<th class="text-end" style="width:80px">数量</th>';
          html += '<th class="text-center" style="width:50px">単位</th>';
          html +=
            '<th class="text-end col-price" style="width:100px">単価</th>';
          html +=
            '<th class="text-end col-price" style="width:120px">金額</th>';
          html += '<th class="text-end col-net" style="width:70px">NET率</th>';
          html +=
            '<th class="text-end col-net" style="width:100px">NET単価</th>';
          html +=
            '<th class="text-end col-net" style="width:120px">NET金額</th>';
          html +=
            '</tr></thead><tbody id="detailTbody-' +
            p.id +
            '"></tbody></table>';
          html +=
            '<div id="noDataMsg-' +
            p.id +
            '" class="text-center text-muted py-5 d-none">' +
            iconInbox +
            '<div class="mt-2">データがありません</div></div>';
          html += "</div></div></div></div>";
        }
        container.innerHTML = html;
        for (var i = 0; i < filteredProjects.length; i++) {
          buildSubcategories(filteredProjects[i].id);
        }
      }

      function toggleDetails(pid) {
        var el = document.getElementById("details-" + pid);
        var text = document.getElementById("toggle-text-" + pid);
        var icon = document.getElementById("toggle-icon-" + pid);
        if (el.classList.contains("show")) {
          el.classList.remove("show");
          text.textContent = "見積詳細を開く";
          icon.innerHTML = iconChevronDown;
        } else {
          el.classList.add("show");
          text.textContent = "見積詳細を閉じる";
          icon.innerHTML = iconChevronUp;
        }
      }

      function switchCategory(pid, cat, btn) {
        state[pid].cat = cat;
        var tabs = document.querySelectorAll(
          "#categoryTabs-" + pid + " .nav-link"
        );
        for (var i = 0; i < tabs.length; i++) {
          tabs[i].classList.remove("active");
        }
        btn.classList.add("active");
        document.getElementById("bc-cat-" + pid).textContent = catNames[cat];
        buildSubcategories(pid);
      }

      function buildSubcategories(pid) {
        var p = null;
        for (var i = 0; i < filteredProjects.length; i++) {
          if (filteredProjects[i].id === pid) {
            p = filteredProjects[i];
            break;
          }
        }
        if (!p) return;

        var c = document.getElementById("subcategoryContainer-" + pid);
        var catData = p.data[state[pid].cat];
        var majors = [];
        for (var i = 0; i < catData.length; i++) {
          if (catData[i].type === "major") {
            majors.push(catData[i]);
          }
        }

        c.innerHTML = "";

        var allData = [];
        for (var i = 0; i < catData.length; i++) {
          if (catData[i].type !== "major") {
            allData.push(catData[i]);
          }
        }
        var allNetSum = 0;
        for (var i = 0; i < allData.length; i++) {
          allNetSum += allData[i].netAmount || 0;
        }

        var allBtn = document.createElement("button");
        allBtn.className = "btn btn-outline-secondary subcategory-btn active";
        allBtn.innerHTML =
          '<span class="sub-label d-block">すべて</span><span class="sub-amount tabular-nums">¥' +
          fmt(allNetSum) +
          "</span>";
        allBtn.onclick = function () {
          var btns = c.querySelectorAll(".subcategory-btn");
          for (var i = 0; i < btns.length; i++) {
            btns[i].classList.remove("active");
          }
          allBtn.classList.add("active");
          selectSub(pid, "all", null);
        };
        c.appendChild(allBtn);

        for (var i = 0; i < majors.length; i++) {
          (function (m) {
            var btn = document.createElement("button");
            btn.className = "btn btn-outline-secondary subcategory-btn";
            btn.innerHTML =
              '<span class="sub-label d-block">' +
              m.category +
              '</span><span class="sub-amount tabular-nums">¥' +
              fmt(m.netAmount) +
              "</span>";
            btn.onclick = function () {
              var btns = c.querySelectorAll(".subcategory-btn");
              for (var j = 0; j < btns.length; j++) {
                btns[j].classList.remove("active");
              }
              btn.classList.add("active");
              selectSub(pid, m.category, m);
            };
            c.appendChild(btn);
          })(majors[i]);
        }

        state[pid].sub = "all";
        selectSub(pid, "all", null);
      }

      function selectSub(pid, sub, m) {
        state[pid].sub = sub;
        var p = null;
        for (var i = 0; i < filteredProjects.length; i++) {
          if (filteredProjects[i].id === pid) {
            p = filteredProjects[i];
            break;
          }
        }
        if (!p) return;

        var isAll = sub === "all";
        document.getElementById("bc-sub-" + pid).textContent = isAll
          ? "すべて"
          : sub;
        document
          .getElementById("selectionCard-" + pid)
          .classList.remove("d-none");
        document.getElementById("selectionName-" + pid).textContent = isAll
          ? "すべて"
          : sub;

        var catData = p.data[state[pid].cat];
        var details = [];
        for (var i = 0; i < catData.length; i++) {
          if (catData[i].type !== "major") {
            if (isAll || catData[i].category === sub) {
              details.push(catData[i]);
            }
          }
        }

        var directSum = 0,
          indirectSum = 0,
          legalSum = 0,
          totalAmount = 0;
        for (var i = 0; i < details.length; i++) {
          var r = details[i];
          totalAmount += r.amount || 0;
          if (r.type === "direct") directSum += r.netAmount || 0;
          else if (r.type === "indirect") indirectSum += r.netAmount || 0;
          else if (r.type === "legal") legalSum += r.netAmount || 0;
        }
        var totalNet = directSum + indirectSum + legalSum;

        document.getElementById("selectionEstimate-" + pid).textContent = isAll
          ? "¥" + fmt(totalAmount)
          : m
          ? "¥" + fmt(m.amount)
          : "-";
        document.getElementById("selectionNet-" + pid).textContent = isAll
          ? "¥" + fmt(totalNet)
          : m
          ? "¥" + fmt(m.netAmount)
          : "-";

        var netRate =
          totalAmount > 0 ? (totalNet / totalAmount).toFixed(3) : "-";
        document.getElementById("selectionNetRate-" + pid).textContent =
          netRate;
        document.getElementById("selectionDirect-" + pid).textContent =
          "¥" + fmt(directSum);
        document.getElementById("selectionIndirect-" + pid).textContent =
          "¥" + fmt(indirectSum);
        document.getElementById("selectionLegal-" + pid).textContent =
          "¥" + fmt(legalSum);
        renderTable(pid);
      }

      function highlightText(text, searchTerm) {
        if (!searchTerm || !text) return text;
        var lowerText = text.toLowerCase();
        var lowerTerm = searchTerm.toLowerCase();
        var idx = lowerText.indexOf(lowerTerm);
        if (idx === -1) return text;
        var before = text.substring(0, idx);
        var match = text.substring(idx, idx + searchTerm.length);
        var after = text.substring(idx + searchTerm.length);
        return before + '<mark class="highlight">' + match + "</mark>" + after;
      }

      function renderTable(pid) {
        var p = null;
        for (var i = 0; i < filteredProjects.length; i++) {
          if (filteredProjects[i].id === pid) {
            p = filteredProjects[i];
            break;
          }
        }
        if (!p) return;

        var tb = document.getElementById("detailTbody-" + pid);
        var msg = document.getElementById("noDataMsg-" + pid);
        var isAll = state[pid].sub === "all";

        var catData = p.data[state[pid].cat];
        var data = [];
        for (var i = 0; i < catData.length; i++) {
          if (catData[i].type !== "major") {
            if (isAll || catData[i].category === state[pid].sub) {
              data.push(catData[i]);
            }
          }
        }

        if (currentSearchTerms.company || currentSearchTerms.item) {
          var filtered = [];
          for (var i = 0; i < data.length; i++) {
            var r = data[i];
            var companyMatch =
              !currentSearchTerms.company ||
              (r.company &&
                r.company.toLowerCase().indexOf(currentSearchTerms.company) !==
                  -1);
            var itemMatch =
              !currentSearchTerms.item ||
              (r.item &&
                r.item.toLowerCase().indexOf(currentSearchTerms.item) !== -1) ||
              (r.spec &&
                r.spec.toLowerCase().indexOf(currentSearchTerms.item) !== -1);
            if (companyMatch && itemMatch) {
              filtered.push(r);
            }
          }
          data = filtered;
        }

        tb.innerHTML = "";
        if (data.length === 0) {
          msg.classList.remove("d-none");
          return;
        }
        msg.classList.add("d-none");

        var html = "";
        for (var i = 0; i < data.length; i++) {
          var r = data[i];
          var badge =
            r.type === "direct"
              ? "primary"
              : r.type === "indirect"
              ? "warning"
              : "danger";
          var label =
            r.type === "direct"
              ? "直接費"
              : r.type === "indirect"
              ? "間接費"
              : "法定費";
          var companyDisplay = highlightText(
            r.company || "-",
            currentSearchTerms.company
          );
          var itemDisplay = highlightText(
            r.item || "",
            currentSearchTerms.item
          );
          var specDisplay = highlightText(
            r.spec || "",
            currentSearchTerms.item
          );

          html += "<tr>";
          html +=
            '<td class="text-center"><span class="badge text-bg-' +
            badge +
            '">' +
            label +
            "</span></td>";
          html += "<td>" + companyDisplay + "</td>";
          html += '<td class="fw-medium">' + itemDisplay + "</td>";
          html += "<td>" + specDisplay + "</td>";
          html += '<td class="text-muted small">' + (r.remark || "") + "</td>";
          html += '<td class="text-end tabular-nums">' + fmt(r.qty) + "</td>";
          html +=
            '<td class="text-center small text-muted">' + r.unit + "</td>";
          html +=
            '<td class="text-end tabular-nums col-price text-muted">' +
            fmt(r.price) +
            "</td>";
          html +=
            '<td class="text-end tabular-nums col-price text-muted">' +
            fmt(r.amount) +
            "</td>";
          html +=
            '<td class="text-end tabular-nums col-net fw-bold">' +
            r.netRate.toFixed(3) +
            "</td>";
          html +=
            '<td class="text-end tabular-nums col-net fw-bold">' +
            fmt(r.netPrice) +
            "</td>";
          html +=
            '<td class="text-end tabular-nums col-net fw-bold">' +
            fmt(r.netAmount) +
            "</td>";
          html += "</tr>";
        }
        tb.innerHTML = html;
      }

      function setupEnterKeySearch() {
        var inputs = document.querySelectorAll(
          ".search-keyword, .search-company, .search-item, .search-area-min, .search-area-max, .search-date-from, .search-date-to"
        );
        for (var i = 0; i < inputs.length; i++) {
          inputs[i].addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              executeSearch();
            }
          });
        }
      }

      syncSearchInputs();
      setupEnterKeySearch();
      renderProjects();
    </script>
  </body>
</html>
